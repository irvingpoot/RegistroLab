---
/**
 * @component SystemUpdates.astro
 * @description Diseño "Neural Timeline" - Corrección de color Fuchsia.
 */
import { currentVersion, isMajorUpdate, updateDate, changes } from "../data/changelog";

// Configuración explicita de colores (Agregamos 'dot' para evitar que Tailwind los borre)
const types: Record<string, { color: string, label: string, dot: string }> = {
    feature: { 
        color: "text-blue-400 border-blue-500/30 bg-blue-500/10 shadow-[0_0_15px_-3px_rgba(59,130,246,0.3)]", 
        label: "NUEVO",
        dot: "bg-blue-400" // <--- Declarado explícitamente
    },
    fix: { 
        color: "text-emerald-400 border-emerald-500/30 bg-emerald-500/10 shadow-[0_0_15px_-3px_rgba(16,185,129,0.3)]", 
        label: "FIX",
        dot: "bg-emerald-400"
    },
    style: { 
        color: "text-fuchsia-400 border-fuchsia-500/30 bg-fuchsia-500/10 shadow-[0_0_15px_-3px_rgba(192,38,211,0.3)]", 
        label: "ESTILO",
        dot: "bg-fuchsia-400"
    }
};
---

<div class="fixed bottom-4 right-4 inline-block z-40">
    <button id="btn-updates-trigger" class="
        group relative flex items-center gap-3 pl-3 pr-4 py-1.5 rounded-xl
        bg-[#0f172a]/80 backdrop-blur-md border border-white/10
        hover:border-blue-500/40 hover:bg-[#1e293b]
        transition-all duration-300 shadow-lg
    ">
        <div class="relative flex items-center justify-center w-7 h-7 rounded-lg bg-blue-500/20 text-blue-400 group-hover:text-white group-hover:bg-blue-500 transition-colors">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v8"/><path d="m4.93 10.93 1.41 1.41"/><path d="M2 18h2"/><path d="M20 18h2"/><path d="m19.07 10.93-1.41 1.41"/><path d="M22 22H2"/><path d="m8 22 4-10 4 10"/></svg>
            <span id="update-badge" class="hidden absolute -top-1 -right-1 flex h-2.5 w-2.5">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500 border border-[#0f172a]"></span>
            </span>
        </div>
        <div class="flex flex-col items-start">
            <span class="text-[10px] uppercase tracking-wider text-slate-400 font-bold">Versión</span>
            <span class="text-xs font-mono text-slate-200 group-hover:text-blue-300 transition-colors">{currentVersion}</span>
        </div>
    </button>
</div>

<dialog id="modal-updates" class="bg-transparent p-0 backdrop:bg-[#000]/70 backdrop:backdrop-blur-sm z-[100] open:animate-in">
    <div class="fixed inset-0 z-[100] flex items-center justify-center p-4">
        
        <div id="modal-panel-updates" class="
            relative w-full max-w-lg overflow-hidden
            bg-[#050505] rounded-[24px] border border-[#1e293b]
            shadow-[0_0_60px_-15px_rgba(59,130,246,0.15)]
            transform scale-95 opacity-0 transition-all duration-500 cubic-bezier(0.2, 0.8, 0.2, 1)
        ">
            <div class="absolute top-0 left-0 w-full h-[180px] bg-gradient-to-b from-[#0f172a] to-[#050505] z-0"></div>
            <div class="absolute -top-20 -left-20 w-64 h-64 bg-blue-600/20 blur-[80px] rounded-full animate-pulse-slow z-0 pointer-events-none"></div>
            <div class="absolute -top-20 -right-20 w-64 h-64 bg-violet-600/10 blur-[80px] rounded-full animate-pulse-slow delay-1000 z-0 pointer-events-none"></div>

            <div class="relative z-10">
                <div class="px-8 pt-8 pb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h2 class="text-2xl font-bold text-white">Novedades</h2>
                            <p class="text-sm text-slate-400 flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                                Todo funciona correctamente
                            </p>
                        </div>
                        <button id="btn-close-modal" class="p-2 rounded-full text-slate-500 hover:text-white hover:bg-white/5 transition-colors cursor-pointer">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>

                    <div class="mt-3 flex items-center justify-between p-4 rounded-xl bg-gradient-to-r from-blue-500/10 to-transparent border border-blue-500/20">
                        <div>
                            <span class="text-xs font-bold text-blue-400 uppercase tracking-widest">Versión</span>
                            <div class="text-lg font-mono font-bold text-white mt-0.5">{currentVersion}</div>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-slate-500 font-medium">Lanzamiento</span>
                            <div class="text-sm text-slate-300">{updateDate}</div>
                        </div>
                    </div>
                </div>

                <div class="px-8 pb-8">
                    <div class="relative border-l border-slate-800 ml-3 space-y-8 py-4">
                        
                        {changes.map((change, index) => {
                            const style = types[change.type] || types.fix;
                            return (
                                <div class="relative pl-8 group" style={`animation-delay: ${index * 100}ms`}>
                                    
                                    <div class={`absolute -left-[5px] top-1.5 h-2.5 w-2.5 rounded-full border-2 border-[#050505] ${style.dot}`}></div>
                                    
                                    <div class="flex flex-col gap-2">
                                        <div class="flex items-center gap-3">
                                            <span class={`px-2 py-0.5 text-[10px] font-bold rounded-md border backdrop-blur-sm uppercase tracking-wider ${style.color}`}>
                                                {style.label}
                                            </span>
                                            <h3 class="text-slate-200 font-medium text-sm">{change.title}</h3>
                                        </div>
                                        <p class="text-slate-400 text-xs leading-relaxed max-w-sm">
                                            {change.description}
                                        </p>
                                    </div>
                                </div>
                            );
                        })}

                    </div>
                    
                    <button id="btn-dismiss-update" class="mt-4 w-full py-3 rounded-xl bg-white text-black font-bold text-sm hover:bg-slate-200 transition-colors shadow-[0_0_20px_-5px_rgba(255,255,255,0.3)]">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>
</dialog>

<script define:vars={{ currentVersion, isMajorUpdate }}>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('modal-updates');
        const panel = document.getElementById('modal-panel-updates');
        const badge = document.getElementById('update-badge');
        const btnTrigger = document.getElementById('btn-updates-trigger');
        const btnClose = document.getElementById('btn-close-modal');
        const btnDismiss = document.getElementById('btn-dismiss-update');

        const storedVersion = localStorage.getItem('app_version_seen');
        const hasNewVersion = storedVersion !== currentVersion;

        const openModal = () => {
            modal.showModal();
            requestAnimationFrame(() => {
                panel.classList.remove('scale-95', 'opacity-0');
                panel.classList.add('scale-100', 'opacity-100');
            });
        };

        const closeModal = () => {
            panel.classList.remove('scale-100', 'opacity-100');
            panel.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.close();
                badge.classList.add('hidden');
                localStorage.setItem('app_version_seen', currentVersion);
            }, 200);
        };

        if (hasNewVersion) {
            if (isMajorUpdate) setTimeout(openModal, 1000);
            else badge.classList.remove('hidden');
        }

        btnTrigger.addEventListener('click', () => {
            openModal();
            badge.classList.add('hidden');
            localStorage.setItem('app_version_seen', currentVersion);
        });

        [btnClose, btnDismiss].forEach(btn => btn?.addEventListener('click', closeModal));
        modal.addEventListener('click', e => e.target === modal && closeModal());
    });
</script>

<style>
    dialog[open] { animation: fade-in 50ms forwards; }
    @keyframes fade-in { from { background: transparent; } to { background: rgba(0,0,0,0.7); } }
    @keyframes pulse-slow { 0%, 100% { opacity: 0.5; transform: scale(1); } 50% { opacity: 0.8; transform: scale(1.1); } }
    .animate-pulse-slow { animation: pulse-slow 4s infinite ease-in-out; }
</style>