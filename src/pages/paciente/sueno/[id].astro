---

/**
 * @file [id].astro
 * @description Vista detallada (Expediente Digital) de un paciente específico.
 * * CONCEPTO "EXPEDIENTE CENTRAL":
 * - Agrega toda la información dispersa: Datos personales, Historial Clínico,
 * Citas, Seguimientos y Resultados de Cuestionarios.
 * * CARACTERÍSTICAS TÉCNICAS:
 * 1. Acciones Múltiples (Switch): Maneja varias acciones POST en un solo endpoint
 * ('add_seguimiento', 'delete_cita', etc.) identificadas por el campo `action`.
 * 2. Sistema de Tokens: Genera y visualiza el enlace público único (`token_cuestionarios`)
 * para que el paciente responda evaluaciones sin iniciar sesión.
 * * SEGURIDAD:
 * - Valida que el ID exista y protege las acciones de borrado y edición.
 */

import Layout from "../../../layouts/Layout.astro"
import ReturnButton from "../../../components/ReturnButton.astro"
import InfoCard from "../../../components/InfoCard.astro"
import { createClient } from "@supabase/supabase-js"
import { calcularpsqi } from "../../../utils/calculos"

const { id } = Astro.params;
const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

if (!id) return Astro.redirect("/lista");

const user = await Astro.locals.currentUser();
const nombreAutor = user 
    ? `${user.firstName} ${user.lastName}`.trim() || user.username 
    : "Sistema";

let mensaje = "";
const msgParam = Astro.url.searchParams.get('mensaje');

if (msgParam === 'tms_guardado') mensaje = "Sesión de TMS registrada correctamente.";
if (msgParam === 'puntajes_actualizados') mensaje = "Los puntajes se han actualizado.";
if (msgParam === 'seguimiento_guardado') mensaje = "Seguimiento registrado exitosamente.";
if (msgParam === 'nota_guardada') mensaje = "Nota clínica guardada.";
if (msgParam === 'error') mensaje = "Ocurrió un error al procesar la solicitud.";

const notifId = Astro.url.searchParams.get('marcar_leido');

if (notifId) {
    await supabase
        .from('respuestas_cuestionarios')
        .update({ visto: true })
        .eq('paciente_id', id) 
        .eq('visto', false);
}

// LÓGICA DE ACCIONES
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const action = formData.get("action");

        if (action === "add_seguimiento") {
            const nuevaNota = {
                paciente_id: id,
                fecha: formData.get("fecha") ? new Date(formData.get("fecha") as string).toISOString() : new Date().toISOString(),
                observacion: formData.get("observacion"),
                registrado_por: nombreAutor
            };
            const { error } = await supabase.from('pacientes_seguimiento').insert([nuevaNota]);
            if (!error) {
                return Astro.redirect(Astro.url.pathname + "?mensaje=seguimiento_guardado");
            } else {
                mensaje = "Error al guardar";
            }
        }

        if (action === "edit_seguimiento") {
            const idNota = formData.get("id_seguimiento");
            const actualizacion = {
                fecha: formData.get("fecha") ? new Date(formData.get("fecha") as string).toISOString() : new Date().toISOString(),
                observacion: formData.get("observacion")
            };
            const { error } = await supabase.from('pacientes_seguimiento').update(actualizacion).eq('id', idNota);
            if (error) throw error;
        }

        if (action === "delete_seguimiento") {
            const idNota = formData.get("id_seguimiento");
            const { error } = await supabase.from('pacientes_seguimiento').delete().eq('id', idNota);
            if (error) throw error;
        }

        if (action === "delete_patient") {
            const { error: deleteError } = await supabase
                .from('pacientes')
                .delete()
                .eq('id', id);

            if (deleteError) throw deleteError;

            return Astro.redirect("/lista?mensaje=eliminado");
        }

        if (action === "update_scores") {
            const getInt = (key: string) => {
                const val = formData.get(key);
                return val && val.toString().trim() !== '' ? parseInt(val as string) : null;
            };

            const scoresList = ['epworth', 'dbi', 'hamilton_d', 'hamilton_a', 'isi', 'psqi', 'stop_bang', 'berlin', 'cuestionario_insomnio'];
            let puntajesActualizados: any = {};
            
            scoresList.forEach(score => {
                puntajesActualizados[`${score}_pre`] = getInt(`${score}_pre`);
                puntajesActualizados[`${score}_inter`] = getInt(`${score}_inter`);
                puntajesActualizados[`${score}_post`] = getInt(`${score}_post`);
            });

            const { error: updateError } = await supabase.from('pacientes').update(puntajesActualizados).eq('id', id);
            if (updateError) throw updateError;

            await supabase.from('pacientes_puntajes_extra').delete().eq('paciente_id', id);
            
            const extraNombres = formData.getAll('extra_prueba_nombre');
            const extraPre = formData.getAll('extra_prueba_pre');
            const extraInter = formData.getAll('extra_prueba_inter');
            const extraPost = formData.getAll('extra_prueba_post');
            
            const extrasAInsertar = extraNombres.map((nombre, index) => ({
                paciente_id: id,
                nombre_prueba: nombre.toString(),
                puntaje_pre: extraPre[index] ? parseInt(extraPre[index].toString()) : null,
                puntaje_inter: extraInter[index] ? parseInt(extraInter[index].toString()) : null,
                puntaje_post: extraPost[index] ? parseInt(extraPost[index].toString()) : null
            })).filter(item => item.nombre_prueba.trim() !== '');

            if (extrasAInsertar.length > 0) {
                await supabase.from('pacientes_puntajes_extra').insert(extrasAInsertar);
                return Astro.redirect(`${Astro.url.pathname}?mensaje=puntajes_actualizados`);
            }
        }

        if (action === "update_psqi_study") {
            const fase = formData.get("fase") as string;
            const horas = parseFloat(formData.get("horas") as string);

            const { data: resp, error: findError } = await supabase
                .from('respuestas_cuestionarios')
                .select('*')
                .eq('paciente_id', id)
                .eq('cuestionario', 'psqi')
                .eq('fase', fase)
                .single();

            if (findError || !resp) {
                throw new Error("El paciente aún no ha contestado el cuestionario para esta fase.");
            }

            const datos = resp.datos;
            datos.horas_sueno_estudio = horas; 
            
            const resultado = calcularpsqi(datos);
            
            datos.puntaje = resultado.puntaje;
            Object.assign(datos, resultado.extraData);

            const { error: updateJsonError } = await supabase
                .from('respuestas_cuestionarios')
                .update({ datos: datos })
                .eq('id', resp.id);

            if (updateJsonError) throw updateJsonError;

            const columnaScore = `psqi_${fase}`;
            const { error: updateScoreError } = await supabase
                .from('pacientes')
                .update({ [columnaScore]: resultado.puntaje })
                .eq('id', id);

            if (updateScoreError) throw updateScoreError;
        }

        if (action === "habilitar_tms") {
            const { error } = await supabase
                .from('pacientes')
                .update({ tms_habilitado: true })
                .eq('id', id);
            if (error) console.error("Error habilitando TMS:", error);
        }

        if (action === "nueva_sesion_tms") {
            const getInt = (k: string) => {
                const v = formData.get(k);
                return v && v.toString().trim() ? parseInt(v.toString()) : null;
            };
            const getStr = (k: string) => {
                const v = formData.get(k);
                return v ? v.toString().trim() : null;
            };

            const sitio = getStr("sitio_estimulacion");
            
            let freqMain = null;
            let freqRight = null;

            if (sitio === "Bilateral") {
                freqMain = getStr("frecuencia_izq");
                freqRight = getStr("frecuencia_der");
            } else {
                freqMain = getStr("frecuencia");
            }

            const { error } = await supabase.from('tms_sesiones').insert({
                paciente_id: id,
                fecha_aplicacion: formData.get("fecha"),
                observaciones: formData.get("observaciones"),
                
                umbral_motor: getInt("umbral_motor"),
                intensidad_tratamiento: getInt("intensidad_tratamiento"),
                total_pulsos: getInt("total_pulsos"),
                sitio_estimulacion: sitio,
                protocolo: getStr("protocolo"),

                frecuencia: freqMain,
                frecuencia_derecha: freqRight
            });
            
            if (error) {
                console.error("Error creando sesión:", error);
            } else {
                return Astro.redirect(`${Astro.url.pathname}?mensaje=tms_guardado`);
            }
        }

        if (action === "subir_consentimiento_tms") {
            const archivo = formData.get("archivo_pdf");

            if (archivo && archivo instanceof File && archivo.size > 0) {
                
                // Ruta del archivo
                const filePath = `${id}/consentimiento_tms.pdf`;

                // 1. Subir a Supabase (Bucket PRIVADO)
                const { error: uploadError } = await supabase.storage
                    .from('expedientes')
                    .upload(filePath, archivo, {
                        upsert: true,
                        contentType: 'application/pdf'
                    });

                if (uploadError) {
                    console.error("Error subiendo archivo:", uploadError);
                } else {
                    const { error: dbError } = await supabase
                        .from('pacientes')
                        .update({ tms_consentimiento_url: filePath })
                        .eq('id', id);
                        
                    if (dbError) console.error("Error guardando ruta en DB:", dbError);
                }
            }
        }

        if (action === "registrar_reporte") {
            const getNum = (k: string) => { 
                const v = formData.get(k) as string;
                return v && v.toString().trim() !== '' ? parseFloat(v) : null; 
            };
            
            // Construir strings de tiempo
            const durReg = `${formData.get("dur_reg_h") || 0}h ${formData.get("dur_reg_m") || 0}m`;
            const durEval = `${formData.get("dur_eval_h") || 0}h ${formData.get("dur_eval_m") || 0}m`;

            const reporteData = {
                paciente_id: id, // El ID que viene de la URL
                duracion_registro: durReg,
                duracion_evaluacion: durEval,
                iah: getNum("iah"),
                indice_apneas: getNum("indice_apneas"),
                indice_hipopnea: getNum("indice_hipopnea"),
                iai: getNum("iai"),
                iao: getNum("iao"),
                iac: getNum("iac"),
                iam: getNum("iam"),
                saturacion_promedio: getNum("saturacion_promedio"),
                pulso_promedio: getNum("pulso_promedio"),
                ronquidos: getNum("ronquidos"),
                sat_90_min: getNum("sat_90_min"),
                sat_90_porc: getNum("sat_90_porc")
            };

            // Estrategia: Borrar anterior e insertar nuevo (para evitar duplicados simples)
            await supabase.from('pacientes_reportes_sueno').delete().eq('paciente_id', id);
            const { error } = await supabase.from('pacientes_reportes_sueno').insert(reporteData);

            if (error) console.error("Error guardando reporte:", error);
            else return Astro.redirect(`${Astro.url.pathname}?mensaje=reporte_guardado`);
        }

    } catch (error) {
        console.error("Error en acción:", error);
    }
}

// --- 2. CONSULTA DE DATOS ---
const { data: paciente, error } = await supabase
    .from('pacientes')
    .select('*, pacientes_sintomas(*), pacientes_puntajes_extra(*), pacientes_seguimiento(*), respuestas_cuestionarios(*), tms_sesiones(*), pacientes_reportes_sueno(*)')
    .eq('id', id)
    .order('fecha_aplicacion', { referencedTable: 'tms_sesiones', ascending: false })
    .single();

if (error || !paciente) {
    return Astro.redirect("/lista");
}

if (paciente.pacientes_seguimiento) {
    paciente.pacientes_seguimiento.sort((a: any, b: any) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());
}

let urlConsentimientoFirmado = null;

if (paciente?.tms_consentimiento_url) {
    const { data: signedData } = await supabase.storage
        .from('expedientes')
        .createSignedUrl(paciente.tms_consentimiento_url, 3600);
        
    urlConsentimientoFirmado = signedData?.signedUrl;
}

const baseUrl = Astro.url.origin;
const token = paciente.token_cuestionarios;

const linkPsqi = `${baseUrl}/cuestionarios/psqi/${token}?fase=pre`;
const linkBerlin = `${baseUrl}/cuestionarios/berlin/${token}?fase=pre`;
const linkEpworth = `${baseUrl}/cuestionarios/epworth/${token}?fase=pre`;

const mensajeWhatsApp = `Buen día. Soy ${nombreAutor}, del laboratorio del sueño y neurociencias de la UADY. Estos son los formularios para complementar el estudio de Apnea. Si tiene oportunidad de contestarlo con alguien más, por si hay algún dato que desconoce y alguien más pueda ayudarlo a responder.

Aquí le dejo los links:

Indice de calidad de sueño de pitsburgh:
${linkPsqi}

Cuestionario Berlin:
${linkBerlin}

Escala Epworth de somnolencia:
${linkEpworth}`;

const reporteResultados = paciente?.pacientes_reportes_sueno?.[0] || null;

// Helper para extraer "7" y "30" de "7h 30m"
const extraerTiempo = (texto: string | null) => {
    if (!texto) return { h: '', m: '' };
    const match = texto.match(/(\d+)h\s*(\d+)m/);
    if (match) return { h: match[1], m: match[2] };
    return { h: '', m: '' };
};

const regTiempo = extraerTiempo(reporteResultados?.duracion_registro);
const evalTiempo = extraerTiempo(reporteResultados?.duracion_evaluacion);

const formatDate = (dateString: string) => {
    if (!dateString) return "No registrado";
    const fechaLimpia = dateString.substring(0, 10);
    
    return new Date(fechaLimpia + 'T12:00:00').toLocaleDateString('es-MX', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
};

const formatDateShort = (dateString: string) => {
    if (!dateString) return "";
    const fechaLimpia = dateString.substring(0, 10);
    return new Date(fechaLimpia + 'T12:00:00').toLocaleDateString('es-MX', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric' 
    });
};

const formatTime = (timeString: string) => {
    if (!timeString) return "—";
    const [hours, minutes] = timeString.split(':');
    return `${hours}:${minutes}`;
};
const edadDisplay = paciente.edad || (paciente.fecha_nacimiento ? new Date().getFullYear() - new Date(paciente.fecha_nacimiento).getFullYear() : "N/A");

const sesionesTMS = paciente?.tms_sesiones || [];
const ultimaConfig = sesionesTMS.length > 0 ? sesionesTMS[0] : {};
---

<Layout title={`Expediente: ${paciente.nombre}`}>
    <ReturnButton href="/lista" text="Volver a la lista" />

    <main class="max-w-6xl mx-auto pt-20 pb-28 px-4">
        
        <div class="border-b-2 border-white/10 pb-6 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                
                <p class="text-blue-400 text-sm font-bold uppercase tracking-widest mb-2">Expediente Transtorno de sueño</p>
                <h1 class="text-4xl md:text-5xl font-extrabold capitalize text-white">{paciente.nombre}</h1>
                <div class="flex gap-4 mt-2 text-gray-400 text-sm items-center">
                    <span>ID: #{paciente.id}</span>
                    <span>•</span>
                    <span>Registrado: {formatDate(paciente.created_at)}</span>
                    <span>•</span>
                    <a href={`/editar-paciente/sueno/${paciente.id}`} class="text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                        Editar Expediente Completo
                    </a>
                </div>
            </div>
            <div class="text-right">
                <span class="block text-gray-500 text-xs uppercase tracking-wider mb-1">Registrado por</span>
                <span class="bg-gray-800 px-3 py-1 rounded-full text-sm text-gray-300 border border-gray-700">
                    {paciente.registrado_por || "Sistema"}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-8">
            <div class="relative w-full max-w-6xl mx-auto">
                <div id="nav-sentinel" class="absolute -top-12 left-0 w-full h-px pointer-events-none opacity-0"></div>
            </div>
            <nav id="dynamic-nav" class="sticky top-6 z-50 mb-12 flex items-center justify-between gap-1 overflow-hidden
                transition-all duration-500 cubic-bezier(0.25, 0.8, 0.25, 1) mx-auto
                
                w-full max-w-6xl rounded-2xl bg-gray-900/0 border border-transparent p-0 backdrop-blur-none shadow-none
                
                data-[state='floating']:max-w-[650px]
                data-[state='floating']:bg-[#0f172a]/80 
                data-[state='floating']:backdrop-blur-xl 
                data-[state='floating']:border-white/10 
                data-[state='floating']:rounded-full 
                data-[state='floating']:p-1.5
                data-[state='floating']:shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)]">
                
                <div class="w-full flex items-center gap-1 overflow-x-auto no-scrollbar scroll-smooth">
                    <a href="#datos" class="nav-link active">Sociodemograficos</a>
                    <a href="#clinica" class="nav-link">Historia</a>
                    <a href="#sintomas" class="nav-link">Síntomas</a>
                    <a href="#habitos" class="nav-link">Hábitos</a>
                    <a href="#alteraciones" class="nav-link">Alteraciones</a>
                    <a href="#puntajes" class="nav-link">Puntajes</a>
                    <a href="#reporte-resultados" class="nav-link">Resultados</a>
                    <a href="#tms" class="nav-link">TMS</a>
                    <a href="#evaluacion" class="nav-link">Evaluaciones</a>
                    <a href="#seguimiento" class="nav-link">Seguimiento</a>
                </div>
            </nav>

            <section id="datos" class="scroll-mt-32">
                <InfoCard title="SocioDemográficos">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><span class="label">Fecha de Nacimiento</span><p class="value">{formatDate(paciente.fecha_nacimiento)} <span class="text-gray-500 text-sm">({edadDisplay} años)</span></p></div>
                        <div>
                            <span class="label">Teléfono</span>
                            {paciente.telefono ? (
                                <a
                                    href={`https://wa.me/52${paciente.telefono.replace(/\D/g, '')}`}
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="value font-mono text-blue-300 hover:text-green-400 hover:underline flex items-center gap-2 w-fit transition-colors group"
                                    title="Enviar mensaje de WhatsApp"
                                >
                                    {/* Icono WhatsApp */}
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp transition-transform group-hover:scale-110" viewBox="0 0 16 16">
                                        <path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/>
                                    </svg>
                                    {paciente.telefono}
                                </a>
                            ) : (
                                <p class="value font-mono text-gray-500">—</p>
                            )}
                        </div>
                        <div><span class="label">Género</span><p class="value capitalize">{paciente.genero}</p></div>
                        <div><span class="label">Ocupación</span><p class="value">{paciente.ocupacion || "—"}</p></div>
                        <div><span class="label">Escolaridad</span><p class="value">{paciente.escolaridad || "—"}</p></div>
                        <div><span class="label">Referido por</span><p class="value">{paciente.referencia}</p></div>
                    </div>
                </InfoCard>
            </section>

            <section id="clinica" class="scroll-mt-32">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <InfoCard title="Antropométricos">
                        <div class="grid grid-cols-2 gap-6">
                            <div><span class="label">Peso</span><p class="value">{paciente.peso ? `${paciente.peso} kg` : "—"}</p></div>
                            <div><span class="label">Altura</span><p class="value">{paciente.altura ? `${paciente.altura} m` : "—"}</p></div>
                            <div><span class="label">Lateralidad</span><p class="value capitalize">{paciente.lateralidad || "—"}</p></div>
                            <div><span class="label">IMC</span><p class="value text-blue-300">{paciente.peso && paciente.altura ? (paciente.peso / (paciente.altura * paciente.altura)).toFixed(1) : "—"}</p></div>
                        </div>
                    </InfoCard>
    
                    <InfoCard title="Consumo de Sustancias">
                        <ul class="space-y-3">
                            <li class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-400">Tabaco</span><span class="text-white font-medium">{paciente.fuma === 'si' ? `${paciente.cigarros_semana} / semana` : 'No'}</span></li>
                            <li class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-400">Alcohol</span><span class="text-white font-medium">{paciente.alcohol === 'si' ? `${paciente.cervezas_semana} / semana` : 'No'}</span></li>
                            <li class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-400">Café</span><span class="text-white font-medium">{paciente.cafe === 'si' ? `${paciente.tazas_cafe_semana} tazas/sem` : 'No'}</span></li>
                            <li class="flex justify-between pb-1"><span class="text-gray-400">Té</span><span class="text-white font-medium">{paciente.te === 'si' ? `${paciente.tazas_te_semana} tazas/sem` : 'No'}</span></li>
                        </ul>
                    </InfoCard>
    
                    <InfoCard title="Motivo de Consulta">
                        <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50">
                            <p class="text-gray-200 text-lg leading-relaxed whitespace-pre-wrap">
                                {paciente.motivo}
                            </p>
                        </div>
                    </InfoCard>
    
                    <InfoCard title="Diagnósticos Previos">
                        <span class="label mb-2 block">Antecedentes Familiares y Personales</span>
                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700/50 min-h-[100px]"><p class="text-gray-300 italic leading-relaxed text-sm">{paciente.antecedentes || 'No se han registrado antecedentes.'}</p></div>
                    </InfoCard>
    
                </div>
            </section>

            <section id="sintomas" class="scroll-mt-32">
                <InfoCard title="Análisis de Síntomas">
                    {paciente.pacientes_sintomas && paciente.pacientes_sintomas.length > 0 ? (
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {paciente.pacientes_sintomas.map((s: any, index: number) => (
                                <div class="bg-gray-800/40 border border-gray-700 p-4 rounded-xl relative group hover:border-blue-500/50 transition-colors">
                                    <div class="absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">#{index + 1}</div>
                                    <h4 class="text-lg font-bold text-white mb-2 capitalize">{s.sintoma}</h4>
                                    <div class="space-y-1 text-sm">
                                        <p><span class="text-gray-500">Temporalidad:</span> <span class="text-gray-300">{s.temporalidad}</span></p>
                                        <p><span class="text-gray-500">Frecuencia:</span> <span class="text-gray-300">{s.frecuencia}</span></p>
                                        <p><span class="text-gray-500">Gravedad:</span> <span class="text-gray-300">{s.gravedad}</span></p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    ) : (
                        <div class="text-gray-500 italic">No hay síntomas registrados.</div>
                    )}
                </InfoCard>
            </section>

            <section id="habitos" class="scroll-mt-32">
                <InfoCard title="Hábitos y Patrones de Sueño">
        
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8 border-b border-gray-700/50 pb-8">
                        
                        <div class="bg-gray-800/30 p-3 rounded-lg text-center border border-gray-700/30 flex flex-col justify-center">
                            <span class="label block text-blue-300 text-[10px] mb-1">Se acuesta</span>
                            <p class="text-xl font-mono text-white font-bold">{formatTime(paciente.hora_acostarse)}</p>
                        </div>
    
                        <div class="bg-gray-800/30 p-3 rounded-lg text-center border border-gray-700/30 flex flex-col justify-center">
                            <span class="label block text-indigo-300 text-[10px] mb-1">Se duerme</span>
                            <p class="text-xl font-mono text-white font-bold">{formatTime(paciente.hora_dormir)}</p>
                        </div>
    
                        <div class="bg-gray-800/30 p-3 rounded-lg text-center border border-gray-700/30 flex flex-col justify-center">
                            <span class="label block text-emerald-300 text-[10px] mb-1">Se despierta</span>
                            <p class="text-xl font-mono text-white font-bold">{formatTime(paciente.hora_despertar)}</p>
                        </div>
    
                        <div class="bg-gray-800/30 p-3 rounded-lg text-center border border-gray-700/30 flex flex-col justify-center">
                            <span class="label block text-teal-300 text-[10px] mb-1">Se levanta</span>
                            <p class="text-xl font-mono text-white font-bold">{formatTime(paciente.hora_levantarse)}</p>
                        </div>
    
                    </div>
    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-12">
    
                        <div>
                            <span class="label mb-0">Lugar habitual de sueño</span>
                            <p class="text-lg text-white font-medium capitalize">{paciente.donde_duerme || "—"}</p>
                        </div>
    
                        <div>
                            <span class="label">Despertares nocturnos</span>
                            <p class="value capitalize text-gray-200">
                                {paciente.despierta_noche === 'si' ? `Sí (${paciente.que_despierta || 'Causa no esp.'})` : 'No'}
                            </p>
                        </div>
    
                        <div>
                            <span class="label">Somnolencia diurna</span>
                            <p class="value capitalize text-gray-200">
                                {paciente.somnolencia || "No"}
                            </p>
                        </div>
    
                        <div>
                            <span class="label">Siestas</span>
                            <p class="value capitalize text-gray-200">
                                {paciente.siesta === 'si' ? `Sí (${paciente.dias_siesta} días/sem, ${paciente.tiempo_siesta})` : 'No'}
                            </p>
                        </div>
    
                        <div>
                            <span class="label">Ejercicio físico</span>
                            <p class="value capitalize text-gray-200">
                                {paciente.ejercicio === 'si' ? `Sí (${paciente.horas_ejercicio} hrs/sem)` : 'No'}
                            </p>
                        </div>
                    </div>
    
                </InfoCard>
            </section>

            <section id="alteraciones" class="scroll-mt-32">
                <InfoCard title="Alteraciones del Sueño">
                    <div class="flex flex-col gap-3 p-4 bg-gray-800/30 rounded-xl border border-gray-700/50">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="p-2 bg-red-500/10 rounded-lg text-red-400">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>
                            </div>
                            <span class="label mb-0">Diagnósticos Preliminares</span>
                        </div>
                        
                        <div class="pl-2">
                            {paciente.alteracion_sueno && paciente.alteracion_sueno.length > 0 ? (
                                <div class="flex flex-wrap gap-2">
                                    {/* Verificamos si es array (nuevo formato) o string (viejo formato migrado mal) por seguridad */}
                                    {Array.isArray(paciente.alteracion_sueno) 
                                        ? paciente.alteracion_sueno.map((alt: string) => (
                                            <span class="px-3 py-1 bg-red-900/20 border border-red-500/30 text-red-200 rounded-full text-sm font-medium capitalize shadow-sm">
                                                {alt.replace(/_/g, ' ')}
                                            </span>
                                        ))
                                        : <span class="text-white capitalize">{paciente.alteracion_sueno}</span>
                                    }
                                </div>
                            ) : (
                                <p class="text-gray-500 italic">Ninguno seleccionado</p>
                            )}
                        </div>
                    </div>
                </InfoCard>
            </section>

            <section id="puntajes" class="scroll-mt-32">
                <InfoCard title="Puntajes">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-400 text-sm">Resultados de las pruebas aplicadas al paciente.</p>
                        <button onclick="document.getElementById('modal-puntajes').showModal()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors cursor-pointer flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                            Gestionar Puntajes
                        </button>
                    </div>
    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-gray-500 text-xs uppercase border-b border-gray-700/50">
                                    <th class="pb-2 font-medium">Prueba</th>
                                    <th class="pb-2 text-center text-blue-400">Pre</th>
                                    <th class="pb-2 text-center text-purple-400">Inter</th>
                                    <th class="pb-2 text-center text-emerald-400">Post</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                {['epworth', 'dbi', 'hamilton_d', 'hamilton_a', 'isi', 'psqi', 'stop_bang', 'berlin', 'cuestionario_insomnio'].map(score => (
                                    <tr>
                                        <td class="py-2 pr-4 font-medium text-gray-300 uppercase">{score.replace(/_/g, ' ')}</td>
                                        <td class="py-2 text-center font-mono text-blue-200">{paciente[`${score}_pre`] ?? "-"}</td>
                                        <td class="py-2 text-center font-mono text-purple-200">{paciente[`${score}_inter`] ?? "-"}</td>
                                        <td class="py-2 text-center font-mono text-emerald-200">{paciente[`${score}_post`] ?? "-"}</td>
                                    </tr>
                                ))}
                                {paciente.pacientes_puntajes_extra && paciente.pacientes_puntajes_extra.map((extra: any) => (
                                    <tr class="bg-blue-900/10">
                                        <td class="py-2 pr-4 font-medium text-blue-300">{extra.nombre_prueba} <span class="text-[10px] text-gray-500 uppercase">(Extra)</span></td>
                                        <td class="py-2 text-center font-mono text-blue-200">{extra.puntaje_pre ?? "-"}</td>
                                        <td class="py-2 text-center font-mono text-purple-200">{extra.puntaje_inter ?? "-"}</td>
                                        <td class="py-2 text-center font-mono text-emerald-200">{extra.puntaje_post ?? "-"}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </InfoCard>
            </section>

            <section id="reporte-resultados" class="mb-10 animate-fade-in-up delay-100">
                <InfoCard title="Reporte de Resultados">
                    <div class="flex items-center justify-between mb-4">
                        <p class="text-lg font-bold text-gray-400 flex items-center gap-2">
                            Resultados del reporte del estudio de poligrafía del sueño.
                        </p>
                        
                        <button onclick="document.getElementById('modal-resultados').showModal()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 cursor-pointer">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            {reporteResultados ? 'Editar Resultados' : 'Registrar Resultados'}
                        </button>
                    </div>

                    <div class="bg-gray-900/50 border border-gray-800 rounded-2xl p-6 shadow-xl backdrop-blur-sm">
                        {reporteResultados ? (
                            <div class="space-y-6">
                                <div class="grid grid-cols-2 gap-4 bg-gray-800/40 p-4 rounded-xl border border-gray-700/50">
                                    <div class="text-center">
                                        <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Duración Registro</span>
                                        <p class="text-xl text-white font-mono mt-1">{reporteResultados.duracion_registro}</p>
                                    </div>
                                    <div class="text-center border-l border-gray-700/50">
                                        <span class="text-xs text-gray-500 uppercase font-bold tracking-wider">Duración Evaluación</span>
                                        <p class="text-xl text-white font-mono mt-1">{reporteResultados.duracion_evaluacion}</p>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="text-sm font-bold text-gray-400 mb-3 border-b border-gray-800 pb-1">Análisis Respiratorio</h4>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div class="bg-indigo-500/10 border border-indigo-500/20 p-3 rounded-lg text-center">
                                            <span class="text-xs text-indigo-300 font-bold block">IAH</span>
                                            <span class="text-2xl font-bold text-white">{reporteResultados.iah}</span>
                                        </div>
                                        <div class="bg-gray-800 p-3 rounded-lg text-center">
                                            <span class="text-xs text-gray-400 block">Índice Apneas</span>
                                            <span class="text-xl font-bold text-gray-200">{reporteResultados.indice_apneas}</span>
                                        </div>
                                        <div class="bg-gray-800 p-3 rounded-lg text-center">
                                            <span class="text-xs text-gray-400 block">Índice Hipopnea</span>
                                            <span class="text-xl font-bold text-gray-200">{reporteResultados.indice_hipopnea}</span>
                                        </div>
                                        <div class="bg-gray-800 p-3 rounded-lg text-center">
                                            <span class="text-xs text-gray-400 block">Ronquidos</span>
                                            <span class="text-xl font-bold text-gray-200">{reporteResultados.ronquidos}</span>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-4 gap-2 mt-3 text-center">
                                        <div class="bg-gray-800/30 rounded py-1"><span class="text-[10px] text-gray-500 block">IAI</span><span class="text-sm font-mono text-gray-300">{reporteResultados.iai}</span></div>
                                        <div class="bg-gray-800/30 rounded py-1"><span class="text-[10px] text-gray-500 block">IAO</span><span class="text-sm font-mono text-gray-300">{reporteResultados.iao}</span></div>
                                        <div class="bg-gray-800/30 rounded py-1"><span class="text-[10px] text-gray-500 block">IAC</span><span class="text-sm font-mono text-gray-300">{reporteResultados.iac}</span></div>
                                        <div class="bg-gray-800/30 rounded py-1"><span class="text-[10px] text-gray-500 block">IAM</span><span class="text-sm font-mono text-gray-300">{reporteResultados.iam}</span></div>
                                    </div>
                                </div>

                                <div>
                                    <h4 class="text-sm font-bold text-gray-400 mb-3 border-b border-gray-800 pb-1">Oximetría y Pulso</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div class="flex items-center justify-between bg-emerald-500/5 border border-emerald-500/10 p-3 rounded-lg">
                                            <span class="text-xs text-emerald-400 font-bold">Sat. Promedio</span>
                                            <span class="text-xl font-bold text-white">{reporteResultados.saturacion_promedio}%</span>
                                        </div>
                                        <div class="flex items-center justify-between bg-rose-500/5 border border-rose-500/10 p-3 rounded-lg">
                                            <span class="text-xs text-rose-400 font-bold">Pulso Promedio</span>
                                            <span class="text-xl font-bold text-white">{reporteResultados.pulso_promedio} <span class="text-xs">bpm</span></span>
                                        </div>
                                        <div class="flex flex-col justify-center bg-gray-800/50 p-2 rounded-lg text-center">
                                            <span class="text-[10px] text-gray-500 uppercase">Sat &lt; 90%</span>
                                            <div class="flex justify-center gap-3 text-sm font-mono">
                                                <span class="text-white">{reporteResultados.sat_90_min} min</span>
                                                <span class="text-gray-600">|</span>
                                                <span class="text-white">{reporteResultados.sat_90_porc}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        ) : (
                            <div class="flex flex-col items-center justify-center py-8 text-center">
                                <div class="w-16 h-16 bg-gray-800 rounded-full flex items-center justify-center mb-4">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                                </div>
                                <p class="text-gray-400 font-medium">Sin resultados registrados</p>
                                <p class="text-sm text-gray-600 mb-4">No hay datos de polismnografía o estudio simplificado.</p>
                                <button onclick="document.getElementById('modal-resultados').showModal()" class="bg-gray-800 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm transition-colors border border-gray-700">
                                    Registrar ahora
                                </button>
                            </div>
                        )}
                    </div>
                </InfoCard>
            </section>
            
            <section id="tms" class="scroll-mt-32">
                <InfoCard title="Protocolo TMS"> 
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <p class="text-gray-400 text-lg max-w-xl">
                                {paciente.tms_habilitado 
                                    ? `Seguimiento activo. Se han registrado ${sesionesTMS.length} sesiones hasta el momento.`
                                    : "Este paciente aún no tiene habilitado el seguimiento para Estimulación Magnética Transcraneal."}
                            </p>
                        </div>
    
                        <div class="flex flex-col items-end gap-3">
                            {!paciente.tms_habilitado ? (
                                <form method="POST">
                                    <input type="hidden" name="action" value="habilitar_tms" />
                                    <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl shadow-lg shadow-blue-900/20 transition-all transform hover:scale-105">
                                        Habilitar Seguimiento
                                    </button>
                                </form>
                            ) : (
                                <div class="flex flex-wrap justify-end gap-3">
                                    
                                    {urlConsentimientoFirmado ? (
                                        <a href={urlConsentimientoFirmado} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 px-4 py-3 bg-emerald-500/10 hover:bg-emerald-500/20 border border-emerald-500/20 text-emerald-400 font-medium rounded-xl transition-colors group">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                <span>Consentimiento Firmado</span>
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 opacity-50" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                                        </a>
                                    ) : (
                                        <form method="POST" enctype="multipart/form-data" class="relative">
                                            <input type="hidden" name="action" value="subir_consentimiento_tms" />
                                            
                                            <input 
                                                type="file" 
                                                name="archivo_pdf" 
                                                id="file-consentimiento" 
                                                accept="application/pdf"
                                                class="hidden"
                                                onchange="this.form.submit()"
                                            />
                                            
                                            <label for="file-consentimiento" class="cursor-pointer flex items-center gap-2 px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-dashed border-gray-600 hover:border-blue-400 text-gray-300 hover:text-white font-medium rounded-xl transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                                </svg>
                                                <span>Subir Consentimiento</span>
                                            </label>
                                        </form>
                                    )}
    
                                    <button onclick="document.getElementById('modal-tms').showModal()" class="group flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl shadow-lg shadow-blue-900/20 transition-all">
                                        <span>Ver Sesiones</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white/70 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </InfoCard>
            </section>

            <section id="evaluacion" class="scroll-mt-32">
                <InfoCard title="Enlaces de evaluación remota">
                    <div class="flex flex-col justify-between items-start gap-6 md:flex-row">
                        <div class="mb-6">
                            <p class="text-sm text-gray-400 mt-1">1. Selecciona la fase del tratamiento.</p>
                            <p class="text-sm text-gray-400">2. Copia el enlace del cuestionario específico que deseas enviar.</p>
                        </div>
                        
                        <div class="mb-6">
                            <button onclick="document.getElementById('modal-copy-forms').showModal()" class="text-xs bg-green-600/20 text-green-400 hover:bg-green-600 hover:text-white border border-green-600/50 px-3 py-1.5 rounded-lg transition-all flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.305-.883-.653-1.48-1.459-1.653-1.756-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.8 12.8 0 0 0-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg>
                                Copiar mensaje para el paciente
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-2 p-1 bg-gray-800 rounded-lg w-fit mb-6">
                        <button onclick="setFase('pre')" id="btn-pre" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow">Pre-Tratamiento</button>
                        <button onclick="setFase('inter')" id="btn-inter" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Intermedio</button>
                        <button onclick="setFase('post')" id="btn-post" class="px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white">Post-Tratamiento</button>
                    </div>
    
                    <div class="grid gap-3">
                        
                        <div class="bg-black/40 p-2 pr-3 rounded-lg border border-gray-700/50 group hover:border-blue-500/50 transition-colors" id="row-epworth">
                            <div class="flex items-center gap-2">
                                <div class="bg-blue-900/20 text-blue-400 px-3 py-2 rounded font-bold text-xs uppercase tracking-wider min-w-[100px] text-center">Epworth</div>
                                
                                <div class="container-link flex items-center gap-2 w-full">
                                    <input type="text" readonly id="link-epworth" class="bg-transparent border-none text-gray-500 text-xs w-full focus:ring-0 font-mono truncate" />
                                    <button onclick="copiarLink('link-epworth')" class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-gray-700 transition-colors" title="Copiar enlace">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>
                                    </button>
                                </div>
    
                                <div class="container-btn hidden w-full">
                                    <button onclick="verRespuestas('epworth')" class="w-full bg-blue-600/20 hover:bg-blue-600/30 text-blue-300 hover:text-blue-100 text-xs font-bold py-2 px-4 rounded border border-blue-500/30 flex items-center justify-center gap-2 transition-all">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                                        Ver Respuestas del Paciente
                                    </button>
                                </div>
                            </div>
                        </div>
    
                        <div class="bg-black/40 p-2 pr-3 rounded-lg border border-gray-700/50 group hover:border-emerald-500/50 transition-colors" id="row-berlin">
                            <div class="flex items-center gap-2">
                                <div class="bg-emerald-900/20 text-emerald-400 px-3 py-2 rounded font-bold text-xs uppercase tracking-wider min-w-[100px] text-center">Berlin</div>
                                
                                <div class="container-link flex items-center gap-2 w-full">
                                    <input type="text" readonly id="link-berlin" class="bg-transparent border-none text-gray-500 text-xs w-full focus:ring-0 font-mono truncate" />
                                    <button onclick="copiarLink('link-berlin')" class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>
                                    </button>
                                </div>
                                <div class="container-btn hidden w-full">
                                    <button onclick="verRespuestas('berlin')" class="w-full bg-emerald-600/20 hover:bg-emerald-600/30 text-emerald-300 hover:text-emerald-100 text-xs font-bold py-2 px-4 rounded border border-emerald-500/30 flex items-center justify-center gap-2 transition-all">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                                        Ver Respuestas del Paciente
                                    </button>
                                </div>
                            </div>
                        </div>
    
                        <div class="bg-black/40 p-2 pr-3 rounded-lg border border-gray-700/50 group hover:border-purple-500/50 transition-colors" id="row-psqi">
                            <div class="flex items-center gap-2">
                                <div class="bg-purple-900/20 text-purple-400 px-3 py-2 rounded font-bold text-xs uppercase tracking-wider min-w-[100px] text-center">psqi</div>
                                
                                <div class="container-link flex items-center gap-2 w-full">
                                    <input type="text" readonly id="link-psqi" class="bg-transparent border-none text-gray-500 text-xs w-full focus:ring-0 font-mono truncate" />
                                    <button onclick="copiarLink('link-psqi')" class="text-gray-400 hover:text-white p-2 rounded-md hover:bg-gray-700 transition-colors">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 0 1-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 0 1 1.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 0 0-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 0 1-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 0 0-3.375-3.375h-1.5a1.125 1.125 0 0 1-1.125-1.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H9.75" /></svg>
                                    </button>
                                </div>
                                <div class="container-btn hidden w-full flex gap-5">
                                    <button onclick="verRespuestas('psqi')" class="flex-1 bg-purple-600/20 hover:bg-purple-600/30 text-purple-300 hover:text-purple-100 text-xs font-bold py-2 px-2 rounded border border-purple-500/30 flex items-center justify-center gap-2 transition-all">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>
                                        Ver Respuestas del Paciente
                                    </button>
                                    
                                    <button onclick="abrirModalEstudio()" class="flex-1 bg-purple-700 hover:bg-purple-500 text-white text-xs font-bold py-2 px-2 rounded border border-purple-500 flex items-center justify-center gap-2 transition-all shadow-lg shadow-purple-900/20" title="Ingresar dato real de horas dormidas">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" /></svg>
                                        Ingresar resultado de estudio
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </InfoCard>
            </section>

            <section id="seguimiento" class="scroll-mt-32">
                <InfoCard title="Seguimiento">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-400 text-sm">Historial de notas posteriores a consulta.</p>
                        <button id="btn-nueva-nota" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors cursor-pointer flex items-center gap-2">
                            <span class="text-lg leading-none">+</span> Agregar Nota
                        </button>
                    </div>
    
                    <div class="space-y-4">
                        {paciente.pacientes_seguimiento && paciente.pacientes_seguimiento.length > 0 ? (
                            paciente.pacientes_seguimiento.map((nota: any) => (
                                <div class="relative transition-colors group">
                                    
                                    <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50 hover:bg-gray-800/60 transition-all">
                                        <div class="flex justify-between items-start mb-2">
                                            <div class="flex flex-col">
                                                <span class="text-sm font-bold text-blue-300 font-mono">
                                                    {formatDateShort(nota.fecha)}
                                                </span>
                                                <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">
                                                    Seguimiento realizado por: <span class="text-blue-300">{nota.registrado_por || "Sistema"}</span>
                                                </span>
                                            </div>
                                            
                                            <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                                <button class="text-gray-400 hover:text-white btn-editar-nota" data-id={nota.id} data-fecha={nota.fecha.split('T')[0]} data-texto={nota.observacion} title="Editar">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                                                </button>
                                                <button type="button" class="text-gray-400 hover:text-red-400 btn-borrar-nota" data-id={nota.id} title="Eliminar">
                                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" /></svg>
                                                </button>
                                            </div>
                                        </div>
                                        <p class="text-gray-200 whitespace-pre-wrap leading-relaxed text-sm">{nota.observacion}</p>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <div class="text-center py-8 border border-dashed border-gray-700 rounded-xl"><p class="text-gray-500 italic">No hay observaciones registradas.</p></div>
                        )}
                    </div>
                </InfoCard>
            </section>

            <div class="mt-12 border-t border-red-900/30 pt-8 pb-10 flex flex-col items-center">
                <button onclick="document.getElementById('modal-eliminar').showModal()" class="group flex items-center gap-2 text-red-500 hover:text-red-400 hover:bg-red-500/10 px-4 py-2 rounded-lg transition-all cursor-pointer border border-transparent hover:border-red-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 group-hover:scale-110 transition-transform">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                    Eliminar Expediente Completo
                </button>
            </div>

        </div>
    </main>

    <dialog id="modal-copy-forms" class="bg-gray-900 border border-gray-700 rounded-3xl p-0 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-xl text-left m-auto outline-none">
        <div class="p-5 border-b border-gray-800 flex justify-between items-center bg-gray-800/50">
            <h3 class="text-lg font-bold text-white flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.305-.883-.653-1.48-1.459-1.653-1.756-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51a12.8 12.8 0 0 0-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 0 1-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 0 1-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 0 1 2.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0 0 12.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 0 0 5.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 0 0-3.48-8.413Z"/></svg>
                Enviar a Paciente
            </h3>
            <button onclick="document.getElementById('modal-copy-forms').close()" class="text-gray-500 hover:text-white transition-colors cursor-pointer text-2xl leading-none">&times;</button>
        </div>
        <div class="p-6 space-y-5">
            <textarea id="texto-plantilla-wpp" class="w-full h-72 bg-gray-800/80 border border-gray-700 rounded-xl p-4 text-sm text-gray-300 focus:outline-none focus:border-green-500 resize-none font-sans" readonly>{mensajeWhatsApp}</textarea>
            
            <button id="btn-copiar-plantilla" onclick="copiarMensajeWpp()" class="w-full py-3 bg-green-600 hover:bg-green-500 text-white font-bold rounded-xl flex items-center justify-center gap-2 transition-all cursor-pointer shadow-lg shadow-green-900/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3" /></svg>
                Copiar Mensaje
            </button>
        </div>
    </dialog>

    <dialog id="modal-resultados" class="bg-gray-900 border border-gray-700 rounded-3xl p-0 shadow-2xl backdrop:backdrop-blur-xl w-full max-w-2xl text-left m-auto">
        <div class="p-6 border-b border-gray-800 flex justify-between items-center bg-gray-800/50">
            <h3 class="text-xl font-bold text-white">Resultados de Estudio</h3>
            <button onclick="document.getElementById('modal-resultados').close()" class="text-gray-500 hover:text-white transition-colors cursor-pointer text-2xl leading-none">&times;</button>
        </div>
        
        <form method="POST" class="p-6 overflow-y-auto max-h-[80vh] custom-scrollbar">
            <input type="hidden" name="action" value="registrar_reporte" />
            
            <div class="grid grid-cols-2 gap-6 mb-8">
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-400 uppercase">Duración Registro</label>
                    <div class="flex gap-2">
                        <div class="relative w-full">
                            <input type="number" name="dur_reg_h" placeholder="0" value={regTiempo.h} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-gray-500 text-sm">hr</span>
                        </div>
                        <div class="relative w-full">
                            <input type="number" name="dur_reg_m" placeholder="0" value={regTiempo.m} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-gray-500 text-sm">min</span>
                        </div>
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="text-xs font-bold text-gray-400 uppercase">Duración Evaluación</label>
                    <div class="flex gap-2">
                        <div class="relative w-full">
                            <input type="number" name="dur_eval_h" placeholder="0" value={evalTiempo.h} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-gray-500 text-sm">hr</span>
                        </div>
                        <div class="relative w-full">
                            <input type="number" name="dur_eval_m" placeholder="0" value={evalTiempo.m} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-gray-500 text-sm">min</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-6 mb-8">
                <h4 class="text-sm font-bold text-white border-b border-gray-800 pb-2">Índices Respiratorios</h4>
                
                <div class="grid grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs text-indigo-400 font-bold ml-1">IAH (Total)</label>
                        <input type="number" step="0.1" name="iah" value={reporteResultados?.iah ?? ''} class="w-full bg-indigo-900/20 border border-indigo-500/50 rounded-lg p-2.5 text-white focus:border-indigo-400 outline-none font-bold" />
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-gray-400 ml-1">Índice Apneas</label>
                        <input type="number" step="0.1" name="indice_apneas" value={reporteResultados?.indice_apneas ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-gray-400 ml-1">Índice Hipopneas</label>
                        <input type="number" step="0.1" name="indice_hipopnea" value={reporteResultados?.indice_hipopnea ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                    </div>
                </div>

                <div class="grid grid-cols-4 gap-3 bg-gray-800/30 p-3 rounded-xl border border-gray-800">
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] text-gray-500">IAI</label>
                        <input type="number" step="0.1" name="iai" value={reporteResultados?.iai ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded text-center text-sm text-white p-1" />
                    </div>
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] text-gray-500">IAO</label>
                        <input type="number" step="0.1" name="iao" value={reporteResultados?.iao ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded text-center text-sm text-white p-1" />
                    </div>
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] text-gray-500">IAC</label>
                        <input type="number" step="0.1" name="iac" value={reporteResultados?.iac ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded text-center text-sm text-white p-1" />
                    </div>
                    <div class="space-y-1 text-center">
                        <label class="text-[10px] text-gray-500">IAM</label>
                        <input type="number" step="0.1" name="iam" value={reporteResultados?.iam ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded text-center text-sm text-white p-1" />
                    </div>
                </div>
            </div>

            <div class="space-y-6">
                <h4 class="text-sm font-bold text-white border-b border-gray-800 pb-2">Oximetría y Eventos</h4>
                <div class="grid grid-cols-3 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs text-emerald-400 font-bold ml-1">Sat. Promedio</label>
                        <div class="relative">
                            <input type="number" name="saturacion_promedio" value={reporteResultados?.saturacion_promedio ?? ''} class="w-full bg-emerald-900/10 border border-emerald-500/30 rounded-lg p-2.5 text-white focus:border-emerald-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-emerald-500 text-sm">%</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-rose-400 font-bold ml-1">Pulso Promedio</label>
                        <div class="relative">
                            <input type="number" name="pulso_promedio" value={reporteResultados?.pulso_promedio ?? ''} class="w-full bg-rose-900/10 border border-rose-500/30 rounded-lg p-2.5 text-white focus:border-rose-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-rose-500 text-sm">bpm</span>
                        </div>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs text-gray-400 ml-1">Ronquidos</label>
                        <div class="relative">
                            <input type="number" name="ronquidos" value={reporteResultados?.ronquidos ?? ''} class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                            <span class="absolute right-3 top-2.5 text-gray-500 text-xs">evt</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 pt-2">
                    <div class="col-span-2 text-xs font-bold text-gray-500 uppercase">Desaturación &lt; 90%</div>
                    <div class="relative">
                        <input type="number" name="sat_90_min" value={reporteResultados?.sat_90_min ?? ''} placeholder="Minutos" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                        <span class="absolute right-3 top-2.5 text-gray-500 text-sm">min</span>
                    </div>
                    <div class="relative">
                        <input type="number" step="0.1" name="sat_90_porc" value={reporteResultados?.sat_90_porc ?? ''} placeholder="Porcentaje" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-2.5 text-white focus:border-indigo-500 outline-none" />
                        <span class="absolute right-3 top-2.5 text-gray-500 text-sm">%</span>
                    </div>
                </div>
            </div>

            <div class="pt-6 mt-6 border-t border-gray-800 flex justify-end gap-3">
                <button type="button" onclick="document.getElementById('modal-resultados').close()" class="px-5 py-2.5 rounded-xl border border-gray-700 text-gray-300 hover:text-white hover:bg-gray-800 transition-colors cursor-pointer font-medium">Cancelar</button>
                <button type="submit" class="px-6 py-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/20 transition-all cursor-pointer font-bold">Guardar Informe</button>
            </div>
        </form>
    </dialog>

    <dialog id="modal-psqi-estudio" class="m-auto bg-gray-900 border border-purple-500 rounded-2xl p-6 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-sm text-center">
        <div class="mb-4 text-purple-400 flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-12 h-12">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m3.75 9v6m3-3H9m1.5-12H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
            </svg>
        </div>
        <h3 class="text-xl font-bold text-white mb-2">Datos del Estudio de Sueño</h3>
        <p class="text-gray-400 text-xs mb-6 px-2">
            Ingresa las horas reales de sueño obtenidas en el estudio clínico. <br>
            <span class="text-purple-300">Esto recalculará la eficiencia y el puntaje total.</span>
        </p>
        
        <form method="POST" class="flex flex-col gap-4">
            <input type="hidden" name="action" value="update_psqi_study">
            <input type="hidden" name="fase" id="input-fase-estudio">
            
            <div class="bg-gray-800/50 p-3 rounded-lg border border-gray-700">
                <label class="text-xs text-gray-500 uppercase font-bold block mb-2">Horas Dormidas (Reales)</label>
                <div class="flex items-center justify-center gap-2">
                    <input type="number" step="0.1" name="horas" id="input-horas-estudio" placeholder="Ej. 5.5" class="bg-gray-900 border border-purple-500/50 rounded-lg p-2 text-white text-center text-xl font-mono w-24 focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    <span class="text-gray-400 font-bold">Hrs</span>
                </div>
            </div>

            <div class="flex gap-3 justify-center mt-2">
                <button type="button" onclick="document.getElementById('modal-psqi-estudio').close()" class="flex-1 py-2.5 rounded-xl border border-gray-600 text-gray-300 hover:text-white cursor-pointer hover:bg-gray-800 transition-colors">
                    Cancelar
                </button>
                <button type="submit" class="flex-1 py-2.5 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-500 cursor-pointer shadow-lg shadow-purple-900/20">
                    Guardar
                </button>
            </div>
        </form>
    </dialog>

    <dialog id="modal-ver-respuestas" class="m-auto bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl backdrop:backdrop-blur-sm w-full max-w-2xl text-left p-0 overflow-hidden">
        
        <div class="bg-gray-800 border-b border-gray-700 p-5 sticky top-0 z-10">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 class="text-xl font-bold text-white capitalize flex items-center gap-3">
                        <span id="titulo-ver-respuestas">Resultados</span>
                        <span id="badge-fase" class="text-[10px] px-2 py-0.5 rounded-full border uppercase tracking-wider"></span>
                    </h3>
                    <p class="text-sm text-gray-400 mt-1 flex items-center gap-1">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd" /></svg>
                        <span id="subtitulo-ver-respuestas">Fecha</span>
                    </p>
                </div>
                <button onclick="document.getElementById('modal-ver-respuestas').close()" class="text-gray-400 hover:text-white bg-gray-700/50 hover:bg-gray-600 rounded-lg p-2 transition-colors cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>
            </div>

            <div class="flex items-center gap-2 bg-gray-900/50 border border-gray-700/50 rounded-lg p-2">
                <div class="bg-gray-800 p-1.5 rounded text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
                </div>
                <input type="text" id="modal-link-input" readonly class="bg-transparent border-none text-xs text-blue-400 font-mono w-full focus:ring-0 px-0" />
                <button onclick="copiarLinkModal()" class="text-xs font-bold text-gray-400 hover:text-white bg-gray-700 hover:bg-gray-600 px-3 py-1.5 rounded-md transition-colors whitespace-nowrap" id="btn-copiar-modal">
                    Copiar
                </button>
            </div>
        </div>

        <div class="max-h-[60vh] overflow-y-auto bg-gray-900">
            <div id="contenido-respuestas" class="divide-y divide-gray-800"></div>
        </div>
        
        <div class="bg-gray-800/30 border-t border-gray-800 p-2 text-center">
            <span class="text-[10px] text-gray-500 font-mono uppercase tracking-widest">Fin del reporte</span>
        </div>
    </dialog>

    <dialog id="modal-eliminar-observacion" class="m-auto bg-gray-900 border border-red-500/50 rounded-2xl p-6 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-sm text-center">
        <div class="mb-4 text-red-500 flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-10 h-10">
                <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
            </svg>
        </div>
        <h3 class="text-lg font-bold text-white mb-2">¿Borrar esta nota?</h3>
        <p class="text-gray-400 text-xs mb-6">Esta acción eliminará la observación permanentemente.</p>
        
        <form method="POST" class="flex gap-3 justify-center">
            <input type="hidden" name="action" value="delete_seguimiento" />
            <input type="hidden" name="id_seguimiento" id="input-id-borrar-observacion" />
            
            <button type="button" onclick="document.getElementById('modal-eliminar-observacion').close()" class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:text-white cursor-pointer text-sm">Cancelar</button>
            <button type="submit" class="px-4 py-2 rounded-lg bg-red-600 text-white font-bold hover:bg-red-700 cursor-pointer text-sm">Sí, Borrar</button>
        </form>
    </dialog>

    <dialog id="modal-seguimiento" class="m-auto bg-gray-900 border border-gray-700 rounded-2xl p-6 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-lg text-left">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white" id="modal-seguimiento-titulo">Agregar Nota</h3>
            <button onclick="document.getElementById('modal-seguimiento').close()" class="text-gray-500 hover:text-white cursor-pointer">✕</button>
        </div>
        <form method="POST" class="space-y-4">
            <input type="hidden" name="action" id="seguimiento-action" value="add_seguimiento">
            <input type="hidden" name="id_seguimiento" id="seguimiento-id">
            <div class="flex flex-col">
                <label class="text-xs text-gray-400 mb-1">Fecha</label>
                <input type="date" name="fecha" id="seguimiento-fecha" class="bg-gray-800 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none" required style="color-scheme: dark;">
            </div>
            <div class="flex flex-col">
                <label class="text-xs text-gray-400 mb-1">Observación</label>
                <textarea name="observacion" id="seguimiento-texto" rows="5" class="bg-gray-800 border border-gray-600 rounded p-3 text-white focus:border-blue-500 focus:outline-none resize-none" required></textarea>
            </div>
            <div class="pt-4 flex gap-3 justify-end border-t border-gray-700/50">
                <button type="button" onclick="document.getElementById('modal-seguimiento').close()" class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:text-white cursor-pointer">Cancelar</button>
                <button type="submit" class="px-6 py-2 rounded-lg bg-emerald-600 text-white font-medium hover:bg-emerald-500 cursor-pointer">Guardar</button>
            </div>
        </form>
    </dialog>

    <dialog id="modal-puntajes" class="m-auto bg-gray-900 border border-gray-700 rounded-2xl p-6 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-4xl text-left">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-bold text-white">Actualizar Puntajes (Pre / Inter / Post)</h3>
            <button onclick="document.getElementById('modal-puntajes').close()" class="text-gray-500 hover:text-white cursor-pointer">✕</button>
        </div>
        
        <form method="POST" class="space-y-6">
            <input type="hidden" name="action" value="update_scores" />
            
            <div class="overflow-x-auto max-h-[60vh] overflow-y-auto pr-2">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-gray-900 z-10">
                        <tr class="text-gray-400 text-xs uppercase border-b border-gray-700">
                            <th class="py-2">Prueba</th>
                            <th class="py-2 text-center w-24 text-blue-400">Pre</th>
                            <th class="py-2 text-center w-24 text-purple-400">Inter</th>
                            <th class="py-2 text-center w-24 text-emerald-400">Post</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-800">
                        {['epworth', 'dbi', 'hamilton_d', 'hamilton_a', 'isi', 'psqi', 'stop_bang', 'berlin', 'cuestionario_insomnio'].map(score => (
                            <tr>
                                <td class="py-3 font-medium text-gray-300 capitalize text-sm">{score.replace(/_/g, ' ')}</td>
                                <td class="p-2"><input type="number" name={`${score}_pre`} value={paciente[`${score}_pre`]} class="score-input w-full" /></td>
                                <td class="p-2"><input type="number" name={`${score}_inter`} value={paciente[`${score}_inter`]} class="score-input w-full" /></td>
                                <td class="p-2"><input type="number" name={`${score}_post`} value={paciente[`${score}_post`]} class="score-input w-full" /></td>
                            </tr>
                        ))}
                    </tbody>
                </table>

                <div class="mt-6 pt-4 border-t border-gray-700">
                    <h4 class="text-sm font-bold text-white mb-3">Puntajes Extra</h4>
                    <div id="modal-extras-container" class="space-y-2">
                        {paciente.pacientes_puntajes_extra && paciente.pacientes_puntajes_extra.map((extra: any) => (
                            <div class="grid grid-cols-12 gap-2 items-center extra-row bg-gray-800/30 p-2 rounded">
                                <div class="col-span-3">
                                    <input type="text" name="extra_prueba_nombre" value={extra.nombre_prueba} placeholder="Nombre" class="bg-transparent border-b border-gray-600 text-white w-full text-sm focus:outline-none focus:border-blue-500" />
                                </div>
                                <div class="col-span-3"><input type="number" name="extra_prueba_pre" value={extra.puntaje_pre} placeholder="Pre" class="score-input w-full" /></div>
                                <div class="col-span-3"><input type="number" name="extra_prueba_inter" value={extra.puntaje_inter} placeholder="Inter" class="score-input w-full" /></div>
                                <div class="col-span-2"><input type="number" name="extra_prueba_post" value={extra.puntaje_post} placeholder="Post" class="score-input w-full" /></div>
                                <div class="col-span-1 text-center"><button type="button" class="text-red-400 hover:text-red-300 btn-remove-extra">✕</button></div>
                            </div>
                        ))}
                    </div>
                    <button type="button" id="btn-add-extra-modal" class="mt-3 text-xs flex items-center gap-1 text-blue-400 hover:text-blue-300">
                        <span class="text-lg leading-none">+</span> Agregar prueba extra
                    </button>
                </div>
            </div>

            <div class="pt-4 flex gap-3 justify-end border-t border-gray-700/50">
                <button type="button" onclick="document.getElementById('modal-puntajes').close()" class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:text-white cursor-pointer">Cancelar</button>
                <button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-500 cursor-pointer">Guardar Cambios</button>
            </div>
        </form>
    </dialog>

    <dialog id="modal-eliminar" class="m-auto bg-gray-900 border border-red-600 rounded-2xl p-8 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-md text-center">
        <div class="mb-4 text-red-500 flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-12 h-12 animate-pulse">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">¿Eliminar Expediente?</h3>
        <p class="text-gray-300 mb-6 text-sm">
            Estás a punto de eliminar el expediente de <span class="text-white font-bold">{paciente.nombre}</span>. 
            <br/><br/>
            <span class="text-red-400 bg-red-900/20 px-2 py-1 rounded">Esta acción es irreversible</span>
            <br/>Se perderán todos los datos, citas, síntomas y puntajes asociados.
        </p>
        
        <form method="POST" class="flex gap-4 justify-center">
            <input type="hidden" name="action" value="delete_patient">
            <button type="button" onclick="document.getElementById('modal-eliminar').close()" class="px-5 py-2.5 rounded-xl border border-gray-600 text-gray-300 hover:text-white cursor-pointer hover:bg-gray-800 transition-colors">
                Cancelar
            </button>
            <button type="submit" class="px-5 py-2.5 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 cursor-pointer shadow-lg shadow-red-900/20 transition-all hover:scale-105">
                Sí, Eliminar
            </button>
        </form>
    </dialog>

    <dialog id="modal-tms" class="m-auto bg-transparent p-0 backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-5xl">
        <div class="bg-[#0f172a] border border-white/10 rounded-3xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            
            <div class="p-6 border-b border-white/10 bg-slate-900/50 flex justify-between items-center sticky top-0 z-20">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                        Bitácora Técnica TMS
                    </h3>
                    <p class="text-sm text-gray-400">Paciente: <span class="text-white font-medium">{paciente.nombre}</span></p>
                </div>
                <button onclick="document.getElementById('modal-tms').close()" class="p-2 text-gray-400 hover:text-white rounded-full bg-white/5 hover:bg-white/10 transition-colors cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-8">
                
                <div class="bg-gradient-to-br from-blue-900/10 to-slate-900 border border-blue-500/20 rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                    
                    <h4 class="text-sm font-bold text-blue-300 uppercase tracking-wider mb-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Registrar Sesión de Hoy
                    </h4>
                    
                    <form method="POST" class="grid grid-cols-1 md:grid-cols-12 gap-5 relative z-10">
                        <input type="hidden" name="action" value="nueva_sesion_tms" />
                        
                        <div class="md:col-span-3">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Fecha</label>
                            <input type="date" name="fecha" required class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors" style="color-scheme:dark;" />
                        </div>
                        <div class="md:col-span-5">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Protocolo / Diagnóstico</label>
                            <input type="text" name="protocolo" placeholder="Ej. Insomnio Crónico" value={ultimaConfig.protocolo || ''} class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors" />
                        </div>
                        
                        <div class="md:col-span-4">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Sitio Estimulación</label>
                            <select id="select-sitio" name="sitio_estimulacion" class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors appearance-none cursor-pointer">
                                <option value="" disabled selected={!ultimaConfig.sitio_estimulacion}>Seleccionar...</option>
                                <option value="DLPFC Izquierdo" selected={ultimaConfig.sitio_estimulacion === 'DLPFC Izquierdo'}>DLPFC Izquierdo</option>
                                <option value="DLPFC Derecho" selected={ultimaConfig.sitio_estimulacion === 'DLPFC Derecho'}>DLPFC Derecho</option>
                                <option value="Bilateral" selected={ultimaConfig.sitio_estimulacion === 'Bilateral'}>Bilateral (Izq + Der)</option>
                                <option value="Corteza Motora M1" selected={ultimaConfig.sitio_estimulacion === 'Corteza Motora M1'}>Corteza Motora (M1)</option>
                                <option value="Otro" selected={ultimaConfig.sitio_estimulacion === 'Otro'}>Otro</option>
                            </select>
                        </div>

                        <div class="md:col-span-12 grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-slate-950/50 rounded-xl border border-white/5">
                            <div>
                                <label class="block text-[10px] text-blue-400 mb-1">Umbral Motor (MT)</label>
                                <div class="relative">
                                    <input type="number" name="umbral_motor" placeholder="60" value={ultimaConfig.umbral_motor || ''} class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold" />
                                    <span class="absolute right-0 top-1 text-xs text-gray-600">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] text-blue-400 mb-1">Intensidad Tx</label>
                                <div class="relative">
                                    <input type="number" name="intensidad_tratamiento" placeholder="120" value={ultimaConfig.intensidad_tratamiento || ''} class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold" />
                                    <span class="absolute right-0 top-1 text-xs text-gray-600">%</span>
                                </div>
                            </div>
                            
                            <div id="freq-simple" class="block">
                                <label class="block text-[10px] text-blue-400 mb-1">Frecuencia</label>
                                <select name="frecuencia" class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold appearance-none cursor-pointer">
                                    <option value="1Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '1Hz'}>1 Hz</option>
                                    <option value="10Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '10Hz'}>10 Hz</option>
                                    <option value="TBS" class="bg-slate-950" selected={ultimaConfig.frecuencia === 'TBS'}>Theta Burst</option>
                                    <option value="Otro" class="bg-slate-950" selected={ultimaConfig.frecuencia === 'Otro'}>Otro</option>
                                </select>
                            </div>

                            <div id="freq-bilateral" class="hidden col-span-2 md:col-span-1 grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 text-center">Izq (L)</label>
                                    <select name="frecuencia_izq" class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold appearance-none cursor-pointer">
                                        <option value="1Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '1Hz'}>1 Hz</option>
                                        <option value="10Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '10Hz'}>10 Hz</option>
                                        <option value="TBS" class="bg-slate-950" selected={ultimaConfig.frecuencia === 'TBS'}>TBS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 text-center">Der (R)</label>
                                    <select name="frecuencia_der" class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold appearance-none cursor-pointer">
                                        <option value="1Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia_derecha === '1Hz'}>1 Hz</option>
                                        <option value="10Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia_derecha === '10Hz'}>10 Hz</option>
                                        <option value="TBS" class="bg-slate-950" selected={ultimaConfig.frecuencia_derecha === 'TBS'}>TBS</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] text-blue-400 mb-1">Total Pulsos</label>
                                <input type="number" name="total_pulsos" placeholder="1200" value={ultimaConfig.total_pulsos || ''} class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold" />
                            </div>
                        </div>

                        <div class="md:col-span-9">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Notas Clínicas / Incidencias</label>
                            <input type="text" name="observaciones" placeholder="Ej. Paciente durmió durante la sesión." class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors" />
                        </div>
                        <div class="md:col-span-3 flex items-end">
                            <button type="submit" class="w-full h-[40px] bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm rounded-lg transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 cursor-pointer">
                                <span>Guardar Sesión</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    </form>
                </div>

                <div>
                    <h4 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Historial de Aplicaciones</h4>
                    <div class="space-y-3">
                        {sesionesTMS.length > 0 ? sesionesTMS.map((sesion:any, index:any) => (
                            <div class="bg-slate-800/40 border border-white/5 rounded-xl p-4 hover:bg-slate-800/60 transition-colors group">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-3 pb-3 border-b border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 font-bold text-xs">
                                            #{sesionesTMS.length - index}
                                        </div>
                                        <div>
                                            <p class="text-white font-bold text-sm">{formatDate(sesion.fecha_aplicacion)}</p>
                                            <p class="text-xs text-blue-300">{sesion.protocolo || "Protocolo Estándar"}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 text-xs font-mono text-gray-400">
                                        {sesion.umbral_motor && <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500">MT</span><span class="text-white">{sesion.umbral_motor}%</span></div>}
                                        {sesion.intensidad_tratamiento && <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500">Intensidad</span><span class="text-white">{sesion.intensidad_tratamiento}%</span></div>}
                                        
                                        {sesion.frecuencia && (
                                            <div class="flex flex-col items-center">
                                                <span class="text-[10px] text-gray-500">Hz</span>
                                                {sesion.frecuencia_derecha ? (
                                                    <div class="flex flex-col text-[10px] leading-tight">
                                                        <span class="text-emerald-400">L: {sesion.frecuencia}</span>
                                                        <span class="text-blue-400">R: {sesion.frecuencia_derecha}</span>
                                                    </div>
                                                ) : (
                                                    <span class="text-emerald-400">{sesion.frecuencia}</span>
                                                )}
                                            </div>
                                        )}

                                        {sesion.total_pulsos && <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500">Pulsos</span><span class="text-sky-400">{sesion.total_pulsos}</span></div>}
                                    </div>
                                </div>
                                <div class="flex gap-2 items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mt-0.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                                    <p class="text-gray-300 text-sm leading-relaxed">{sesion.observaciones || "Sin observaciones registradas."}</p>
                                </div>
                            </div>
                        )) : (
                            <div class="py-12 text-center text-gray-500 border border-dashed border-gray-800 rounded-xl bg-slate-900/30">
                                <p>No hay sesiones registradas en el historial.</p>
                            </div>
                        )}
                    </div>
                </div>

            </div>
        </div>
    </dialog>

</Layout>

<style>
    @reference "../../../styles/global.css";

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    #dynamic-nav {
        @apply w-full max-w-6xl mx-auto;
        @apply mt-1 mb-1 p-1.5;
        @apply bg-gray-900/40 border border-white/5 backdrop-blur-md;
        @apply rounded-2xl;
        @apply shadow-none;

        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #dynamic-nav[data-state='floating'] {
        @apply max-w-[680px] mt-2;
        
        @apply bg-[#0f172a]/90 border-white/10;
        @apply rounded-full;
        @apply shadow-[0_10px_40px_-10px_rgba(0,0,0,0.6)];
    }

    .nav-link {
        @apply px-4 py-2 text-[11px] font-bold uppercase tracking-wider text-gray-400;
        @apply border border-transparent whitespace-nowrap text-center flex-1;
        
        @apply rounded-xl; 
        
        transition: all 0.3s ease-out;
    }

    .nav-link:hover {
        @apply text-white bg-white/5 border-white/5;
    }

    .nav-link.active {
        @apply bg-blue-600 text-white;
        @apply border-blue-500/30;
        @apply shadow-[0_0_15px_rgba(37,99,235,0.4)];
    }

    #dynamic-nav[data-state='floating'] .nav-link {
        @apply rounded-full;
    }

    .scroll-mt-32 { scroll-margin-top: 30vh; }

    .label {
        @apply block text-gray-500 text-xs uppercase tracking-wider font-bold mb-1;
    }
    .value {
        @apply text-lg text-white font-medium;
    }
    .score-card {
        @apply bg-gray-800/50 border border-gray-700 rounded-lg p-3 flex flex-col items-center justify-center text-center;
    }
    .score-label {
        @apply text-[10px] uppercase text-gray-500 font-bold mb-1;
    }
    .score-val {
        @apply text-2xl font-mono text-blue-300 font-bold;
    }
    .score-input {
        @apply bg-gray-800 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-center;
    }
    
    dialog::backdrop {
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px);
    }

    dialog[open] {
        animation: fade-in 0.3s ease-out;
    }
    @keyframes fade-in {
        from { opacity: 0; transform: scale(0.95); }
        to { opacity: 1; transform: scale(1); }
    }

    details > summary {
        list-style: none;
    }
    details > summary::-webkit-details-marker {
        display: none;
    }

    details[open] .chevron {
        transform: rotate(180deg);
    }
    
    details[open] p {
        animation: fade-in-slide 0.3s ease-out;
    }
    
    @keyframes fade-in-slide {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }

</style>

<script define:vars={{ baseUrl: Astro.url.origin, token: paciente.token_cuestionarios, respuestasGuardadas: paciente.respuestas_cuestionarios || [], nombreAutor}}>
    const DICCIONARIOS = {
        epworth: {
            epworth_1: "Al estar sentado leyendo",
            epworth_2: "Viendo T.V.",
            epworth_3: "Sentado inactivo en un lugar público",
            epworth_4: "Como pasajero en un auto (1 hora)",
            epworth_5: "Recostado descansando por la tarde",
            epworth_6: "Sentado, hablando con alguien",
            epworth_7: "Sentado tranquilamente tras comer",
            epworth_8: "En un auto detenido por tráfico"
        },
        berlin: {
            edad: "Edad",
            altura: "Altura (cm)",
            peso: "Peso (kg)",
            sexo: "Sexo",
            ronca: "¿Ronca?",
            ronca_volumen: "Volumen del ronquido",
            ronca_frecuencia: "Frecuencia del ronquido",
            ronca_molesta: "¿Molesta a otros?",
            ronca_deja_de_respirar: "¿Deja de respirar?",
            despierta_cansado: "¿Despierta cansado?",
            se_siente_mal: "¿Fatiga diurna?",
            se_quedo_dormido: "¿Se durmió conduciendo?",
            se_quedo_dormido_frecuencia: "Frecuencia al conducir",
            hipertension: "¿Hipertensión?"
        },
        psqi: {
            // Datos básicos
            hora_acostarse: "Hora habitual de acostarse",
            tiempo_dormir: "Tiempo para conciliar el sueño",
            hora_levantarse: "Hora habitual de levantarse",
            horas_sueno: "Horas de sueño reales",
            
            // Perturbaciones (Alteraciones)
            alteracion_1: "No poder dormir en 30 min",
            alteracion_2: "Despertar a media noche/madrugada",
            alteracion_3: "Tener que ir al baño",
            alteracion_4: "No poder respirar bien",
            alteracion_5: "Tos o ronquidos",
            alteracion_6: "Sentir frío",
            alteracion_7: "Sentir calor",
            alteracion_8: "Tener pesadillas",
            alteracion_9: "Sentir dolor",
            
            // Otra causa
            otra_causa: "Otra causa de alteración (descripción)",
            frecuencia_otra_alteracion: "Frecuencia de otra causa",
            
            // Hábitos y Funcionalidad
            calidad_sueno: "Calidad subjetiva del sueño",
            tomo_medicinas: "Uso de medicinas para dormir",
            dificultad_despierto: "Dificultad para mantenerse despierto",
            problema_entusiasmo: "Problema de entusiasmo/ánimo",
            
            // Pareja / Compañero
            pareja_companero: "Presencia de compañero de cama",
            compañero_1: "Pareja: Ronquidos fuertes",
            compañero_2: "Pareja: Pausas respiratorias",
            compañero_3: "Pareja: Movimientos de piernas",
            compañero_4: "Pareja: Desorientación/Confusión",
            compañero_5: "Pareja: Otro trastorno",
            otra_transtorno: "Desc. trastorno pareja",

            // Datos Extra
            horas_sueno_estudio: "Horas Sueño (Dato Estudio Médico)",
            puntaje: "Puntaje Global PSQI"
        }
    };

    const savedScroll = sessionStorage.getItem('scrollPos');
    
    if (savedScroll) {
        window.scrollTo({
            top: parseInt(savedScroll),
            behavior: 'instant'
        });
        sessionStorage.removeItem('scrollPos');
    }

    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', () => {
            sessionStorage.setItem('scrollPos', window.scrollY.toString());
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link');
        const navElement = document.getElementById('dynamic-nav');
        const sentinelElement = document.getElementById('nav-sentinel');

        const container = document.getElementById('modal-extras-container');
        const btnAdd = document.getElementById('btn-add-extra-modal');

        const modalSeguimiento = document.getElementById('modal-seguimiento');
        const btnNuevaNota = document.getElementById('btn-nueva-nota');
        const formSeguimiento = modalSeguimiento?.querySelector('form');
        
        const inputAction = document.getElementById('seguimiento-action');
        const inputId = document.getElementById('seguimiento-id');
        const inputFecha = document.getElementById('seguimiento-fecha');
        const inputTexto = document.getElementById('seguimiento-texto');
        const modalTitulo = document.getElementById('modal-seguimiento-titulo');
        const modalBorrarObs = document.getElementById('modal-eliminar-observacion');
        const inputIdBorrar = document.getElementById('input-id-borrar-observacion');

        const activateLink = (id) => {
            navLinks.forEach(link => {
                // 1. Limpiamos todos
                link.classList.remove('active');
                
                // 2. Activamos solo el correcto
                if (link.getAttribute('href') === `#${id}`) {
                    link.classList.add('active');
                    
                    // 3. Mover el menú horizontalmente para centrar el botón
                    link.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest', 
                        inline: 'center' 
                    });
                }
            });
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Obtenemos el ID del destino (ej: "tms")
                const targetId = link.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);

                if (targetSection) {
                    // A. Scroll suave en la página
                    targetSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });

                    // B. Actualizar URL
                    history.pushState(null, null, `#${targetId}`);
                    
                    // C. Forzar la activación visual INMEDIATAMENTE (sin esperar al scroll)
                    activateLink(targetId); 
                }
            });
        });

        const sectionObserverOptions = {
            root: null,
            rootMargin: '-40% 0px -60% 0px',
            threshold: 0
        };

        const sectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    activateLink(entry.target.id);
                }
            });
        }, sectionObserverOptions);

        sections.forEach(section => sectionObserver.observe(section));

        if (navElement && sentinelElement) {
            const handler = (entries) => {
                if (!entries[0].isIntersecting) {
                    navElement.setAttribute('data-state', 'floating');
                } else {
                    navElement.removeAttribute('data-state');
                }
            };

            const observer = new IntersectionObserver(handler, {
                root: null,
                threshold: 0,
                rootMargin: "50px 0px 0px 0px" 
            });

            observer.observe(sentinelElement);
        }

        // Abrir para crear
        if (btnNuevaNota && modalSeguimiento) {
            btnNuevaNota.addEventListener('click', () => {
                formSeguimiento?.reset();
                if(inputAction) inputAction.value = 'add_seguimiento';
                if(inputId) inputId.value = '';
                if(inputFecha) (inputFecha).valueAsDate = new Date();
                if(modalTitulo) modalTitulo.textContent = 'Agregar Nota';
                (modalSeguimiento).showModal();
            });
        }

        // Abrir para editar
        document.addEventListener('click', (e) => {
            const btn = (e.target).closest('.btn-editar-nota');
            if (btn && modalSeguimiento) {
                const id = btn.getAttribute('data-id');
                const fecha = btn.getAttribute('data-fecha');
                const texto = btn.getAttribute('data-texto');

                if (id) {
                    if(inputAction) inputAction.value = 'edit_seguimiento';
                    if(inputId) inputId.value = id;
                    if(inputFecha) inputFecha.value = fecha || '';
                    if(inputTexto) inputTexto.value = texto || '';
                    if(modalTitulo) modalTitulo.textContent = 'Editar Nota';
                    modalSeguimiento.showModal();
                }
            }

            const btnBorrar = (e.target).closest('.btn-borrar-nota');
            if (btnBorrar && modalBorrarObs) {
                const id = btnBorrar.getAttribute('data-id');
                if (id && inputIdBorrar) {
                    (inputIdBorrar).value = id;
                    (modalBorrarObs).showModal();
                }
            }
        });

        // Función para eliminar fila
        const setupRemoveBtn = (btn) => {
            btn.addEventListener('click', (e) => {
                (e.target).closest('.extra-row')?.remove();
            });
        };

        // Configurar botones existentes (los que vienen del servidor)
        document.querySelectorAll('.btn-remove-extra').forEach(setupRemoveBtn);

        // Agregar nueva fila
        if (btnAdd && container) {
            btnAdd.addEventListener('click', () => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-2 items-center extra-row bg-gray-800/30 p-2 rounded';
                row.innerHTML = `
                    <div class="col-span-3">
                        <input type="text" name="extra_prueba_nombre" placeholder="Nombre" class="bg-transparent border-b border-gray-600 text-white w-full text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="col-span-3"><input type="number" name="extra_prueba_pre" placeholder="Pre" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-center text-sm w-full"></div>
                    <div class="col-span-3"><input type="number" name="extra_prueba_inter" placeholder="Inter" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-center text-sm w-full"></div>
                    <div class="col-span-2"><input type="number" name="extra_prueba_post" placeholder="Post" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-center text-sm w-full"></div>
                    <div class="col-span-1 text-center"><button type="button" class="text-red-400 btn-remove-extra">✕</button></div>
                `;
                container.appendChild(row);
                const newBtn = row.querySelector('.btn-remove-extra');
                if(newBtn) setupRemoveBtn(newBtn);
            });
        }

        const selectSitio = document.getElementById('select-sitio');
        const freqSimple = document.getElementById('freq-simple');
        const freqBilateral = document.getElementById('freq-bilateral');

        if (selectSitio && freqSimple && freqBilateral) {
            const toggle = () => {
                const esBilateral = selectSitio.value === 'Bilateral';
                if (esBilateral) {
                    freqSimple.classList.remove('block');
                    freqSimple.classList.add('hidden');
                    freqSimple.querySelectorAll('select').forEach(s => s.disabled = true);

                    freqBilateral.classList.remove('hidden');
                    freqBilateral.classList.add('grid');
                    freqBilateral.querySelectorAll('select').forEach(s => s.disabled = false);
                } else {
                    freqBilateral.classList.remove('grid');
                    freqBilateral.classList.add('hidden');
                    freqBilateral.querySelectorAll('select').forEach(s => s.disabled = true);

                    freqSimple.classList.remove('hidden');
                    freqSimple.classList.add('block');
                    freqSimple.querySelectorAll('select').forEach(s => s.disabled = false);
                }
            };
            selectSitio.addEventListener('change', toggle);
            toggle();
        }
    });

    let currentFase = 'pre';
    
    // Referencias a los inputs de links
    const inputs = {
        epworth: document.getElementById('link-epworth'),
        berlin: document.getElementById('link-berlin'),
        psqi: document.getElementById('link-psqi'),
    };

    // Referencias a las filas completas (para ocultar link y mostrar botón)
    const rows = {
        epworth: document.getElementById('row-epworth'),
        berlin: document.getElementById('row-berlin'),
        psqi: document.getElementById('row-psqi'),
    };
    
    window.setFase = (fase) => {
        currentFase = fase;

        const urlEpworth = `${baseUrl}/cuestionarios/epworth/${token}?fase=${fase}`;
        const urlBerlin = `${baseUrl}/cuestionarios/berlin/${token}?fase=${fase}`;
        const urlPsqi = `${baseUrl}/cuestionarios/psqi/${token}?fase=${fase}`;

        inputs.epworth.value = urlEpworth;
        inputs.berlin.value = urlBerlin;
        inputs.psqi.value = urlPsqi;

        const textareaWpp = document.getElementById('texto-plantilla-wpp');
        if (textareaWpp) {
            textareaWpp.value = `Buen día. Soy ${nombreAutor}, del laboratorio del sueño y neurociencias de la UADY. Estos son los formularios para complementar el estudio de Apnea. Si tiene oportunidad de contestarlo con alguien más, por si hay algún dato que desconoce y alguien más pueda ayudarlo a responder.\n\nAquí le dejo los links:\n\nIndice de calidad de sueño de pitsburgh:\n${urlPsqi}\n\nCuestionario Berlin:\n${urlBerlin}\n\nEscala Epworth de somnolencia:\n${urlEpworth}`;
        }

        ['pre', 'inter', 'post'].forEach(f => {
            const btn = document.getElementById(`btn-${f}`);
            if(btn) {
                btn.className = f === fase 
                    ? "px-4 py-1.5 rounded-md text-sm font-medium transition-all bg-blue-600 text-white shadow"
                    : "px-4 py-1.5 rounded-md text-sm font-medium transition-all text-gray-400 hover:text-white";
            }
        });

        ['epworth', 'berlin', 'psqi'].forEach(cuestionario => {
            const row = rows[cuestionario];
            if(!row) return;

            const containerLink = row.querySelector('.container-link');
            const containerBtn = row.querySelector('.container-btn');

            const respuesta = respuestasGuardadas.find(r => r.cuestionario === cuestionario && r.fase === fase);

            if (respuesta) {
                // SÍ HAY RESPUESTA
                containerLink.classList.add('hidden');
                containerBtn.classList.remove('hidden');
            } else {
                // NO HAY RESPUESTA
                containerLink.classList.remove('hidden');
                containerBtn.classList.add('hidden');
            }
        });
    }

    // Función para abrir el modal con los datos
    window.verRespuestas = (cuestionario) => {
        const respuesta = respuestasGuardadas.find(r => r.cuestionario === cuestionario && r.fase === currentFase);
        if (!respuesta || !respuesta.datos) return;

        const modal = document.getElementById('modal-ver-respuestas');
        const titulo = document.getElementById('titulo-ver-respuestas');
        const subtitulo = document.getElementById('subtitulo-ver-respuestas');
        const badgeFase = document.getElementById('badge-fase');
        const contenido = document.getElementById('contenido-respuestas');
        const modalLinkInput = document.getElementById('modal-link-input');

        // Configuración de Textos y Colores
        titulo.textContent = cuestionario.charAt(0).toUpperCase() + cuestionario.slice(1);
        subtitulo.textContent = new Date(respuesta.updated_at).toLocaleDateString('es-MX', { 
            weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
        });

        const colorMap = { pre: 'blue', inter: 'purple', post: 'emerald' };
        const color = colorMap[currentFase] || 'gray';
        
        badgeFase.textContent = currentFase.toUpperCase();
        badgeFase.className = `text-[10px] px-2 py-0.5 rounded-full border uppercase tracking-wider font-bold bg-${color}-500/10 text-${color}-400 border-${color}-500/20`;

        const fullLink = `${baseUrl}/cuestionarios/${cuestionario}/${token}?fase=${currentFase}`;
        if(modalLinkInput) modalLinkInput.value = fullLink;

        let html = '';
        const datos = respuesta.datos;
        const preguntas = DICCIONARIOS[cuestionario] || {};

        // 1. SECCIÓN DE PUNTAJE (Banner Superior)
        if (datos.puntaje !== undefined) {
            html += `
                <div class="px-6 py-5 bg-gradient-to-r from-gray-800/50 to-gray-900 border-b border-gray-700 flex items-center justify-between">
                    <div>
                        <p class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-1">Puntaje Total</p>
                        <p class="text-gray-500 text-xs">Cálculo automático</p>
                    </div>
                    <div class="flex flex-col items-end">
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-mono font-bold text-white">${datos.puntaje}</span>
                            <span class="text-xs text-gray-500 font-medium uppercase">pts</span>
                        </div>
            `;
            
            // --- LÓGICA ESPECÍFICA PARA BERLIN: RESUMEN DE CATEGORÍAS ---
            if (cuestionario === 'berlin') {
                let cats = [];
                // Buscamos en el JSON las claves que guardamos desde calculos.ts
                if (datos["Resultado Categoría 1 (Ronquido)"]?.includes("POSITIVA")) cats.push("1");
                if (datos["Resultado Categoría 2 (Somnolencia)"]?.includes("POSITIVA")) cats.push("2");
                if (datos["Resultado Categoría 3 (Presión/IMC)"]?.includes("POSITIVA")) cats.push("3");

                const textoCats = cats.length > 0 ? cats.join(", ") : "Ninguna";
                const colorTexto = cats.length > 0 ? "text-red-400" : "text-gray-400";

                // Agregamos el resumen justo debajo del puntaje
                html += `
                        <div class="mt-1 text-right">
                            <span class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mr-1">Categorías Positivas:</span>
                            <span class="text-sm font-bold ${colorTexto}">${textoCats}</span>
                        </div>
                `;
            }
            
            html += `
                    </div>
                </div>
            `;
        }

        // 2. DETALLES ESPECÍFICOS
        // Definimos claves que NO queremos mostrar en la lista normal porque son de lógica interna
        const clavesOcultas = [
            "puntaje", 
            "Categoría 1 (Ronquido)", 
            "Categoría 2 (Somnolencia)", 
            "Categoría 3 (Hipertensión/IMC)",
            "Riesgo Global"
        ];

        for (const key in datos) {
            if (clavesOcultas.includes(key)) continue;

            const textoPregunta = preguntas[key] || key;
            const valorRespuesta = datos[key];

            html += `
                <div class="px-6 py-4 flex flex-col md:flex-row md:items-center justify-between gap-2 hover:bg-white/5 transition-colors group border-b border-gray-800/30 last:border-0">
                    <div class="md:w-3/4">
                        <p class="text-gray-300 text-sm font-medium leading-snug group-hover:text-white transition-colors">
                            ${textoPregunta}
                        </p>
                    </div>
                    <div class="md:w-1/4 flex justify-end">
                        <span class="inline-block bg-gray-900 border border-gray-700 text-gray-300 px-3 py-1.5 rounded text-xs font-mono font-bold text-center min-w-[3rem]">
                            ${valorRespuesta}
                        </span>
                    </div>
                </div>
            `;
        }

        contenido.innerHTML = html;
        modal.showModal();
    }

    window.copiarMensajeWpp = () => {
        const textarea = document.getElementById('texto-plantilla-wpp');
        const btn = document.getElementById('btn-copiar-plantilla');
        
        // Seleccionar y copiar el texto
        textarea.select();
        navigator.clipboard.writeText(textarea.value);
        
        // Feedback visual
        const originalHtml = btn.innerHTML;
        btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg> ¡Mensaje Copiado!`;
        btn.classList.remove('bg-green-600', 'hover:bg-green-500');
        btn.classList.add('bg-emerald-500');
        
        // Restaurar botón después de 2 segundos
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('bg-emerald-500');
            btn.classList.add('bg-green-600', 'hover:bg-green-500');
        }, 2000);
    }

    window.copiarLink = (inputId) => {
        const input = document.getElementById(inputId);
        input.select();
        navigator.clipboard.writeText(input.value);
        
        // Efecto visual de copiado
        const parent = input.parentElement;
        parent.classList.add('bg-blue-900/30', 'border-blue-500');
        setTimeout(() => parent.classList.remove('bg-blue-900/30', 'border-blue-500'), 200);
    }

    window.copiarLinkModal = () => {
        const input = document.getElementById('modal-link-input');
        const btn = document.getElementById('btn-copiar-modal');
        
        input.select();
        navigator.clipboard.writeText(input.value);
        
        // Feedback visual en el botón
        const textoOriginal = btn.innerText;
        btn.innerText = "¡Copiado!";
        btn.classList.add('text-green-400');
        
        setTimeout(() => {
            btn.innerText = textoOriginal;
            btn.classList.remove('text-green-400');
        }, 1500);
    }

    // Función para abrir el modal de ajuste de estudio
    window.abrirModalEstudio = () => {
        const respuesta = respuestasGuardadas.find(r => r.cuestionario === 'psqi' && r.fase === currentFase);
        
        if (!respuesta) return;

        const modal = document.getElementById('modal-psqi-estudio');
        const inputFase = document.getElementById('input-fase-estudio');
        const inputHoras = document.getElementById('input-horas-estudio');

        // Configurar valores
        inputFase.value = currentFase;
        
        // Buscar si ya hay un valor previo guardado en el JSON
        const horasPrevias = respuesta.datos.horas_sueno_estudio;
        inputHoras.value = horasPrevias ? horasPrevias : '';

        modal.showModal();
    }

    // Inicializar
    setFase('pre');
</script>