---
/**
 * @file paciente/animo/[id].astro
 * @description Expediente Clínico específico para pacientes de Estado de Ánimo.
 * Adaptado para mostrar escalas psiquiátricas y ocultar métricas de sueño profundo.
 */

import Layout from "../../../layouts/Layout.astro"
import ReturnButton from "../../../components/ReturnButton.astro"
import InfoCard from "../../../components/InfoCard.astro"
import { createClient } from "@supabase/supabase-js"

let mensaje = "";
const msgParam = Astro.url.searchParams.get('mensaje');

const GROUPS_TRASTORNOS = [
    {
        categoria: "Ansiedad, TOC y Trauma",
        opciones: [
            "Ansiedad generalizada",
            "Ansiedad inducida por sustancia o medicamento",
            "Ansiedad debida a afección médica",
            "Ansiedad por enfermedad",
            "TOC",
            "Dismórfico corporal",
            "TEPT"
        ]
    },
    {
        categoria: "Espectro Esquizofrénico y Psicótico",
        opciones: [
            "Esquizofreniforme",
            "Esquizoafectivo",
            "Esquizofrenia (Paranoide, catatónica, desorganizada, indiferenciada, simple)",
            "Psicótico breve",
            "Delirante (Erotomaníaco, celotípico, grandeza, mixto, persecutorio, somático, no especificado)",
        ]
    },
    {
        categoria: "Bipolar y Depresivos",
        opciones: [
            "Bipolar I (Predominan episodios maníacos)",
            "Bipolar II (Predominan episodios depresivos)",
            "Ciclotímico: Cíclico, tiempo especifico",
            "Depresión mayor",
            "Distimia",
            "Disfórico premenstrual"
        ]
    },
    {
        categoria: "Conducta Alimentaria y Sustancias",
        opciones: [
            "Anorexia",
            "Bulimia",
            "Atracones",
            "Consumo de sustancias"
        ]
    }
];

const { id } = Astro.params;
if (!id) return Astro.redirect("/lista");

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

const user = await Astro.locals.currentUser();
const nombreAutor = user 
? `${user.firstName} ${user.lastName}`.trim() || user.username 
: "Sistema";

if (msgParam === 'tms_guardado') mensaje = "Sesión TMS registrada correctamente.";
if (msgParam === 'puntajes_actualizados') mensaje = "Los puntajes se han actualizado.";
if (msgParam === 'seguimiento_guardado') mensaje = "Seguimiento registrado exitosamente.";
if (msgParam === 'nota_guardada') mensaje = "Nota clínica guardada.";
if (msgParam === 'error') mensaje = "Ocurrió un error al procesar la solicitud.";

// --- LÓGICA DE ACCIONES (POST) ---
// Mantenemos la lógica vital (TMS, Seguimiento) pero limpiamos lo de sueño.
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const action = formData.get("action");

        // 1. NOTAS DE SEGUIMIENTO
        if (action === "add_seguimiento") {
            const nuevaNota = {
                paciente_id: id,
                fecha: formData.get("fecha") ? new Date(formData.get("fecha") as string).toISOString() : new Date().toISOString(),
                observacion: formData.get("observacion"),
                registrado_por: nombreAutor
            };
            const { error } = await supabase.from('pacientes_seguimiento').insert([nuevaNota]);
            if (!error) {
                return Astro.redirect(Astro.url.pathname + "?mensaje=seguimiento_guardado");
            } else {
                mensaje = "Error al guardar";
            }
        }

        if (action === "delete_seguimiento") {
            const idNota = formData.get("id_seguimiento");
            const { error } = await supabase.from('pacientes_seguimiento').delete().eq('id', idNota);
            if (error) throw error;
        }

        // 2. ELIMINAR PACIENTE
        if (action === "delete_patient") {
            const { error } = await supabase.from('pacientes').delete().eq('id', id);
            if (error) throw error;
            return Astro.redirect("/lista?mensaje=eliminado");
        }

        // 3. ACTUALIZAR PUNTAJES (Solo escalas de Ánimo)
        if (action === "update_scores") {
            const getInt = (key: string) => {
                const val = formData.get(key);
                return val && val.toString().trim() !== '' ? parseInt(val as string) : null;
            };
            
            // Lista filtrada para Ánimo
            const scoresList = ['hamilton_d', 'hamilton_a', 'isi', 'beck', 'banfe', 'eva'];
            
            let puntajesActualizados: any = {};
            scoresList.forEach(score => {
                puntajesActualizados[`${score}_pre`] = getInt(`${score}_pre`);
                puntajesActualizados[`${score}_inter`] = getInt(`${score}_inter`);
                puntajesActualizados[`${score}_post`] = getInt(`${score}_post`);
            });

            const { error: updateError } = await supabase.from('pacientes').update(puntajesActualizados).eq('id', id);
            if (updateError) throw updateError;

            // Puntajes Extra
            await supabase.from('pacientes_puntajes_extra').delete().eq('paciente_id', id);
            const extraNombres = formData.getAll('extra_prueba_nombre');
            const extraPre = formData.getAll('extra_prueba_pre');
            const extraInter = formData.getAll('extra_prueba_inter');
            const extraPost = formData.getAll('extra_prueba_post');

            const extrasAInsertar = extraNombres.map((nombre, index) => ({
                paciente_id: id,
                nombre_prueba: nombre.toString(),
                puntaje_pre: extraPre[index] ? parseInt(extraPre[index].toString()) : null,
                puntaje_inter: extraInter[index] ? parseInt(extraInter[index].toString()) : null,
                puntaje_post: extraPost[index] ? parseInt(extraPost[index].toString()) : null
            })).filter(item => item.nombre_prueba.trim() !== '');

            if (extrasAInsertar.length > 0) {
                await supabase.from('pacientes_puntajes_extra').insert(extrasAInsertar);
                return Astro.redirect(`${Astro.url.pathname}?mensaje=puntajes_actualizados`);
            }
        }

        if (action === "habilitar_tms") {
            const { error } = await supabase.from('pacientes').update({ tms_habilitado: true }).eq('id', id);
            if (error) console.error("Error habilitando TMS:", error);
        }

        if (action === "nueva_sesion_tms") {
            const getInt = (k: string) => {
                const v = formData.get(k);
                return v && v.toString().trim() ? parseInt(v.toString()) : null;
            };
            const getStr = (k: string) => {
                const v = formData.get(k);
                return v ? v.toString().trim() : null;
            };

            const sitio = getStr("sitio_estimulacion");
            
            let freqMain = null;
            let freqRight = null;

            if (sitio === "Bilateral") {
                freqMain = getStr("frecuencia_izq");
                freqRight = getStr("frecuencia_der");
            } else {
                freqMain = getStr("frecuencia");
            }

            const { error } = await supabase.from('tms_sesiones').insert({
                paciente_id: id,
                fecha_aplicacion: formData.get("fecha"),
                observaciones: formData.get("observaciones"),
                
                umbral_motor: getInt("umbral_motor"),
                intensidad_tratamiento: getInt("intensidad_tratamiento"),
                total_pulsos: getInt("total_pulsos"),
                sitio_estimulacion: sitio,
                protocolo: getStr("protocolo"),

                frecuencia: freqMain,
                frecuencia_derecha: freqRight
            });
            
            if (error) {
                console.error("Error creando sesión:", error);
            } else {
                return Astro.redirect(`${Astro.url.pathname}?mensaje=tms_guardado`);
            }
        }

        if (action === "subir_consentimiento_tms") {
            const archivo = formData.get("archivo_pdf");
            if (archivo && archivo instanceof File && archivo.size > 0) {
                const filePath = `${id}/consentimiento_tms.pdf`;
                const { error: uploadError } = await supabase.storage.from('expedientes').upload(filePath, archivo, { upsert: true, contentType: 'application/pdf' });
                if (!uploadError) {
                    await supabase.from('pacientes').update({ tms_consentimiento_url: filePath }).eq('id', id);
                }
            }
        }

    } catch (error) {
        console.error("Error en acción:", error);
    }
}

// --- CONSULTA DE DATOS ---
const { data: paciente, error } = await supabase
    .from('pacientes')
    .select(`
        id, created_at, nombre, registrado_por, fecha_nacimiento, edad, telefono, genero, ocupacion, escolaridad, referencia,
        acompanante_nombre, acompanante_telefono, acompanante_parentesco,
        referido_por_nombre, referido_por_telefono, referido_por_correo,
        motivo, antecedentes,
        ejercicio, horas_ejercicio, alcohol, cervezas_semana, fuma, cigarros_semana, cafe, tazas_cafe_semana,
        ideacion_suicida, ideacion_suicida_desc, planeacion_suicida, planeacion_suicida_desc, intento_suicida, intento_suicida_desc,
        trastornos_animo,
        farmacos_nombres, farmacos_dosis, farmacos_motivos, farmacos_frecuencias, farmacos_tiempos,
        tms_habilitado, tms_consentimiento_url,
        hamilton_d_pre, hamilton_d_inter, hamilton_d_post,
        hamilton_a_pre, hamilton_a_inter, hamilton_a_post,
        isi_pre, isi_inter, isi_post,
        beck_pre, beck_inter, beck_post,
        banfe_pre, banfe_inter, banfe_post,
        eva_pre, eva_inter, eva_post,
        pacientes_sintomas(*),
        pacientes_puntajes_extra(*),
        pacientes_seguimiento(*),
        tms_sesiones(*)
    `)
    .eq('id', id)
    .order('created_at', { foreignTable: 'tms_sesiones', ascending: false })
    .single();

if (error || !paciente) return Astro.redirect("/lista");

// Ordenar listas
if (paciente.pacientes_seguimiento) paciente.pacientes_seguimiento.sort((a: any, b: any) => new Date(b.fecha).getTime() - new Date(a.fecha).getTime());

// Link PDF seguro
let urlConsentimientoFirmado = null;
if (paciente?.tms_consentimiento_url) {
    const { data: signedData } = await supabase.storage.from('expedientes').createSignedUrl(paciente.tms_consentimiento_url, 3600);
    urlConsentimientoFirmado = signedData?.signedUrl;
}

// Helpers visuales
const formatDate = (dateString: string) => {
    if (!dateString) return "No registrado";
    const fechaLimpia = dateString.substring(0, 10);
    
    return new Date(fechaLimpia + 'T12:00:00').toLocaleDateString('es-MX', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
};

const formatDateShort = (dateString: string) => {
    if (!dateString) return "";
    const fechaLimpia = dateString.substring(0, 10);
    return new Date(fechaLimpia + 'T12:00:00').toLocaleDateString('es-MX', { 
        day: '2-digit', 
        month: 'short', 
        year: 'numeric' 
    });
};
const edadDisplay = paciente.edad || (paciente.fecha_nacimiento ? new Date().getFullYear() - new Date(paciente.fecha_nacimiento).getFullYear() : "N/A");
const sesionesTMS = paciente?.tms_sesiones || [];
const ultimaConfig = sesionesTMS.length > 0 ? sesionesTMS[0] : {};
---

<Layout title={`Expediente Ánimo: ${paciente.nombre}`}>
    <ReturnButton href="/lista" text="Volver a la lista" />

    <main class="max-w-6xl mx-auto pt-20 pb-28 px-4">
        
        <div class="border-b-2 border-blue-500/30 pb-6 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <p class="text-purple-400 text-sm font-bold uppercase tracking-widest mb-2">Expediente de Estado de Ánimo</p>
                <h1 class="text-4xl md:text-5xl font-extrabold capitalize text-white">{paciente.nombre}</h1>
                <div class="flex gap-4 mt-2 text-gray-400 text-sm items-center">
                    <span>ID: #{paciente.id}</span>
                    <span>•</span>
                    <span>Registrado: {formatDate(paciente.created_at)}</span>
                    <span>•</span>
                    <a href={`/editar-paciente/animo/${paciente.id}`} class="text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                        Editar Expediente Completo
                    </a>
                </div>
            </div>
            <div class="text-right">
                <span class="block text-gray-500 text-xs uppercase tracking-wider mb-1">Registrado por</span>
                <span class="bg-gray-800 px-3 py-1 rounded-full text-sm text-gray-300 border border-gray-700">
                    {paciente.registrado_por || "Sistema"}
                </span>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-8">
            <div class="relative w-full max-w-6xl mx-auto">
                <div id="nav-sentinel" class="absolute -top-12 left-0 w-full h-px pointer-events-none opacity-0"></div>
            </div>
            <nav id="dynamic-nav" class="sticky top-6 z-50 mb-12 flex items-center justify-between gap-1 overflow-hidden
                transition-all duration-500 cubic-bezier(0.25, 0.8, 0.25, 1) mx-auto
                
                w-full max-w-6xl rounded-2xl bg-gray-900/0 border border-transparent p-0 backdrop-blur-none shadow-none
                
                data-[state='floating']:max-w-[650px]
                data-[state='floating']:bg-[#0f172a]/80 
                data-[state='floating']:backdrop-blur-xl 
                data-[state='floating']:border-white/10 
                data-[state='floating']:rounded-full 
                data-[state='floating']:p-1.5
                data-[state='floating']:shadow-[0_10px_40px_-10px_rgba(0,0,0,0.5)]">
                
                <div class="w-full flex items-center gap-1 overflow-x-auto no-scrollbar scroll-smooth">
                    <a href="#sociodemo" class="nav-link active">SocioDemográficos</a>
                    <a href="#acompa" class="nav-link">Acompañante</a>
                    <a href="#especialista" class="nav-link">Especialista</a>
                    <a href="#diagnostico" class="nav-link">Diagnostico</a>
                    <a href="#historia" class="nav-link">Historia Clínica</a>
                    <a href="#sintomas" class="nav-link">Sintomas Latentes</a>
                    <a href="#trastorno" class="nav-link">Trastornos</a>
                    <a href="#farmacos" class="nav-link">Farmacos</a>
                    <a href="#puntajes" class="nav-link">Puntajes</a>
                    <a href="#tms" class="nav-link">TMS</a>
                    <a href="#seguimiento" class="nav-link">Seguimiento</a>
                </div>
            </nav>

            <section id="sociodemo" class="scroll-mt-32">
                <InfoCard title="SocioDemográficos">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div><span class="label">Fecha de Nacimiento</span><p class="value">{formatDate(paciente.fecha_nacimiento)} <span class="text-gray-500 text-sm">({edadDisplay} años)</span></p></div>
                        <div>
                            <span class="label">Teléfono</span>
                            {paciente.telefono ? (
                                <a href={`https://wa.me/52${paciente.telefono.replace(/\D/g, '')}`} target="_blank" rel="noopener noreferrer" class="value font-mono text-blue-300 hover:text-green-400 hover:underline flex items-center gap-2 w-fit transition-colors group">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-whatsapp transition-transform group-hover:scale-110" viewBox="0 0 16 16"><path d="M13.601 2.326A7.854 7.854 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.933 7.933 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.729.729 0 0 0-.529.247c-.182.198-.691.677-.691 1.654 0 .977.71 1.916.81 2.049.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232z"/></svg>
                                    {paciente.telefono}
                                </a>
                            ) : <p class="value font-mono text-gray-500">—</p>}
                        </div>
                        <div><span class="label">Género</span><p class="value capitalize">{paciente.genero}</p></div>
                        <div><span class="label">Ocupación</span><p class="value">{paciente.ocupacion || "—"}</p></div>
                        <div><span class="label">Escolaridad</span><p class="value">{paciente.escolaridad || "—"}</p></div>
                        <div><span class="label">Referido por</span><p class="value">{paciente.referencia}</p></div>
                    </div>
                </InfoCard>
            </section>

            <section id="acompa" class="scroll-mt-32">
                <InfoCard title="Acompañante / Responsable">
                    {paciente.acompanante_nombre ? (
                        <div class="space-y-4">
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <span class="label">Nombre Completo</span>
                                    <p class="value">{paciente.acompanante_nombre}</p>
                                </div>
                                <div>
                                    <span class="label">Contacto</span>
                                    <a href={`tel:${paciente.acompanante_telefono}`} class="value text-blue-300 hover:underline flex items-center gap-1">
                                        {paciente.acompanante_telefono}
                                    </a>
                                </div>
                                <div>
                                    <span class="label">Parentesco</span>
                                    <span class="inline-block bg-blue-900/30 text-blue-300 px-2 py-1 rounded text-sm border border-blue-500/20">
                                        {paciente.acompanante_parentesco}
                                    </span>
                                </div>
                            </div>
                        </div>
                    ) : (
                        <div class="flex items-center justify-center text-gray-500 italic">
                            Sin acompañante registrado.
                        </div>
                    )}
                </InfoCard>
            </section>

            <section id="especialista" class="scroll-mt-32">
                <InfoCard title="Referenciado Por (Especialista)">
                    {paciente.referido_por_nombre ? (
                        <div class="space-y-4">
                            
                            <div>
                                <span class="label block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Nombre del Especialista</span>
                                <p class="text-lg font-medium text-white flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                                    {paciente.referido_por_nombre}
                                </p>
                            </div>
    
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-gray-700/50 pt-3 mt-2">
                                
                                <div>
                                    <span class="label block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Contacto Telefónico</span>
                                    {paciente.referido_por_telefono ? (
                                        <a href={`tel:${paciente.referido_por_telefono}`} class="text-blue-300 hover:text-blue-200 hover:underline flex items-center gap-2 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" /></svg>
                                            {paciente.referido_por_telefono}
                                        </a>
                                    ) : <span class="text-gray-500 text-sm italic">— No registrado —</span>}
                                </div>
    
                                <div>
                                    <span class="label block text-xs font-medium text-gray-500 uppercase tracking-wider mb-1">Correo Electrónico</span>
                                    {paciente.referido_por_correo ? (
                                        <a href={`mailto:${paciente.referido_por_correo}`} class="text-blue-300 hover:text-blue-200 hover:underline flex items-center gap-2 transition-colors">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 opacity-70" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
                                            {paciente.referido_por_correo}
                                        </a>
                                    ) : <span class="text-gray-500 text-sm italic">— No registrado —</span>}
                                </div>
    
                            </div>
                        </div>
                    ) : (
                        <div class="h-20 flex items-center justify-center text-gray-500 italic text-sm border border-dashed border-gray-700 rounded-lg">
                            Sin información de referencia.
                        </div>
                    )}
                </InfoCard>
            </section>

            <section id="diagnostico" class="scroll-mt-32">
                <InfoCard title="Diagnostico">
                    <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700/50">
                        <p class="text-gray-200 text-lg leading-relaxed whitespace-pre-wrap">{paciente.motivo}</p>
                    </div>
                </InfoCard>
            </section>

            <section id="historia" class="scroll-mt-32">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <InfoCard title="Historia Clínica">
                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700/50 min-h-[100px]"><p class="text-gray-300 italic leading-relaxed text-sm">{paciente.antecedentes || 'No se han registrado antecedentes.'}</p></div>
                    </InfoCard>
    
                    <InfoCard title="Estilo de Vida y Sustancias">
                        <ul class="space-y-3">
                            <li class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-400">Ejercicio</span><span class="text-white font-medium">{paciente.ejercicio === 'si' ? `Sí (${paciente.horas_ejercicio}h/sem)` : 'No'}</span></li>
                            <li class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-400">Alcohol</span><span class="text-white font-medium">{paciente.alcohol === 'si' ? `${paciente.cervezas_semana} / semana` : 'No'}</span></li>
                            <li class="flex justify-between border-b border-gray-800 pb-2"><span class="text-gray-400">Tabaco</span><span class="text-white font-medium">{paciente.fuma === 'si' ? `${paciente.cigarros_semana} / semana` : 'No'}</span></li>
                            <li class="flex justify-between pb-1"><span class="text-gray-400">Café</span><span class="text-white font-medium">{paciente.cafe === 'si' ? `${paciente.tazas_cafe_semana} tazas/sem` : 'No'}</span></li>
                        </ul>
                    </InfoCard>
                </div>
            </section>

            <section id="sintomas" class="scroll-mt-32">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <InfoCard title="Síntomas Latentes">
                        {paciente.pacientes_sintomas && paciente.pacientes_sintomas.length > 0 ? (
                            <div class="flex flex-col gap-3">
                                {paciente.pacientes_sintomas.map((s: any, index: number) => (
                                    <div class="bg-blue-900/10 border border-blue-500/20 p-3 rounded-lg relative">
                                        <div class="absolute -top-2 -right-2 bg-blue-600 text-white text-[10px] px-2 py-0.5 rounded-full font-bold">#{index + 1}</div>
                                        <h4 class="text-base font-bold text-blue-200 capitalize mb-1">{s.sintoma}</h4>
                                        <div class="text-xs text-gray-400 flex gap-4">
                                            {s.gravedad && <span>Intensidad: {s.gravedad}</span>}
                                            {s.frecuencia && <span>Frec: {s.frecuencia}</span>}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div class="text-gray-500 italic py-4 text-center">No hay síntomas desglosados.</div>
                        )}
                    </InfoCard>
    
                    <InfoCard title="Riesgo Suicida">
                        <div class="space-y-4">
                            <div class={`p-3 rounded-lg border ${paciente.ideacion_suicida === 'si' ? 'bg-red-900/10 border-red-500/30' : 'bg-green-900/10 border-green-500/20'}`}>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-400 text-sm font-bold uppercase">Ideación Suicida</span>
                                    <span class={`font-bold ${paciente.ideacion_suicida === 'si' ? 'text-red-400' : 'text-green-400'}`}>
                                        {paciente.ideacion_suicida === 'si' ? 'PRESENTE' : 'AUSENTE'}
                                    </span>
                                </div>
                                {paciente.ideacion_suicida === 'si' && (
                                    <p class="text-red-200 text-sm mt-1 border-t border-red-500/20 pt-2">{paciente.ideacion_suicida_desc}</p>
                                )}
                            </div>
    
                            <div class={`p-3 rounded-lg border ${paciente.planeacion_suicida === 'si' ? 'bg-red-900/10 border-red-500/30' : 'bg-green-900/10 border-green-500/20'}`}>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-400 text-sm font-bold uppercase">Planeación Suicida</span>
                                    <span class={`font-bold ${paciente.planeacion_suicida === 'si' ? 'text-red-400' : 'text-green-400'}`}>
                                        {paciente.planeacion_suicida === 'si' ? 'PRESENTE' : 'AUSENTE'}
                                    </span>
                                </div>
                                {paciente.planeacion_suicida === 'si' && (
                                    <p class="text-red-200 text-sm mt-1 border-t border-red-500/20 pt-2">{paciente.planeacion_suicida_desc}</p>
                                )}
                            </div>
    
                            <div class={`p-3 rounded-lg border ${paciente.intento_suicida === 'si' ? 'bg-red-900/10 border-red-500/30' : 'bg-green-900/10 border-green-500/20'}`}>
                                <div class="flex justify-between items-center mb-1">
                                    <span class="text-gray-400 text-sm font-bold uppercase">Intentos Previos</span>
                                    <span class={`font-bold ${paciente.intento_suicida === 'si' ? 'text-red-400' : 'text-green-400'}`}>
                                        {paciente.intento_suicida === 'si' ? 'PRESENTE' : 'AUSENTE'}
                                    </span>
                                </div>
                                {paciente.intento_suicida === 'si' && (
                                    <p class="text-red-200 text-sm mt-1 border-t border-red-500/20 pt-2">{paciente.intento_suicida_desc}</p>
                                )}
                            </div>
                        </div>
                    </InfoCard>
                </div>
            </section>

            <section id="trastorno" class="scroll-mt-32">
                <div class="grid grid-cols-1 gap-8">
                    <InfoCard title="Trastornos del Ánimo">
                        {paciente.trastornos_animo && paciente.trastornos_animo.length > 0 ? (
                            <div class="flex flex-col gap-4">
                                {GROUPS_TRASTORNOS.map((grupo) => {
                                    const matches = grupo.opciones.filter(opcion => 
                                        paciente.trastornos_animo.includes(opcion)
                                    );
    
                                    if (matches.length === 0) return null;
                                    return (
                                        <div class="bg-gray-800/30 border border-white/5 rounded-xl p-3">
                                            <h4 class="text-[10px] font-bold text-white uppercase tracking-widest mb-3 border-b border-white/5 pb-2 flex items-center gap-2">
                                                {grupo.categoria}
                                            </h4>
                                            
                                            <div class="flex flex-wrap gap-2">
                                                {matches.map((t: string) => (
                                                    <span class="px-3 py-1.5 rounded-lg bg-blue-600/10 border border-blue-500/20 text-blue-200 text-sm font-medium hover:bg-blue-600/20 transition-colors">
                                                        {t}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
    
                                {(() => {
                                    const todosLosCatalogados = GROUPS_TRASTORNOS.flatMap(g => g.opciones);
                                    const sinCategoria = paciente.trastornos_animo.filter((t: string) => !todosLosCatalogados.includes(t));
                                    
                                    if (sinCategoria.length === 0) return null;
    
                                    return (
                                        <div class="bg-gray-800/30 border border-white/5 rounded-xl p-3">
                                            <h4 class="text-[10px] font-bold text-gray-500 uppercase tracking-widest mb-3 border-b border-white/5 pb-2">Otros / Sin clasificar</h4>
                                            <div class="flex flex-wrap gap-2">
                                                {sinCategoria.map((t: string) => (
                                                    <span class="px-3 py-1.5 rounded-lg bg-gray-700/30 border border-gray-600/30 text-gray-300 text-sm font-medium">
                                                        {t.replace(/_/g, ' ')}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        ) : (
                            <div class="text-center py-6 border border-dashed border-gray-700 rounded-xl bg-white/[0.02]">
                                <p class="text-gray-500 italic text-sm">No se han registrado diagnósticos específicos.</p>
                            </div>
                        )}
                    </InfoCard>
                </div>
            </section>

            <section id="farmacos" class="scroll-mt-32">
                <InfoCard title="Tratamiento Farmacológico Actual">
                    {paciente.farmacos_nombres && paciente.farmacos_nombres.length > 0 ? (
                        <div class="overflow-hidden rounded-xl border border-gray-700">
                            <table class="w-full text-left text-sm">
                                <thead class="text-blue-300">
                                    <tr>
                                        <th class="p-3 font-medium">Medicamento</th>
                                        <th class="p-3 font-medium">Motivo</th>
                                        <th class="p-3 font-medium">Dosis</th>
                                        <th class="p-3 font-medium text-center" title="Mañana - Tarde - Noche">Frecuencia (M-T-N)</th>
                                        <th class="p-3 font-medium text-right">Tiempo</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-800 bg-gray-900/30">
                                    {paciente.farmacos_nombres.map((nombre: string, i: number) => {
                                        const freqStr = paciente.farmacos_frecuencias?.[i] || '';
                                        
                                        const m = freqStr.includes('Mañana') ? '1' : '0';
                                        const t = freqStr.includes('Tarde') ? '1' : '0';
                                        const n = freqStr.includes('Noche') ? '1' : '0';
                                        const codigoFreq = `${m} - ${t} - ${n}`;
    
                                        return (
                                            <tr class="hover:bg-gray-800/50 transition-colors">
                                                <td class="p-3 text-white font-medium">{nombre}</td>
                                                <td class="p-3 text-gray-300">{paciente.farmacos_motivos?.[i] || '—'}</td>
                                                <td class="p-3 text-gray-300 font-mono text-xs">
                                                    {paciente.farmacos_dosis?.[i] || '—'}
                                                </td>
                                                <td class="p-3 text-center">
                                                    <span class="inline-block bg-blue-900/40 text-blue-300 border border-blue-500/20 px-2 py-1 rounded font-mono text-xs shadow-sm" title={freqStr}>
                                                        {codigoFreq}
                                                    </span>
                                                </td>
                                                <td class="p-3 text-right text-gray-400 font-mono">
                                                    {paciente.farmacos_tiempos && paciente.farmacos_tiempos[i] ? paciente.farmacos_tiempos[i] : '—'}
                                                </td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                    ) : (
                        <div class="flex items-center gap-2 text-gray-500 italic p-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" /></svg>
                            No reporta consumo de fármacos actualmente.
                        </div>
                    )}
                </InfoCard>
            </section>
            
            <section id="puntajes" class="scroll-mt-32">
                <InfoCard title="Puntajes y Escalas">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-400 text-sm">Resultados de las pruebas aplicadas al paciente.</p>
                        <button onclick="document.getElementById('modal-puntajes').showModal()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors cursor-pointer flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-3 h-3"><path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" /></svg>
                            Actualizar Puntajes
                        </button>
                    </div>
    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="text-gray-500 text-xs uppercase border-b border-gray-700/50">
                                    <th class="pb-2 font-medium">Escala</th>
                                    <th class="pb-2 text-center text-blue-400">Pre</th>
                                    <th class="pb-2 text-center text-purple-400">Inter</th>
                                    <th class="pb-2 text-center text-emerald-400">Post</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-800">
                                {['hamilton_d', 'hamilton_a', 'isi', 'beck', 'banfe', 'eva'].map(score => (
                                    <tr>
                                        <td class="py-3 pr-4 font-medium text-gray-300 capitalize">
                                            {score
                                                .replace('hamilton_d', 'Hamilton D')
                                                .replace('hamilton_a', 'Hamilton A')
                                                .replace('isi', 'Índice Severidad Insomnio (ISI)')
                                                .replace('beck', 'Inventario de Depresión de Beck')
                                                .replace('banfe', 'BANFE')
                                                .replace('eva', 'Escala de Dolor (EVA)')}
                                        </td>
                                        <td class="py-3 text-center font-mono text-blue-200">{paciente[`${score}_pre` as keyof typeof paciente] ?? "-"}</td>
                                        <td class="py-3 text-center font-mono text-blue-200">{paciente[`${score}_inter` as keyof typeof paciente] ?? "-"}</td>
                                        <td class="py-3 text-center font-mono text-emerald-200">{paciente[`${score}_post` as keyof typeof paciente] ?? "-"}</td>
                                    </tr>
                                ))}
                                {paciente.pacientes_puntajes_extra && paciente.pacientes_puntajes_extra.map((extra: any) => (
                                    <tr class="bg-blue-900/10">
                                        <td class="py-3 pr-4 font-medium text-blue-300">{extra.nombre_prueba} <span class="text-[10px] text-gray-500 uppercase">(Extra)</span></td>
                                        <td class="py-3 text-center font-mono text-blue-200">{extra.puntaje_pre ?? "-"}</td>
                                        <td class="py-3 text-center font-mono text-blue-200">{extra.puntaje_inter ?? "-"}</td>
                                        <td class="py-3 text-center font-mono text-emerald-200">{extra.puntaje_post ?? "-"}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </InfoCard>
            </section>

            <section id="tms" class="scroll-mt-32">
                <InfoCard title="Protocolo TMS">
                    <div class="relative z-10 flex flex-col md:flex-row justify-between items-center gap-6">
                        <div>
                            <p class="text-gray-400 text-lg max-w-xl">
                                {paciente.tms_habilitado 
                                    ? `Seguimiento activo. Se han registrado ${sesionesTMS.length} sesiones hasta el momento.`
                                    : "Este paciente aún no tiene habilitado el seguimiento para Estimulación Magnética Transcraneal."}
                            </p>
                        </div>
    
                        <div class="flex flex-col items-end gap-3">
                            {!paciente.tms_habilitado ? (
                                <form method="POST">
                                    <input type="hidden" name="action" value="habilitar_tms" />
                                    <button type="submit" class="px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl shadow-lg shadow-blue-900/20 transition-all transform hover:scale-105">
                                        Habilitar Seguimiento
                                    </button>
                                </form>
                            ) : (
                                <div class="flex flex-wrap justify-end gap-3">
                                    {urlConsentimientoFirmado ? (
                                        <a href={urlConsentimientoFirmado} target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 px-4 py-3 bg-emerald-500/10 hover:bg-emerald-500/20 border border-emerald-500/20 text-emerald-400 font-medium rounded-xl transition-colors group">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                                </svg>
                                                <span>Consentimiento</span>
                                        </a>
                                    ) : (
                                        <form method="POST" enctype="multipart/form-data" class="relative">
                                            <input type="hidden" name="action" value="subir_consentimiento_tms" />
                                            <input type="file" name="archivo_pdf" id="file-consentimiento" accept="application/pdf" class="hidden" onchange="this.form.submit()" />
                                            <label for="file-consentimiento" class="cursor-pointer flex items-center gap-2 px-4 py-3 bg-slate-800 hover:bg-slate-700 border border-dashed border-gray-600 hover:border-blue-400 text-gray-300 hover:text-white font-medium rounded-xl transition-all">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                                                </svg>
                                                <span>Subir Consentimiento</span>
                                            </label>
                                        </form>
                                    )}
    
                                    <button onclick="document.getElementById('modal-tms').showModal()" class="group flex items-center gap-2 px-6 py-3 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl shadow-lg shadow-blue-900/20 transition-all">
                                        <span>Ver Sesiones</span>
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-white/70 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                                        </svg>
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </InfoCard>
            </section>

            <section id="seguimiento" class="scroll-mt-32">
                <InfoCard title="Seguimiento">
                    <div class="flex justify-between items-center mb-6">
                        <p class="text-gray-400 text-sm">Historial de notas posteriores a consulta.</p>
                        <button onclick="document.getElementById('modal-seguimiento').showModal()" class="text-xs bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg transition-colors cursor-pointer flex items-center gap-2">
                            <span class="text-lg leading-none">+</span> Agregar Nota
                        </button>
                    </div>
    
                    <div class="space-y-4">
                        {paciente.pacientes_seguimiento && paciente.pacientes_seguimiento.length > 0 ? (
                            paciente.pacientes_seguimiento.map((nota: any) => (
                                <div class="bg-gray-800/40 p-4 rounded-xl border border-gray-700/50 hover:bg-gray-800/60 transition-all group relative">
                                    <div class="flex justify-between items-start mb-2">
                                        <div class="flex flex-col">
                                            <span class="text-sm font-bold text-blue-300 font-mono">{formatDateShort(nota.fecha)}</span>
                                            <span class="text-[10px] text-gray-500 uppercase tracking-wider font-bold">Por: {nota.registrado_por || "Sistema"}</span>
                                        </div>
                                        <form method="POST" class="opacity-0 group-hover:opacity-100 transition-opacity">
                                            <input type="hidden" name="action" value="delete_seguimiento" />
                                            <input type="hidden" name="id_seguimiento" value={nota.id} />
                                            <button class="text-gray-500 hover:text-red-400 transition-colors" title="Eliminar"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>
                                        </form>
                                    </div>
                                    <p class="text-gray-200 whitespace-pre-wrap leading-relaxed text-sm">{nota.observacion}</p>
                                </div>
                            ))
                        ) : (
                            <div class="text-center py-8 border border-dashed border-gray-700 rounded-xl"><p class="text-gray-500 italic">No hay notas registradas.</p></div>
                        )}
                    </div>
                </InfoCard>
            </section>

            <div class="mt-12 border-t border-red-900/30 pt-8 pb-10 flex flex-col items-center">
                <button onclick="document.getElementById('modal-eliminar').showModal()" class="group flex items-center gap-2 text-red-500 hover:text-red-400 hover:bg-red-500/10 px-4 py-2 rounded-lg transition-all cursor-pointer border border-transparent hover:border-red-500/30">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 group-hover:scale-110 transition-transform">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                    </svg>
                    Eliminar Expediente Completo
                </button>
            </div>

        </div>
    </main>

    <dialog id="modal-seguimiento" class="m-auto bg-gray-900 border border-gray-700 rounded-2xl p-6 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-lg text-left">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">Agregar Nota</h3><button onclick="document.getElementById('modal-seguimiento').close()" class="text-gray-500 hover:text-white cursor-pointer">✕</button></div>
        <form method="POST" class="space-y-4">
            <input type="hidden" name="action" value="add_seguimiento">
            <div class="flex flex-col"><label class="text-xs text-gray-400 mb-1">Fecha</label><input type="date" name="fecha" class="bg-gray-800 border border-gray-600 rounded p-2 text-white focus:border-blue-500 outline-none" required style="color-scheme: dark;"></div>
            <div class="flex flex-col"><label class="text-xs text-gray-400 mb-1">Observación</label><textarea name="observacion" rows="5" class="bg-gray-800 border border-gray-600 rounded p-3 text-white focus:border-blue-500 outline-none resize-none" required></textarea></div>
            <div class="pt-4 flex gap-3 justify-end border-t border-gray-700/50"><button type="button" onclick="document.getElementById('modal-seguimiento').close()" class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 hover:text-white cursor-pointer">Cancelar</button><button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-medium hover:bg-blue-500 cursor-pointer">Guardar</button></div>
        </form>
    </dialog>

    <dialog id="modal-eliminar" class="m-auto bg-gray-900 border border-red-600 rounded-2xl p-8 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-md text-center">
        <div class="mb-4 text-red-500 flex justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-12 h-12 animate-pulse">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
            </svg>
        </div>
        <h3 class="text-2xl font-bold text-white mb-2">¿Eliminar Expediente?</h3>
        <p class="text-gray-300 mb-6 text-sm">
            Estás a punto de eliminar el expediente de <span class="text-white font-bold">{paciente.nombre}</span>. 
            <br/><br/>
            <span class="text-red-400 bg-red-900/20 px-2 py-1 rounded">Esta acción es irreversible</span>
            <br/>Se perderán todos los datos, citas, síntomas y puntajes asociados.
        </p>
        
        <form method="POST" class="flex gap-4 justify-center">
            <input type="hidden" name="action" value="delete_patient">
            <button type="button" onclick="document.getElementById('modal-eliminar').close()" class="px-5 py-2.5 rounded-xl border border-gray-600 text-gray-300 hover:text-white cursor-pointer hover:bg-gray-800 transition-colors">
                Cancelar
            </button>
            <button type="submit" class="px-5 py-2.5 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 cursor-pointer shadow-lg shadow-red-900/20 transition-all hover:scale-105">
                Sí, Eliminar
            </button>
        </form>
    </dialog>

    <dialog id="modal-puntajes" class="m-auto bg-gray-900 border border-gray-700 rounded-2xl p-6 shadow-2xl backdrop:backdrop-blur-sm w-full max-w-4xl text-left">
        <div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-white">Actualizar Puntajes</h3><button onclick="document.getElementById('modal-puntajes').close()" class="text-gray-500 hover:text-white">✕</button></div>
        <form method="POST" class="space-y-6">
            <input type="hidden" name="action" value="update_scores" />
            <div class="overflow-x-auto max-h-[60vh] overflow-y-auto pr-2">
                <table class="w-full text-left border-collapse">
                    <thead class="sticky top-0 bg-gray-900 z-10"><tr class="text-gray-400 text-xs uppercase border-b border-gray-700"><th class="py-2">Prueba</th><th class="py-2 text-center w-24 text-blue-400">Pre</th><th class="py-2 text-center w-24 text-purple-400">Inter</th><th class="py-2 text-center w-24 text-emerald-400">Post</th></tr></thead>
                    <tbody class="divide-y divide-gray-800">
                        {['hamilton_d', 'hamilton_a', 'isi', 'beck', 'banfe', 'eva'].map(score => (
                            <tr>
                                <td class="py-3 pr-4 font-medium text-gray-300 capitalize">
                                    {score
                                        .replace('hamilton_d', 'Hamilton D')
                                        .replace('hamilton_a', 'Hamilton A')
                                        .replace('isi', 'Índice Severidad Insomnio (ISI)')
                                        .replace('beck', 'Inventario de Depresión de Beck')
                                        .replace('banfe', 'BANFE')
                                        .replace('eva', 'Escala de Dolor (EVA)')}
                                </td>
                                <td class="p-2">
                                    <input type="number" name={`${score}_pre` as keyof typeof paciente} value={paciente[`${score}_pre` as keyof typeof paciente]} class="score-input w-full" placeholder="-" />
                                </td>
                                <td class="p-2">
                                    <input type="number" name={`${score}_inter` as keyof typeof paciente} value={paciente[`${score}_inter` as keyof typeof paciente]} class="score-input w-full" placeholder="-" />
                                </td>
                                <td class="p-2">
                                    <input type="number" name={`${score}_post` as keyof typeof paciente} value={paciente[`${score}_post` as keyof typeof paciente]} class="score-input w-full" placeholder="-" />
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
                <div class="mt-6 pt-4 border-t border-gray-700">
                    <h4 class="text-sm font-bold text-white mb-3">Puntajes Extra</h4>
                    <div id="modal-extras-container" class="space-y-2">
                        {paciente.pacientes_puntajes_extra && paciente.pacientes_puntajes_extra.map((extra: any) => (
                            <div class="grid grid-cols-12 gap-2 items-center extra-row bg-gray-800/30 p-2 rounded">
                                <div class="col-span-3"><input type="text" name="extra_prueba_nombre" value={extra.nombre_prueba} placeholder="Nombre" class="bg-transparent border-b border-gray-600 text-white w-full text-sm focus:outline-none focus:border-blue-500" /></div>
                                <div class="col-span-3"><input type="number" name="extra_prueba_pre" value={extra.puntaje_pre} placeholder="Pre" class="score-input w-full" /></div>
                                <div class="col-span-3"><input type="number" name="extra_prueba_inter" value={extra.puntaje_inter} placeholder="Inter" class="score-input w-full" /></div>
                                <div class="col-span-2"><input type="number" name="extra_prueba_post" value={extra.puntaje_post} placeholder="Post" class="score-input w-full" /></div>
                                <div class="col-span-1 text-center"><button type="button" class="text-red-400 hover:text-red-300 btn-remove-extra cursor-pointer">✕</button></div>
                            </div>
                        ))}
                    </div>
                    <button type="button" id="btn-add-extra-modal" class="mt-3 text-xs flex items-center gap-1 text-blue-400 hover:text-blue-300 cursor-pointer"><span class="text-lg leading-none">+</span> Agregar prueba extra</button>
                </div>
            </div>
            <div class="pt-4 flex gap-3 justify-end border-t border-gray-700/50"><button type="button" onclick="document.getElementById('modal-puntajes').close()" class="px-4 py-2 rounded-lg border border-gray-600 text-gray-300 cursor-pointer">Cancelar</button><button type="submit" class="px-6 py-2 rounded-lg bg-blue-600 text-white font-medium cursor-pointer">Guardar Cambios</button></div>
        </form>
    </dialog>

    <dialog id="modal-tms" class="m-auto bg-transparent p-0 backdrop:bg-black/80 backdrop:backdrop-blur-sm w-full max-w-5xl">
        <div class="bg-[#0f172a] border border-white/10 rounded-3xl shadow-2xl overflow-hidden m-4 max-h-[90vh] flex flex-col">
            
            <div class="p-6 border-b border-white/10 bg-slate-900/50 flex justify-between items-center sticky top-0 z-20">
                <div>
                    <h3 class="text-xl font-bold text-white flex items-center gap-2">
                        <span class="w-2 h-6 bg-blue-500 rounded-full"></span>
                        Bitácora Técnica TMS
                    </h3>
                    <p class="text-sm text-gray-400">Paciente: <span class="text-white font-medium">{paciente.nombre}</span></p>
                </div>
                <button onclick="document.getElementById('modal-tms').close()" class="p-2 text-gray-400 hover:text-white rounded-full bg-white/5 hover:bg-white/10 transition-colors cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="p-6 overflow-y-auto custom-scrollbar flex-1 space-y-8">
                
                <div class="bg-gradient-to-br from-blue-900/10 to-slate-900 border border-blue-500/20 rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500/5 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                    
                    <h4 class="text-sm font-bold text-blue-300 uppercase tracking-wider mb-6 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                        Registrar Sesión de Hoy
                    </h4>
                    
                    <form method="POST" class="grid grid-cols-1 md:grid-cols-12 gap-5 relative z-10">
                        <input type="hidden" name="action" value="nueva_sesion_tms" />
                        
                        <div class="md:col-span-3">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Fecha</label>
                            <input type="date" name="fecha" required class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors" style="color-scheme:dark;" />
                        </div>
                        <div class="md:col-span-5">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Protocolo / Diagnóstico</label>
                            <input type="text" name="protocolo" placeholder="Ej. Insomnio Crónico" value={ultimaConfig.protocolo || ''} class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors" />
                        </div>
                        
                        <div class="md:col-span-4">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Sitio Estimulación</label>
                            <select id="select-sitio" name="sitio_estimulacion" class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors appearance-none cursor-pointer">
                                <option value="" disabled selected={!ultimaConfig.sitio_estimulacion}>Seleccionar...</option>
                                <option value="DLPFC Izquierdo" selected={ultimaConfig.sitio_estimulacion === 'DLPFC Izquierdo'}>DLPFC Izquierdo</option>
                                <option value="DLPFC Derecho" selected={ultimaConfig.sitio_estimulacion === 'DLPFC Derecho'}>DLPFC Derecho</option>
                                <option value="Bilateral" selected={ultimaConfig.sitio_estimulacion === 'Bilateral'}>Bilateral (Izq + Der)</option>
                                <option value="Corteza Motora M1" selected={ultimaConfig.sitio_estimulacion === 'Corteza Motora M1'}>Corteza Motora (M1)</option>
                                <option value="Otro" selected={ultimaConfig.sitio_estimulacion === 'Otro'}>Otro</option>
                            </select>
                        </div>

                        <div class="md:col-span-12 grid grid-cols-2 md:grid-cols-4 gap-4 p-4 bg-slate-950/50 rounded-xl border border-white/5">
                            <div>
                                <label class="block text-[10px] text-blue-400 mb-1">Umbral Motor (MT)</label>
                                <div class="relative">
                                    <input type="number" name="umbral_motor" placeholder="60" value={ultimaConfig.umbral_motor || ''} class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold" />
                                    <span class="absolute right-0 top-1 text-xs text-gray-600">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] text-blue-400 mb-1">Intensidad Tx</label>
                                <div class="relative">
                                    <input type="number" name="intensidad_tratamiento" placeholder="120" value={ultimaConfig.intensidad_tratamiento || ''} class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold" />
                                    <span class="absolute right-0 top-1 text-xs text-gray-600">%</span>
                                </div>
                            </div>
                            
                            <div id="freq-simple" class="block">
                                <label class="block text-[10px] text-blue-400 mb-1">Frecuencia</label>
                                <select name="frecuencia" class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold appearance-none cursor-pointer">
                                    <option value="1Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '1Hz'}>1 Hz</option>
                                    <option value="10Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '10Hz'}>10 Hz</option>
                                    <option value="TBS" class="bg-slate-950" selected={ultimaConfig.frecuencia === 'TBS'}>Theta Burst</option>
                                    <option value="Otro" class="bg-slate-950" selected={ultimaConfig.frecuencia === 'Otro'}>Otro</option>
                                </select>
                            </div>

                            <div id="freq-bilateral" class="hidden col-span-2 md:col-span-1 grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 text-center">Izq (L)</label>
                                    <select name="frecuencia_izq" class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold appearance-none cursor-pointer">
                                        <option value="1Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '1Hz'}>1 Hz</option>
                                        <option value="10Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia === '10Hz'}>10 Hz</option>
                                        <option value="TBS" class="bg-slate-950" selected={ultimaConfig.frecuencia === 'TBS'}>TBS</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-[10px] text-blue-400 mb-1 text-center">Der (R)</label>
                                    <select name="frecuencia_der" class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold appearance-none cursor-pointer">
                                        <option value="1Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia_derecha === '1Hz'}>1 Hz</option>
                                        <option value="10Hz" class="bg-slate-950" selected={ultimaConfig.frecuencia_derecha === '10Hz'}>10 Hz</option>
                                        <option value="TBS" class="bg-slate-950" selected={ultimaConfig.frecuencia_derecha === 'TBS'}>TBS</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-[10px] text-blue-400 mb-1">Total Pulsos</label>
                                <input type="number" name="total_pulsos" placeholder="1200" value={ultimaConfig.total_pulsos || ''} class="w-full bg-transparent border-b border-white/10 py-1 text-white focus:border-blue-500 outline-none text-center font-mono font-bold" />
                            </div>
                        </div>

                        <div class="md:col-span-9">
                            <label class="block text-[10px] uppercase font-bold text-gray-500 mb-1">Notas Clínicas / Incidencias</label>
                            <input type="text" name="observaciones" placeholder="Ej. Paciente durmió durante la sesión." class="w-full bg-slate-950 border border-white/10 rounded-lg px-3 py-2 text-white focus:border-blue-500 outline-none transition-colors" />
                        </div>
                        <div class="md:col-span-3 flex items-end">
                            <button type="submit" class="w-full h-[40px] bg-blue-600 hover:bg-blue-500 text-white font-bold text-sm rounded-lg transition-all shadow-lg shadow-blue-900/20 flex items-center justify-center gap-2 cursor-pointer">
                                <span>Guardar Sesión</span>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                            </button>
                        </div>
                    </form>
                </div>

                <div>
                    <h4 class="text-gray-400 text-xs font-bold uppercase tracking-widest mb-4">Historial de Aplicaciones</h4>
                    <div class="space-y-3">
                        {sesionesTMS.length > 0 ? sesionesTMS.map((sesion:any, index:any) => (
                            <div class="bg-slate-800/40 border border-white/5 rounded-xl p-4 hover:bg-slate-800/60 transition-colors group">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-3 pb-3 border-b border-white/5">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 font-bold text-xs">
                                            #{sesionesTMS.length - index}
                                        </div>
                                        <div>
                                            <p class="text-white font-bold text-sm">{formatDate(sesion.fecha_aplicacion)}</p>
                                            <p class="text-xs text-blue-300">{sesion.protocolo || "Protocolo Estándar"}</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-4 text-xs font-mono text-gray-400">
                                        {sesion.umbral_motor && <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500">MT</span><span class="text-white">{sesion.umbral_motor}%</span></div>}
                                        {sesion.intensidad_tratamiento && <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500">Intensidad</span><span class="text-white">{sesion.intensidad_tratamiento}%</span></div>}
                                        
                                        {sesion.frecuencia && (
                                            <div class="flex flex-col items-center">
                                                <span class="text-[10px] text-gray-500">Hz</span>
                                                {sesion.frecuencia_derecha ? (
                                                    <div class="flex flex-col text-[10px] leading-tight">
                                                        <span class="text-emerald-400">L: {sesion.frecuencia}</span>
                                                        <span class="text-blue-400">R: {sesion.frecuencia_derecha}</span>
                                                    </div>
                                                ) : (
                                                    <span class="text-emerald-400">{sesion.frecuencia}</span>
                                                )}
                                            </div>
                                        )}

                                        {sesion.total_pulsos && <div class="flex flex-col items-center"><span class="text-[10px] text-gray-500">Pulsos</span><span class="text-sky-400">{sesion.total_pulsos}</span></div>}
                                    </div>
                                </div>
                                <div class="flex gap-2 items-start">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-500 mt-0.5 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" /></svg>
                                    <p class="text-gray-300 text-sm leading-relaxed">{sesion.observaciones || "Sin observaciones registradas."}</p>
                                </div>
                            </div>
                        )) : (
                            <div class="py-12 text-center text-gray-500 border border-dashed border-gray-800 rounded-xl bg-slate-900/30">
                                <p>No hay sesiones registradas en el historial.</p>
                            </div>
                        )}
                    </div>
                </div>

            </div>
        </div>
    </dialog>
</Layout>

<style>
    @reference "../../../styles/global.css";

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    #dynamic-nav {
        @apply w-full max-w-6xl mx-auto;
        @apply mt-1 mb-1 p-1.5;
        @apply bg-gray-900/40 border border-white/5 backdrop-blur-md;
        @apply rounded-2xl;
        @apply shadow-none;

        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }
    #dynamic-nav[data-state='floating'] {
        @apply max-w-[680px] mt-2;
        
        @apply bg-[#0f172a]/90 border-white/10;
        @apply rounded-full;
        @apply shadow-[0_10px_40px_-10px_rgba(0,0,0,0.6)];
    }

    .nav-link {
        @apply px-4 py-2 text-[11px] font-bold uppercase tracking-wider text-gray-400;
        @apply border border-transparent whitespace-nowrap text-center flex-1;
        
        @apply rounded-xl; 
        
        transition: all 0.3s ease-out;
    }

    .nav-link:hover {
        @apply text-white bg-white/5 border-white/5;
    }

    .nav-link.active {
        @apply bg-blue-600 text-white;
        @apply border-blue-500/30;
        @apply shadow-[0_0_15px_rgba(37,99,235,0.4)];
    }

    #dynamic-nav[data-state='floating'] .nav-link {
        @apply rounded-full;
    }

    .scroll-mt-32 { scroll-margin-top: 30vh; }

    .label { 
        @apply block text-gray-500 text-xs uppercase tracking-wider font-bold mb-1; 
    }

    .value { 
        @apply text-lg text-white font-medium; 
    }

    .score-input { 
        @apply bg-gray-800 border border-gray-600 rounded p-2 text-white focus:border-blue-500 focus:outline-none text-center; 
    }

    dialog::backdrop { 
        background: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(4px); 
    }

    dialog[open] { 
        animation: fade-in 0.3s ease-out; 
    }

    @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
</style>

<script>
    //@ts-nocheck
    document.addEventListener('DOMContentLoaded', () => {
        const sections = document.querySelectorAll('section[id]');
        const navLinks = document.querySelectorAll('.nav-link');
        const navElement = document.getElementById('dynamic-nav');
        const sentinelElement = document.getElementById('nav-sentinel');

        // Script para filas extra en modal
        const container = document.getElementById('modal-extras-container');
        const btnAdd = document.getElementById('btn-add-extra-modal');
        const setupRemoveBtn = (btn: any) => {
            btn.addEventListener('click', (e: any) => e.target.closest('.extra-row')?.remove());
        };
        document.querySelectorAll('.btn-remove-extra').forEach(setupRemoveBtn);
        if (btnAdd && container) {
            btnAdd.addEventListener('click', () => {
                const row = document.createElement('div');
                row.className = 'grid grid-cols-12 gap-2 items-center extra-row bg-gray-800/30 p-2 rounded';
                row.innerHTML = `
                    <div class="col-span-3">
                        <input type="text" name="extra_prueba_nombre" placeholder="Nombre" class="bg-transparent border-b border-gray-600 text-white w-full text-sm focus:outline-none focus:border-blue-500">
                    </div>
                    <div class="col-span-3"><input type="number" name="extra_prueba_pre" placeholder="Pre" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-center text-sm w-full"></div>
                    <div class="col-span-3"><input type="number" name="extra_prueba_inter" placeholder="Inter" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-center text-sm w-full"></div>
                    <div class="col-span-2"><input type="number" name="extra_prueba_post" placeholder="Post" class="bg-gray-800 border border-gray-600 rounded p-2 text-white text-center text-sm w-full"></div>
                    <div class="col-span-1 text-center"><button type="button" class="text-red-400 btn-remove-extra">✕</button></div>
                `;
                container.appendChild(row);
                const newBtn = row.querySelector('.btn-remove-extra');
                if(newBtn) setupRemoveBtn(newBtn);
            });
        }
        
        const activateLink = (id) => {
            navLinks.forEach(link => {
                link.classList.remove('active');
                
                if (link.getAttribute('href') === `#${id}`) {
                    link.classList.add('active');
                    
                    link.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'nearest', 
                        inline: 'center' 
                    });
                }
            });
        };

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                
                const targetId = link.getAttribute('href').substring(1);
                const targetSection = document.getElementById(targetId);

                if (targetSection) {
                    targetSection.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });

                    history.pushState(null, null, `#${targetId}`);
                    
                    activateLink(targetId); 
                }
            });
        });

        const sectionObserverOptions = {
            root: null,
            rootMargin: '-45% 0px -60% 0px',
            threshold: 0
        };

        const sectionObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    activateLink(entry.target.id);
                }
            });
        }, sectionObserverOptions);

        sections.forEach(section => sectionObserver.observe(section));

        if (navElement && sentinelElement) {
            const handler = (entries) => {
                if (!entries[0].isIntersecting) {
                    navElement.setAttribute('data-state', 'floating');
                } else {
                    navElement.removeAttribute('data-state');
                }
            };

            const observer = new IntersectionObserver(handler, {
                root: null,
                threshold: 0,
                rootMargin: "50px 0px 0px 0px" 
            });

            observer.observe(sentinelElement);
        }

        const selectSitio = document.getElementById('select-sitio') as HTMLSelectElement;
        const freqSimple = document.getElementById('freq-simple');
        const freqBilateral = document.getElementById('freq-bilateral');

        if (selectSitio && freqSimple && freqBilateral) {
            const toggle = () => {
                const esBilateral = selectSitio.value === 'Bilateral';
                if (esBilateral) {
                    freqSimple.classList.remove('block');
                    freqSimple.classList.add('hidden');
                    freqSimple.querySelectorAll('select').forEach(s => s.disabled = true);

                    freqBilateral.classList.remove('hidden');
                    freqBilateral.classList.add('grid');
                    freqBilateral.querySelectorAll('select').forEach(s => s.disabled = false);
                } else {
                    freqBilateral.classList.remove('grid');
                    freqBilateral.classList.add('hidden');
                    freqBilateral.querySelectorAll('select').forEach(s => s.disabled = true);

                    freqSimple.classList.remove('hidden');
                    freqSimple.classList.add('block');
                    freqSimple.querySelectorAll('select').forEach(s => s.disabled = false);
                }
            };
            selectSitio.addEventListener('change', toggle);
            toggle();
        }
    });

    const savedScroll = sessionStorage.getItem('scrollPos');
    
    if (savedScroll) {
        window.scrollTo({
            top: parseInt(savedScroll),
            behavior: 'instant'
        });
        sessionStorage.removeItem('scrollPos');
    }

    document.querySelectorAll('form').forEach(form => {
        form.addEventListener('submit', () => {
            sessionStorage.setItem('scrollPos', window.scrollY.toString());
        });
    });
</script>