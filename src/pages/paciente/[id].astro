---
    import Layout from "../../layouts/Layout.astro"
    import ReturnButton from "../../components/ReturnButton.astro"
    import InfoCard from "../../components/InfoCard.astro"
    import { createClient } from "@supabase/supabase-js"

    const { id } = Astro.params;

    // 1. Si no hay ID, redirigir
    if (!id) {
        return Astro.redirect("/lista");
    }

    // 2. Configuración de Supabase
    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.SUPABASE_KEY
    );

    // 3. Obtener el paciente específico por ID
    const { data: paciente, error } = await supabase
        .from('pacientes')
        .select('*')
        .eq('id', id)
        .single(); // .single() es importante porque esperamos UN solo resultado

    // Si hay error o no existe, volvemos a la lista (o podrías mostrar un 404)
    if (error || !paciente) {
        console.error("Paciente no encontrado", error);
        return Astro.redirect("/lista");
    }
---

<Layout title={`Expediente: ${paciente.nombre}`}>
    <ReturnButton />

    <main class="max-w-5xl mx-auto pt-20 pb-28 px-4">
        <div class="border-b-2 border-white pb-6 mb-10 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <p class="text-blue-400 text-sm font-bold uppercase tracking-widest mb-2 max-md:text-end">Expediente Completo</p>
                <h1 class="text-5xl font-extrabold capitalize">{paciente.nombre}</h1>
            </div>
            <div class="text-right">
                <p class="text-gray-400 text-sm">Registrado el:</p>
                <p class="text-xl font-medium">
                    {new Date(paciente.created_at).toLocaleString('es-MX', {
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric', 
                        hour: '2-digit', 
                        minute: '2-digit'
                    })}
                </p>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <InfoCard title="Datos Generales">
                <div class="space-y-5">
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="block text-gray-500 text-sm">Edad</span>
                            <span class="text-xl">{paciente.edad} años</span>
                        </div>
                        <div>
                            <span class="block text-gray-500 text-sm">Género</span>
                            <span class="text-xl capitalize">{paciente.genero}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <span class="block text-gray-500 text-sm">Referido por</span>
                            <span class="text-lg">{paciente.referencia}</span>
                        </div>

                        <div>
                            <span class="block text-gray-500 text-sm mb-1">Motivo de consulta</span>
                            <p class="text-lg leading-relaxed text-white">{paciente.motivo}</p>
                        </div>
                    </div>
                    
                    <div class="pt-2 border-t border-gray-700">
                        <span class="block text-gray-500 text-xs uppercase tracking-wider">Registrado por</span>
                        <span class="text-base text-gray-300">{paciente.registrado_por || "Desconocido"}</span>
                    </div>
                </div>
            </InfoCard>

            <InfoCard title="Antecedentes Médicos">
                <div class="space-y-6">
                    <div>
                        <span class="block text-gray-500 text-sm mb-2">Historia Familiar y Personal</span>
                        <div class="bg-gray-800/50 p-4 rounded-lg border border-gray-700/50">
                            <p class="text-gray-300 italic leading-relaxed">
                                {paciente.antecedentes || 'No se han registrado antecedentes para este paciente.'}
                            </p>
                        </div>
                    </div>
                </div>
            </InfoCard>

            <InfoCard title="Análisis del Síntoma" className="md:col-span-2">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <span class="block text-blue-400 text-xs uppercase font-bold">Síntoma</span>
                        <span class="text-xl font-medium block mt-1">{paciente.sintoma}</span>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <span class="block text-blue-400 text-xs uppercase font-bold">Temporalidad</span>
                        <span class="text-lg block mt-1">{paciente.temporalidad}</span>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <span class="block text-blue-400 text-xs uppercase font-bold">Frecuencia</span>
                        <span class="text-lg block mt-1">{paciente.frecuencia}</span>
                    </div>
                    <div class="bg-gray-800 p-4 rounded-lg">
                        <span class="block text-red-400 text-xs uppercase font-bold">Gravedad</span>
                        <span class="text-lg block mt-1">{paciente.gravedad}</span>
                    </div>
                </div>
            </InfoCard>

        </div>
    </main>
</Layout>