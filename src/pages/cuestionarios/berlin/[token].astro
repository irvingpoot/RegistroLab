---
import LayoutCuestionario from "../../../layouts/LayoutCuestionario.astro" 
import InputNumber from "../../../components/InputNumber.astro"
import RadioGroup from "../../../components/RadioGroup.astro"
import ExpandableSection from "../../../components/ExpandableSection.astro"
import { createClient } from "@supabase/supabase-js"

const MODO_DISENO = false; // Cambiar a false para producción

// Usamos SERVICE_ROLE_KEY para saltarnos RLS y poder escribir sin que el paciente esté logueado
const supabaseAdmin = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY
);

const { token } = Astro.params;
const faseUrl = Astro.url.searchParams.get('fase');

let paciente = { id: 0, nombre: "" };
let mensaje = "";

if (!MODO_DISENO) {
    if (!token || !faseUrl || !['pre', 'inter', 'post'].includes(faseUrl)) {
        return Astro.redirect('/404');
    }

    // 1. Obtener Paciente
    const { data, error } = await supabaseAdmin
        .from('pacientes')
        .select('id, nombre')
        .eq('token_cuestionarios', token)
        .single();

    if (error || !data) return Astro.redirect('/404');
    paciente = data;

    // 2. GUARDAR RESPUESTAS (POST)
    if (Astro.request.method === "POST") {
        try {
            const formData = await Astro.request.formData();
            
            // CONVERTIMOS EL FORMULARIO A UN OBJETO JSON
            // Esto toma todos los 'name' de tus inputs y sus valores
            const respuestas = Object.fromEntries(formData);
            
            // Opcional: Limpiar datos técnicos si se colaron (ej: tokens de viewstate de Astro si los hubiera)
            // delete respuestas.algun_campo_innecesario;

            // INSERTAR / ACTUALIZAR EN LA NUEVA TABLA
            const { error: saveError } = await supabaseAdmin
                .from('respuestas_cuestionarios')
                .upsert({
                    paciente_id: paciente.id,
                    fase: faseUrl,
                    cuestionario: 'berlin', // <--- IMPORTANTE: CAMBIAR ESTO SEGÚN EL ARCHIVO (berlin, pittsburgh)
                    datos: respuestas,
                    updated_at: new Date()
                }, { 
                    onConflict: 'paciente_id, fase, cuestionario' // Usa la restricción única que creamos
                });

            if (saveError) {
                console.error("Error Supabase:", saveError);
                mensaje = "Error al guardar las respuestas.";
            } else {
                mensaje = "¡Respuestas guardadas correctamente!";
                // Opcional: Redirigir a una página de agradecimiento
                // return Astro.redirect('/gracias');
            }

        } catch (e) {
            console.error("Error procesando:", e);
            mensaje = "Ocurrió un error inesperado.";
        }
    }
} else {
    paciente = { id: 0, nombre: "Paciente Simulado" };
    if (Astro.request.method === "POST") mensaje = "Guardado simulado exitoso.";
}

const textoFase = { 'pre': 'Pre-Tratamiento', 'inter': 'Intermedio', 'post': 'Post-Tratamiento' }[faseUrl || 'pre'];

const optionsRonca = [
    { label: 'Sí', value: 'si' },
    { label: 'No', value: 'no' },
    { label: 'No lo sé', value: 'unknown' }
];

const optionsFrecuencia = [
    { label: 'Casi todos los días', value: 'si' },
    { label: '3-4 veces por semana', value: 'no' },
    { label: '1-2 veces por semana', value: 'unknown' },
    { label: '1-2 veces por mes', value: 'no' },
    { label: 'Casi nunca o nunca', value: 'no' }
];

const optionsVolumen = [
    { label: 'Como una respiración fuerte', value: 'si' },
    { label: 'Tan alto como una conversación', value: 'no' },
    { label: 'Más alto que una conversación', value: 'unknown' },
    { label: 'Muy alto, se puede escuchar desde habitaciones vecinas', value: 'no' }
];

const optionsSiNo = [
    { label: 'Si', value: 'si' },
    { label: 'No', value: 'no' }
];

const optionsSexo = [
    { label: 'Masculino', value: 'male' },
    { label: 'Femenino', value: 'female' }
];

---
<LayoutCuestionario title="Cuestionario">

    <div class="relative overflow-hidden bg-white rounded-3xl shadow-xl shadow-emerald-900/5 border border-emerald-100 p-6 md:p-8 mb-10">
        
        <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-emerald-400/10 rounded-full blur-3xl pointer-events-none"></div>
        <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-teal-400/10 rounded-full blur-2xl pointer-events-none"></div>

        <div class="relative z-10 flex flex-col md:flex-row gap-6 items-start md:items-center justify-between">
            <div class="flex items-start gap-5">
                <div class="p-4 bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl shadow-lg shadow-emerald-500/30 text-white shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /> <path stroke-linecap="round" stroke-linejoin="round" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                    </svg>
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span class="px-2.5 py-0.5 rounded-full bg-emerald-100 text-emerald-700 text-xs font-bold uppercase tracking-wider border border-emerald-200">
                            {textoFase}
                        </span>
                    </div>
                    <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight">Cuestionario de Berlín</h1>
                    <p class="text-gray-500 font-medium">Paciente: <span class="text-gray-900">{paciente.nombre}</span></p>
                </div>
            </div>

            <div class="flex gap-3 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                <div class="bg-gray-50 border border-gray-100 rounded-xl p-3 min-w-[100px] text-center">
                    <p class="text-xs text-gray-400 uppercase font-bold">Tiempo</p>
                    <p class="text-lg font-bold text-gray-800">~3 min</p>
                </div>
                <div class="bg-emerald-50 border border-emerald-100 rounded-xl p-3 min-w-[120px] text-center">
                    <p class="text-xs text-emerald-600 uppercase font-bold">Enfoque</p>
                    <p class="text-lg font-bold text-emerald-700">Apnea / SAOS</p>
                </div>
            </div>
        </div>

        <div class="mt-6 pt-6 border-t border-gray-100">
            <div class="flex gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-emerald-500 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="text-gray-600 text-sm leading-relaxed">
                    Este cuestionario identifica factores de riesgo para la <strong>apnea del sueño</strong>. 
                    Le preguntaremos sobre ronquidos, pausas al respirar y fatiga.
                    <span class="block mt-2 text-emerald-600 font-medium italic">Sea muy honesto, sus respuestas son clave para el diagnóstico.</span>
                </p>
            </div>
        </div>
    </div>

    <form method="post">
        <InputNumber 
            label="Edad" 
            name="edad" 
            placeholder="Ej. 40" 
            min={0}
            max={120} 
            required={true}
        />

        <InputNumber 
            label="Altura (cm)" 
            name="altura" 
            placeholder="Ej. 175" 
            min={0} 
            max={250} 
            required={true}
        />

        <InputNumber 
            label="Peso" 
            name="peso" 
            placeholder="Ej. 70" 
            min={0} 
            max={300} 
            required={true}
        />

        <RadioGroup 
            label="Sexo"
            name="sexo"
            options={optionsSexo}
            required={true}
        />

        <RadioGroup 
            label="¿Ronca?"
            name="ronca"
            options={optionsRonca}
            required={true}
        />
        <ExpandableSection id="extra-ronca">

            <h3 class="text-blue-600 font-bold mb-4 tracking-wider">Detalles sobre el ronquido:</h3>
                
            <RadioGroup 
                label="¿Cómo es el volumen del ronquido?"
                name="ronca_volumen"
                options={optionsVolumen} 
            />
            
            <RadioGroup 
                label="¿Con qué frecuencia ronca?"
                name="ronca_frecuencia"
                options={optionsFrecuencia} 
            />
            
            <RadioGroup 
                label="¿Su ronquido molesta a otras personas?"
                name="ronca_molesta"
                options={optionsSiNo} 
            />

            <RadioGroup 
                label="¿Alguien advirtió que usted deja de respirar durante el sueño?"
                name="ronca_deja_de_respirar"
                options={optionsFrecuencia} 
            />

        </ExpandableSection>

        <RadioGroup 
            label="¿Con qué frecuencia se despierta cansado después de dormir?"
            name="despierta_cansado"
            options={optionsFrecuencia}
            required={true}
        />

        <RadioGroup 
            label="Durante el día, ¿se siente mal, cansado o fatigado?"
            name="se_siente_mal"
            options={optionsFrecuencia}
            required={true}
        />

        <RadioGroup 
                label="¿Alguna vez se quedó dormido mientras conducía?"
                name="se_quedo_dormido"
                options={optionsSiNo}
                required={true}
        />
        <ExpandableSection id="extra-se_quedo_dormido">
            <RadioGroup 
                label="¿Con qué frecuencia ocurre esto?"
                name="se_quedo_dormido_frecuencia"
                options={optionsFrecuencia}
            />
        </ExpandableSection>

        <RadioGroup 
                label="¿Sufre de hipertensión?"
                name="hipertension"
                options={optionsSiNo}
                required={true}
        />

        <button type="submit">Guardar y Finalizar</button>
    </form>

</LayoutCuestionario>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        
        // 1. CONFIGURACIÓN: Aquí defines todas tus reglas
        // Solo agregas líneas aquí si tienes nuevas preguntas condicionales
        const reglas = [
            { 
                triggerName: 'ronca',       // El 'name' del RadioGroup
                triggerValue: 'si',        // El valor que activa la sección
                targetId: 'extra-ronca'     // El ID del ExpandableSection
            },
            { 
                triggerName: 'se_quedo_dormido', 
                triggerValue: 'si', 
                targetId: 'extra-se_quedo_dormido' 
            }
        ];

        // 2. LÓGICA
        reglas.forEach(regla => {
            const inputs = document.querySelectorAll(`input[name="${regla.triggerName}"]`);
            const target = document.getElementById(regla.targetId);
            
            if (!target) return; // Seguridad por si el ID no existe

            const inputsInternos = target.querySelectorAll('input, select, textarea');

            const actualizarEstado = () => {
                const seleccionado = document.querySelector(`input[name="${regla.triggerName}"]:checked`);
                const valor = seleccionado ? (seleccionado as HTMLInputElement).value : null;

                if (valor === regla.triggerValue) {
                    // MOSTRAR
                    target.classList.remove('grid-rows-[0fr]', 'opacity-0');
                    target.classList.add('grid-rows-[1fr]', 'opacity-100');
                    inputsInternos.forEach(i => i.removeAttribute('disabled'));
                } else {
                    // OCULTAR
                    target.classList.remove('grid-rows-[1fr]', 'opacity-100');
                    target.classList.add('grid-rows-[0fr]', 'opacity-0');
                    inputsInternos.forEach(i => i.setAttribute('disabled', 'true'));
                }
            };

            // Escuchar cambios
            inputs.forEach(input => {
                input.addEventListener('change', actualizarEstado);
            });

            // Ejecutar al inicio (por si recargas la página y ya había datos)
            actualizarEstado();
        });
    });
</script>

<style>
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
    }
</style>