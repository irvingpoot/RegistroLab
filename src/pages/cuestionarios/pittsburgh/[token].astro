---
import { createClient } from "@supabase/supabase-js"
import LayoutCuestionario from "../../../layouts/LayoutCuestionario.astro" 
import MatrixScale from "../../../components/MatrixScale.astro"
import TimePicker from "../../../components/TimePicker.astro"
import InputNumber from "../../../components/InputNumber.astro"
import InputText from "../../../components/InputText.astro"
import RadioGroup from "../../../components/RadioGroup.astro"

const MODO_DISENO = false;

const supabaseAdmin = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_SERVICE_ROLE_KEY
);

const { token } = Astro.params;
const faseUrl = Astro.url.searchParams.get('fase');

let paciente = { id: 0, nombre: "" };
let mensaje = "";

if (!MODO_DISENO) {
    if (!token || !faseUrl || !['pre', 'inter', 'post'].includes(faseUrl)) {
        return Astro.redirect('/404');
    }

    // 2. LECTURA NORMAL
    const { data, error } = await supabaseAdmin
        .from('pacientes')
        .select('id, nombre')
        .eq('token_cuestionarios', token)
        .single();

    if (error || !data) {
        console.error("Error:", error);
        return Astro.redirect('/404');
    }

    paciente = data;

    // 3. GUARDADO NORMAL
    if (Astro.request.method === "POST") {
        const formData = await Astro.request.formData();
        const puntaje = formData.get("puntaje");

        if (puntaje) {
            const columnaDestino = `pittsburgh_${faseUrl}`;
            
            // Update directo, sin funciones SQL complejas
            const { error: updateError } = await supabaseAdmin
                .from('pacientes')
                .update({ [columnaDestino]: parseInt(puntaje.toString()) })
                .eq('id', paciente.id);

            if (!updateError) {
                mensaje = "¡Resultados guardados correctamente!";
            } else {
                console.error("Error al guardar:", updateError);
                mensaje = "Error al guardar.";
            }
        }
    }
} else {
    paciente = { id: 999, nombre: "Paciente Prueba" };
    if (Astro.request.method === "POST") mensaje = "Guardado simulado.";
}

const alteracionOptions = [
    { label: 'No me ha ocurrido durante el ultimo mes', value: 0 },
    { label: 'Menos de una vez a la semana', value: 1 },
    { label: 'Una o dos veces a la semana', value: 2 },
    { label: 'Tres o más veces a la semana', value: 3 },
];

const alteracionQuestions = [
    { id: 'alteracion_1', text: 'No poder conciliar el sueño después de 30 minutos de intentarlo' },
    { id: 'alteracion_2', text: 'Despertarse en mitad de la noche o de madrugada' },
    { id: 'alteracion_3', text: 'Tener que ir al baño' },
    { id: 'alteracion_4', text: 'No poder respirar adecuadamente' },
    { id: 'alteracion_5', text: 'Tos o ronquidos' },
    { id: 'alteracion_6', text: 'Sensación de frío' },
    { id: 'alteracion_7', text: 'Sensación de calor' },
    { id: 'alteracion_8', text: 'Pesadillas' },
    { id: 'alteracion_9', text: 'Sentir dolor' }
];

const compañeroOptions = [
    { label: 'No me ha ocurrido durante el ultimo mes', value: 0 },
    { label: 'Menos de una vez a la semana', value: 1 },
    { label: 'Una o dos veces a la semana', value: 2 },
    { label: 'Tres o más veces a la semana', value: 3 },
];

const compañeroQuestions = [
    { id: 'compañero_1', text: 'Ronquidos fuertes' },
    { id: 'compañero_2', text: 'Largas pausas entre respiraciones mientras dormía' },
    { id: 'compañero_3', text: 'Temblor o sacudidas de las piernas mientras dormía' },
    { id: 'compañero_4', text: 'Episodios de desorientación o confusión durante el sueño' },
    { id: 'compañero_5', text: 'Otro tipo de transtorno mientras dormía, por favor describa' }
];

const optionsFrecuencia = [
    { label: 'No me ha ocurrido durante el último mes', value: 'si' },
    { label: 'Menos de una vez a la semana', value: 'no' },
    { label: 'Una o dos veces a la semana', value: 'unknown' },
    { label: 'Tres o más veces a ala semana', value: 'no' }
];

const optionsCalidad = [
    { label: 'Muy buena', value: 'si' },
    { label: 'Bastante buena', value: 'no' },
    { label: 'Bastante mala', value: 'unknown' },
    { label: 'Muy mala', value: 'no' }
];

const optionsCompañero = [
    { label: 'No tengo pareja ni compañero/a de habitación', value: 'si' },
    { label: 'Si tengo pero duerme en otra habitación', value: 'no' },
    { label: 'Si tengo, pero duerme en la misma habitación y distinta cama', value: 'unknown' },
    { label: 'Si tengo y duerme en la misma cama', value: 'no' }
];

---

<LayoutCuestionario title="Cuestionario">

    <TimePicker 
        label="Durante el último mes, ¿a qué hora solías acostarte por la noche?"
        subLabel="Hora habitual de acostarse:"
        name="hora_acostarse"
        required={true}
    />

    <InputNumber 
        label="Durante el último mes, ¿cuánto tiempo (en minutos) te ha costado quedarte dormido después de acostarte por las noches?" 
        subLabel="Número de minutos para conciliar el sueño"
        name="tiempo_dormir" 
        placeholder="Ej. 40" 
        min={0}
        max={1000} 
        required={true}
    />

    <TimePicker 
        label="Durante el último mes, ¿a qué hora te has levantado habitualmente por la mañana?"
        subLabel="Hora habitual de levantarse:"
        name="hora_levantarse"
        required={true}
    />

    <InputNumber 
        label="Durante el último mes, ¿cuántas horas de sueño real has mantenido por las noches? (puede ser diferente del numero de horas que estuviste acostado)" 
        subLabel="Horas de sueño por noche:"
        name="horas_sueno" 
        placeholder="Ej. 6" 
        min={0}
        max={1000} 
        required={true}
    />

    <MatrixScale 
        instruction="Durante el último mes, ¿con qué frecuencia has tenido un sueño alterado a consecuencia de....?"
        scaleLabel="Para cada una de las cuestiones siguientes, selecciona la respuesta más adecuada a tu situación."
        options={alteracionOptions}
        questions={alteracionQuestions}
    />

    <InputText
        label="Otra causa(s), describir:" 
        name="otra_causa" 
        placeholder="Escriba su respuesta aquí"
    />

    <RadioGroup 
        label="¿Con qué frecuencia ha tenido un sueño alterado a consecuencia de este problema?"
        name="se_quedo_dormido"
        options={optionsFrecuencia}
    />

    <RadioGroup 
        label="Durante el último mes, ¿cómo calificarías, en general, la calidad de tu sueño?"
        name="calidad_sueno"
        options={optionsCalidad}
        required={true}
    />

    <RadioGroup 
        label="Durante el último mes, ¿con que frecuencia tuviste que tomar medicinas (prescritas o automedicadas) para poder dormir?"
        name="tomo_medicinas"
        options={optionsFrecuencia}
        required={true}
    />

    <RadioGroup 
        label="Durante el último mes, ¿con que frecuencia tuviste dificultad para mantenerte despierto mientras conducías, comías o desarrollabas alguna actividad social?"
        name="dificultad_despierto"
        options={optionsFrecuencia}
        required={true}
    />

    <RadioGroup 
        label="Durante el último mes, ¿cómo de problemático ha resultado para ti el mantener el entusiasmo por hacer las cosas?"
        name="problema_entusiasmo"
        options={optionsFrecuencia}
        required={true}
    />

    <RadioGroup 
        label="¿Tienes pareja o compañero/a de habitación?"
        name="pareja_companero"
        options={optionsCompañero}
        required={true}
    />

    <MatrixScale 
        instruction="Si tienes pareja o compañero/a de habitación con el que duermes, con qué frecuencia, durante el último mes, te ha dicho que has tenido..."
        scaleLabel="Para cada una de las cuestiones siguientes, selecciona la respuesta más adecuada a tu situación."
        options={compañeroOptions}
        questions={compañeroQuestions}
    />

    <InputText
        label="Otra transtorno, describir:" 
        name="otra_transtorno" 
        placeholder="Escriba su respuesta aquí"
    />

</LayoutCuestionario>