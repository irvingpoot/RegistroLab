---
// LÓGICA DEL SERVIDOR (Igual para todos, solo cambia el nombre de la prueba abajo)
import { createClient } from "@supabase/supabase-js"

const supabase = createClient(import.meta.env.PUBLIC_SUPABASE_URL, import.meta.env.SUPABASE_KEY);
const { token } = Astro.params;
const faseUrl = Astro.url.searchParams.get('fase');

if (!token || !faseUrl || !['pre', 'inter', 'post'].includes(faseUrl)) return Astro.redirect('/404');

const { data: paciente, error } = await supabase.from('pacientes').select('id, nombre').eq('token_encuesta', token).single();
if (error || !paciente) return Astro.redirect('/404');

// LÓGICA DE GUARDADO
let mensaje = "";
if (Astro.request.method === "POST") {
    const formData = await Astro.request.formData();
    const puntaje = formData.get("puntaje");

    if (puntaje) {
        // AQUÍ EL CAMBIO: Ya sabemos que es 'epworth', lo ponemos fijo en el código
        const columnaDestino = `epworth_${faseUrl}`; 
        
        const { error: updateError } = await supabase.from('pacientes').update({ [columnaDestino]: parseInt(puntaje.toString()) }).eq('id', paciente.id);
        if (!updateError) mensaje = "¡Resultados guardados!";
    }
}
---

<h1>Test de Epworth para {paciente.nombre}</h1>

<form method="POST">
    <input type="hidden" name="puntaje" id="puntaje-final">
    
    <button type="submit">Enviar</button>
</form>