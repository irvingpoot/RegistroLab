---

/**
 * @file [token].astro
 * @description Página de captura de cuestionarios públicos (Epworth, Berlin, Pittsburgh).
 * * * ARQUITECTURA DE SEGURIDAD:
 * - Utiliza la `ANON_KEY` (pública) y delega la seguridad a **Supabase RPC**.
 * - Funciones RPC utilizadas:
 * 1. `validar_acceso_cuestionario`: Verifica token y estado sin exponer datos sensibles.
 * 2. `guardar_respuesta_cuestionario`: Inserta las respuestas saltándose las reglas RLS de forma controlada desde la BD.
 * * * FLUJO:
 * 1. Obtiene el `token` de la URL.
 * 2. Valida acceso vía RPC (si el token existe y si ya contestó).
 * 3. Renderiza el formulario correspondiente.
 * 4. Envía los datos (`datos` JSONB) a través de la función segura en BD.
 */

import LayoutCuestionario from "../../../layouts/LayoutCuestionario.astro" 
import MatrixScale from "../../../components/MatrixScale.astro"
import { createClient } from "@supabase/supabase-js"

const MODO_DISENO = false; // Cambiar a false para producción

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

const { token } = Astro.params;
const faseUrl = Astro.url.searchParams.get('fase');

const nombreCuestionario = 'epworth'; 

let paciente = { id: 0, nombre: "" };
let mensaje = "";
let yaContestado = false;

if (!MODO_DISENO) {
    if (!token || !faseUrl || !['pre', 'inter', 'post'].includes(faseUrl)) {
        return Astro.redirect('/404');
    }

    // 1. VALIDAR ACCESO Y ESTADO (Usando la función segura RPC)
    const { data: infoAcceso, error: errorAcceso } = await supabase
        .rpc('validar_acceso_cuestionario', {
            token_input: token,
            cuestionario_input: nombreCuestionario,
            fase_input: faseUrl
        });

    // Si devuelve array vacío o error, es que el token no existe
    if (errorAcceso || !infoAcceso || infoAcceso.length === 0) {
        console.error("Error acceso:", errorAcceso);
        return Astro.redirect('/404');
    }

    // Mapeamos los datos recibidos de la función SQL
    paciente = { 
        id: infoAcceso[0].paciente_id, 
        nombre: infoAcceso[0].nombre 
    };
    yaContestado = infoAcceso[0].ya_contestado;

    // 2. PROCESAR FORMULARIO (POST)
    if (Astro.request.method === "POST" && !yaContestado) {
        try {
            const formData = await Astro.request.formData();
            const respuestas = Object.fromEntries(formData);

            // Guardar usando la función RPC segura
            const { error: saveError } = await supabase
                .rpc('guardar_respuesta_segura', {
                    token_input: token,
                    fase_input: faseUrl,
                    cuestionario_input: nombreCuestionario,
                    datos_input: respuestas
                });

            if (saveError) {
                console.error("Error Supabase RPC:", saveError);
                mensaje = "Error al guardar las respuestas.";
            } else {
                // ÉXITO: Recargamos para mostrar la pantalla de "Gracias"
                return Astro.redirect(Astro.url.pathname + Astro.url.search);
            }

        } catch (e) {
            console.error("Error procesando:", e);
            mensaje = "Ocurrió un error inesperado.";
        }
    }
} else {
    // Modo diseño
    paciente = { id: 0, nombre: "Paciente Simulado" };
    yaContestado = false; 
    if (Astro.request.method === "POST") mensaje = "Guardado simulado exitoso.";
}

const textoFase = { 'pre': 'Pre-Tratamiento', 'inter': 'Intermedio', 'post': 'Post-Tratamiento' }[faseUrl || 'pre'];


const epworthOptions = [
    { label: 'Nunca', value: 0 },
    { label: 'Ligera', value: 1 },
    { label: 'Moderada', value: 2 },
    { label: 'Alta', value: 3 },
];
const epworthQuestions = [
    { id: 'epworth_1', text: 'Al estar sentado leyendo' },
    { id: 'epworth_2', text: 'Viendo T.V.' },
    { id: 'epworth_3', text: 'Sentado inactivo en un lugar público (por ejemplo una sala de espera, cine, etc.)' },
    { id: 'epworth_4', text: 'Como pasajero en un auto durante una hora ininterrumpida' },
    { id: 'epworth_5', text: 'Recostado y descansando por la tarde, cuando las circunstancias lo permiten' },
    { id: 'epworth_6', text: 'Sentado, hablando con alguien' },
    { id: 'epworth_7', text: 'Sentado tranquilamente, después de una comida sin haber ingerido alcohol.' },
    { id: 'epworth_8', text: 'En un auto que se encuentra detenido por algunos minutos debido al tráfico' },
];
---

<LayoutCuestionario title="Cuestionario Epworth" tipo="epworth">

    {yaContestado ? (
            <div class="max-w-xl mx-auto mt-12 relative px-4">
    
                <div class="absolute inset-0 bg-gradient-to-r from-emerald-400 to-teal-500 rounded-3xl blur-2xl opacity-20 transform scale-95 translate-y-4 pointer-events-none"></div>

                <div class="relative bg-white border border-emerald-100 rounded-3xl p-8 md:p-12 text-center shadow-2xl shadow-emerald-900/5 overflow-hidden">
                    
                    <div class="absolute top-0 right-0 -mt-8 -mr-8 w-32 h-32 bg-emerald-50 rounded-full blur-2xl pointer-events-none"></div>
                    
                    <div class="relative w-24 h-24 mx-auto mb-8">
                        <div class="absolute inset-0 bg-emerald-200 rounded-full animate-ping opacity-25"></div>
                        <div class="relative w-full h-full bg-gradient-to-br from-emerald-400 to-teal-600 rounded-full flex items-center justify-center shadow-lg shadow-emerald-500/30">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 md:h-12 md:w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                            </svg>
                        </div>
                    </div>

                    <h2 class="text-3xl font-extrabold text-gray-900 mb-4 tracking-tight">¡Cuestionario Completado!</h2>
                    
                    <div class="bg-emerald-50/50 rounded-2xl p-6 mb-8 border border-emerald-100/50">
                        <p class="text-gray-600 text-lg leading-relaxed">
                            Hemos recibido correctamente tus respuestas para la fase de <span class="font-bold text-emerald-700">{textoFase}</span>.
                        </p>
                        <p class="text-sm text-emerald-600/70 mt-2 font-medium">No es necesario realizar ninguna otra acción.</p>
                    </div>

                    <div class="inline-flex items-center gap-2 px-5 py-2.5 bg-gray-50 border border-gray-100 rounded-full text-gray-400 text-sm font-medium transition-colors hover:bg-gray-100 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        Registrado el: {new Date().toLocaleDateString()}
                    </div>
                </div>
            </div>
        ) : (
            <>
                <div class="relative overflow-hidden bg-white rounded-3xl shadow-xl shadow-blue-900/5 border border-blue-100 p-6 md:p-8 mb-10">
                
                <div class="absolute top-0 right-0 -mt-10 -mr-10 w-64 h-64 bg-blue-400/10 rounded-full blur-3xl pointer-events-none"></div>
                <div class="absolute bottom-0 left-0 -mb-10 -ml-10 w-40 h-40 bg-indigo-400/10 rounded-full blur-2xl pointer-events-none"></div>

                <div class="relative z-10 flex flex-col md:flex-row gap-6 items-start md:items-center justify-between">
                    
                    <div class="flex items-start gap-5">
                        <div class="p-4 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl shadow-lg shadow-blue-500/30 text-white shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                            </svg>
                        </div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="px-2.5 py-0.5 rounded-full bg-blue-100 text-blue-700 text-xs font-bold uppercase tracking-wider border border-blue-200">
                                    {textoFase}
                                </span>
                            </div>
                            <h1 class="text-2xl md:text-3xl font-extrabold text-gray-900 tracking-tight">Escala de Epworth</h1>
                            <p class="text-gray-500 font-medium">Paciente: <span class="text-gray-900">{paciente.nombre}</span></p>
                        </div>
                    </div>

                    <div class="flex gap-3 w-full md:w-auto overflow-x-auto pb-2 md:pb-0">
                        <div class="bg-gray-50 border border-gray-100 rounded-xl p-3 min-w-[100px] text-center">
                            <p class="text-xs text-gray-400 uppercase font-bold">Tiempo</p>
                            <p class="text-lg font-bold text-gray-800">~2 min</p>
                        </div>
                        <div class="bg-blue-50 border border-blue-100 rounded-xl p-3 min-w-[120px] text-center">
                            <p class="text-xs text-blue-400 uppercase font-bold">Objetivo</p>
                            <p class="text-lg font-bold text-blue-700">Somnolencia</p>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-100">
                    <div class="flex gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-500 shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-gray-600 text-sm leading-relaxed">
                            Esta prueba evalúa su probabilidad de <strong>quedarse dormido</strong> en situaciones cotidianas recientes. 
                            No se trata de sentirse cansado, sino de la facilidad real para adormecerse. 
                            <span class="block mt-2 text-blue-600 font-medium italic">Responda pensando en su rutina actual.</span>
                        </p>
                    </div>
                </div>
            </div>
                <form method="POST" id="cuestionario-form">

                    <div class="mb-4 text-gray-800 text-xl text-center">
                        <p class="mb-2">Estas situaciones se refieren a su estilo de vida durante los últimos siete días.</p>
                    </div>

                    <MatrixScale 
                        instruction="Use la siguiente escala para escoger el número más apropiado para cada situación:"
                        scaleLabel="PROBABILIDAD DE QUEDAR DORMIDO"
                        options={epworthOptions}
                        questions={epworthQuestions}
                    />
                    
                    <div class="pt-10">
                        <button type="button" id="btn-pre-submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-blue-900/20 hover:scale-[1.02] active:scale-95 text-lg cursor-pointer">
                            Guardar y Finalizar
                        </button>
                    </div>
                </form>

                <dialog id="modal-confirm" class="m-auto p-0 rounded-2xl max-w-md w-full shadow-2xl backdrop:bg-black/80 backdrop:backdrop-blur-sm bg-transparent">
                    <div class="bg-white p-6 w-full"> <div class="text-center">
                            <div class="w-16 h-16 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-4">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                </svg>
                            </div>
                            
                            <h3 class="text-xl font-bold text-gray-900 mb-2">¿Estás seguro de enviar?</h3>
                            <p class="text-gray-500 text-sm mb-6">
                                Una vez enviadas tus respuestas, <strong>no podrás modificarlas ni volver a contestar</strong> este cuestionario.
                                Por favor verifica que todo esté correcto.
                            </p>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <button id="btn-cancel" class="py-3 px-4 bg-gray-100 hover:bg-gray-200 text-gray-700 font-bold rounded-xl transition-colors cursor-pointer">
                                    Revisar
                                </button>
                                <button id="btn-confirm-final" class="py-3 px-4 bg-blue-600 hover:bg-blue-500 text-white font-bold rounded-xl shadow-lg shadow-blue-500/30 transition-colors cursor-pointer">
                                    Sí, Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                </dialog>
            </>
        )}


</LayoutCuestionario>

<script is:inline>
    const form = document.getElementById('cuestionario-form');
    const btnPre = document.getElementById('btn-pre-submit');
    const modal = document.getElementById('modal-confirm'); 
    const btnCancel = document.getElementById('btn-cancel');
    const btnConfirmFinal = document.getElementById('btn-confirm-final');

    // 1. ABRIR MODAL
    if (btnPre) {
        btnPre.addEventListener('click', () => {
            if (form.reportValidity()) {
                // Cálculo de puntaje si aplica...
                if (typeof calcularPuntaje === 'function') calcularPuntaje();
                
                // MÉTODO NATIVO PARA ABRIR
                modal.showModal(); 
            }
        });
    }

    // 2. CERRAR MODAL (CANCELAR)
    if (btnCancel) {
        btnCancel.addEventListener('click', () => {
            // MÉTODO NATIVO PARA CERRAR
            modal.close(); 
        });
    }

    // 3. CONFIRMAR ENVÍO
    if (btnConfirmFinal) {
        btnConfirmFinal.addEventListener('click', () => {
            btnConfirmFinal.innerHTML = '<span class="animate-pulse">Enviando...</span>';
            btnConfirmFinal.disabled = true;
            form.submit();
        });
    }
    
    // 4. (Opcional) CERRAR SI CLICKEA FUERA (BACKDROP)
    modal.addEventListener('click', (e) => {
        const dialogDimensions = modal.getBoundingClientRect();
        if (
            e.clientX < dialogDimensions.left ||
            e.clientX > dialogDimensions.right ||
            e.clientY < dialogDimensions.top ||
            e.clientY > dialogDimensions.bottom
        ) {
            modal.close();
        }
    });
</script>