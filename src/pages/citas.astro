---
    import Layout from "../layouts/Layout.astro"
    import Icon from "../components/Icon.astro"
    import { createClient } from "@supabase/supabase-js"
    import CitaCard from "../components/CitaCard.astro"

    const supabase = createClient(
        import.meta.env.PUBLIC_SUPABASE_URL,
        import.meta.env.SUPABASE_KEY
    );

    if (Astro.request.method === "POST") {
        const data = await Astro.request.formData();
        const citaId = data.get("id_cita");
        const accion = data.get("accion");

        if (citaId && accion) {
            const nuevoEstado = accion === 'completar' ? 'completada' : 'cancelada';
            await supabase.from('citas').update({ estado: nuevoEstado }).eq('id', citaId);
        }
    }

    const { data: citasRaw, error } = await supabase
        .from('citas')
        .select('id, nombre, fecha_hora, sintoma, telefono, referencia, observaciones, registrado_por_id')
        .eq('estado', 'pendiente')
        .order('fecha_hora', { ascending: true });

    if (error) console.error("Error al obtener citas:", error);

    const citasAgrupadas = (citasRaw || []).reduce((grupos, cita) => {
        const fechaObj = new Date(cita.fecha_hora);
        const fechaTitulo = fechaObj.toLocaleDateString('es-MX', { day: 'numeric', month: 'long', timeZone: 'America/Merida' });

        if (!grupos[fechaTitulo]) grupos[fechaTitulo] = [];
        grupos[fechaTitulo].push(cita);
        return grupos;
    }, {} as Record<string, any[]>);

    const gruposDeCitas = Object.entries(citasAgrupadas);
---

<Layout title="Agenda de Citas">
    <Icon />
    <main class="max-w-7xl mx-auto pt-10 pb-28 px-4">
        
        <div class="flex flex-col items-center justify-center mb-10">
            <h1 class="max-md:max-w-xs max-md:pt-10 max-lg:max-w-xl text-4xl md:text-6xl font-extrabold text-balance text-center">
                Laboratorio del <span class="bg-gradient-to-r from-blue-500 via-blue-300 to-blue-600 bg-clip-text text-transparent drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">sue√±o</span>
            </h1>
		</div>

        <div class="flex flex-wrap gap-4 justify-center mb-12">
            <a href="/lista" hidden class="px-6 py-2.5 rounded-lg border border-gray-700 text-gray-400 hover:text-white hover:border-gray-500 transition-all text-sm font-medium flex items-center gap-2">
                Ver Pacientes
            </a>
            
            <a href="/nueva-cita" class="group relative overflow-hidden rounded-lg border border-blue-500/30 bg-transparent px-6 py-2.5 text-blue-300 shadow-sm transition-all hover:text-white hover:shadow-[0_0_20px_rgba(59,130,246,0.4)] hover:border-blue-600 flex items-center justify-center gap-2">
                <span class="absolute inset-0 w-0 bg-blue-600/80 transition-all duration-[250ms] ease-out group-hover:w-full"></span>
                <span class="relative flex items-center gap-2 text-sm font-semibold tracking-wide uppercase">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Agendar Cita
                </span>
            </a>
        </div>

        <div class="space-y-12 max-w-5xl mx-auto">
            {gruposDeCitas.length > 0 ? (
                gruposDeCitas.map(([fechaTitulo, citas]) => (
                    <section class="relative fade-in">
                        {/* Encabezado de la fecha */}
                        <div class="flex items-center gap-4 mb-6 sticky top-0 bg-black/80 backdrop-blur-md py-3 z-10 border-b border-blue-900/30">
                            <div class="h-2 w-2 rounded-full bg-blue-400 shadow-[0_0_10px_rgba(59,130,246,0.8)]"></div>
                            <h3 class="text-2xl font-bold text-blue-100 capitalize">{fechaTitulo}</h3>
                        </div>

                        {/* Grid de citas */}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5 ml-0 md:ml-6">
                            {citas.map((cita) => (
                                <CitaCard cita={cita} /> 
                            ))}
                        </div>
                    </section>
                ))
            ) : (
                <div class="flex flex-col items-center justify-center py-20 opacity-50">
                    <p class="text-xl text-gray-400">No hay citas pendientes</p>
                </div>
            )}
        </div>
    </main>
</Layout>

<style>
    .fade-in {
        animation: fadeIn 0.5s ease-in-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>