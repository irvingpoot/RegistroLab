---
import Layout from "../layouts/Layout.astro"
import ReturnButton from "../components/ReturnButton.astro"
import { createClient } from "@supabase/supabase-js"

// --- 1. CONFIGURACI√ìN Y SEGURIDAD ---
const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

// Verificaci√≥n de Usuario (Clerk)
const user = await Astro.locals.currentUser();
if (!user) return Astro.redirect("/");

// Obtener nombre para mostrar
const nombreAutor = user.firstName 
    ? `${user.firstName} ${user.lastName}`.trim() 
    : user.username || "Usuario";

// --- 2. L√ìGICA BACKEND (POST) ---
let mensaje = "";
let tipoMensaje = ""; 

if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        
        const nuevoTicket = {
            tipo: formData.get("tipo"),       
            titulo: formData.get("titulo"),
            descripcion: formData.get("descripcion"),
            
            // DATOS DEL AUTOR (Nombre + ID Seguro como texto)
            autor_nombre: nombreAutor,
            autor_id: user.id, 
            
            estado: 'pendiente'
        };

        const { error } = await supabase.from('feedback_sistema').insert([nuevoTicket]);

        if (error) throw error;
        mensaje = "¬°Recibido! Gracias por tu aporte.";
        tipoMensaje = "success";
    } catch (error) {
        console.error("Error BD:", error);
        mensaje = "Error al guardar. Intenta de nuevo.";
        tipoMensaje = "error";
    }
}

// --- 3. CARGAR DATOS ---
const { data: tickets } = await supabase
    .from('feedback_sistema')
    .select('*')
    .order('created_at', { ascending: false });

// --- 4. CONFIGURACI√ìN VISUAL (ICONOS Y COLORES) ---
// Estos objetos son necesarios para que el dise√±o pinte los colores correctos
const configTipo: Record<string, {icon: string, color: string, border: string, label: string}> = {
    bug: { 
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" /></svg>`, 
        color: "text-amber-400 bg-amber-500/10 peer-checked:bg-amber-500 peer-checked:text-white",
        border: "peer-checked:border-amber-500 peer-checked:ring-amber-500/30",
        label: "Reportar Error"
    },
    mejora: { 
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904 9 18.75l-.813-2.846a4.5 4.5 0 0 0-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 0 0 3.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 0 0 3.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 0 0-3.09 3.09ZM18.259 8.715 18 9.75l-.259-1.035a3.375 3.375 0 0 0-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 0 0 2.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 0 0 2.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 0 0-2.456 2.456ZM16.894 20.567 16.5 21.75l-.394-1.183a2.25 2.25 0 0 0-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 0 0 1.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 0 0 1.423 1.423l1.183.394-1.183.394a2.25 2.25 0 0 0-1.423 1.423Z" /></svg>`, 
        color: "text-purple-400 bg-purple-500/10 peer-checked:bg-purple-600 peer-checked:text-white",
        border: "peer-checked:border-purple-500 peer-checked:ring-purple-500/30",
        label: "Sugerir Mejora"
    },
    cambio: { 
        icon: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M16.023 9.348h4.992v-.001M2.985 19.644v-4.992m0 0h4.992m-4.993 0 3.181 3.183a8.25 8.25 0 0 0 13.803-3.7M4.031 9.865a8.25 8.25 0 0 1 13.803-3.7l3.181 3.182m0-4.991v4.99" /></svg>`, 
        color: "text-blue-400 bg-blue-500/10 peer-checked:bg-blue-600 peer-checked:text-white",
        border: "peer-checked:border-blue-500 peer-checked:ring-blue-500/30",
        label: "Solicitar Cambio"
    }
};

const badgeEstado: Record<string, string> = {
    pendiente: "bg-gray-800 text-gray-400 border-gray-700",
    en_proceso: "bg-amber-900/30 text-amber-300 border-amber-500/30 animate-pulse",
    completado: "bg-emerald-900/30 text-emerald-300 border-emerald-500/30",
    rechazado: "bg-red-900/30 text-red-300 border-red-500/30"
};
---

<Layout title="Feedback | Lab-Somno">
    <ReturnButton href="/dashboard" text="Volver al dashboard" />
    <main class="max-w-5xl mx-auto pt-24 pb-20 px-4">
        
        {mensaje && (
            <div class={`mb-8 p-4 rounded-xl border flex items-center gap-3 animate-fade-in ${tipoMensaje === 'success' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-300' : 'bg-red-500/10 border-red-500/20 text-red-300'}`}>
                {tipoMensaje === 'success' ? 'üöÄ' : '‚ö†Ô∏è'}
                <p class="font-medium text-sm">{mensaje}</p>
            </div>
        )}

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            
            <div class="lg:col-span-5">
                <div class="lg:sticky lg:top-24">
                    <div class="mb-6">
                        <h2 class="text-3xl font-bold text-white mb-2">Feedback</h2>
                        <p class="text-gray-400 text-sm leading-relaxed">
                            Aqu√≠ puedes escribir todas tus sugerencias, reportes de errores o solicitudes de cambio.
                        </p>
                    </div>

                    <form method="POST" class="space-y-4">
                        
                        <div class="grid grid-cols-3 gap-3">
                            {Object.entries(configTipo).map(([key, config]) => (
                                <label class="cursor-pointer group">
                                    <input type="radio" name="tipo" value={key} class="peer sr-only" required />
                                    <div class={`flex flex-col items-center justify-center gap-2 p-4 rounded-xl border border-gray-800 bg-gray-900/50 transition-all hover:bg-gray-800 ${config.border} peer-checked:ring-1`}>
                                        <div class={`p-2 rounded-lg transition-colors ${config.color}`}>
                                            <Fragment set:html={config.icon} />
                                        </div>
                                        <span class="text-[10px] font-bold text-gray-500 uppercase tracking-wider peer-checked:text-white transition-colors">{key}</span>
                                    </div>
                                </label>
                            ))}
                        </div>

                        <div class="bg-gray-900/30 border border-white/5 rounded-2xl p-1">
                            <input type="text" name="titulo" required placeholder="T√≠tulo breve del reporte..." 
                                class="w-full bg-transparent border-b border-white/5 px-4 py-4 text-white placeholder-gray-600 focus:outline-none focus:bg-white/5 rounded-t-xl transition-colors" />
                            
                            <textarea name="descripcion" rows="4" placeholder="Describe los detalles (opcional)..." 
                                class="w-full bg-transparent px-4 py-4 text-white placeholder-gray-600 focus:outline-none focus:bg-white/5 rounded-b-xl resize-none transition-colors"></textarea>
                        </div>

                        <button type="submit" class="w-full py-4 rounded-xl bg-white hover:bg-gray-200 text-black font-bold text-sm uppercase tracking-wider transition-all shadow-lg shadow-white/5 active:scale-[0.98] flex items-center justify-center gap-2 cursor-pointer">
                            <span>Enviar Feedback</span>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12 3.269 3.125A59.769 59.769 0 0 1 21.485 12 59.768 59.768 0 0 1 3.27 20.875L5.999 12Zm0 0h7.5" /></svg>
                        </button>
                    </form>
                </div>
            </div>

            <div class="lg:col-span-7">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-white/5">
                    <h3 class="text-sm font-bold text-gray-300 uppercase tracking-widest">Historial Reciente</h3>
                    <span class="text-xs bg-gray-800 text-gray-400 px-2 py-1 rounded-md border border-gray-700">{tickets?.length || 0}</span>
                </div>

                <div class="grid gap-4">
                    {tickets && tickets.length > 0 ? (
                        tickets.map((ticket) => (
                            <div class="group relative bg-gray-900/40 border border-white/5 rounded-2xl p-5 hover:bg-gray-800/60 hover:border-white/10 transition-all duration-300">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center gap-3">
                                        <div class={`p-1.5 rounded-lg ${configTipo[ticket.tipo]?.color.replace('peer-checked:', '').replace('bg-', 'text-').replace('/10', '')} bg-gray-800`}>
                                            <div class="w-4 h-4" set:html={configTipo[ticket.tipo]?.icon} />
                                        </div>
                                        <h4 class="text-white font-bold text-base group-hover:text-purple-300 transition-colors">
                                            {ticket.titulo}
                                        </h4>
                                    </div>
                                    <span class={`text-[10px] uppercase font-bold px-2 py-1 rounded-md border ${badgeEstado[ticket.estado]}`}>
                                        {ticket.estado.replace('_', ' ')}
                                    </span>
                                </div>
                                
                                {ticket.descripcion && (
                                    <p class="text-gray-400 text-sm mb-4 pl-10 leading-relaxed opacity-80 group-hover:opacity-100 transition-opacity">
                                        {ticket.descripcion}
                                    </p>
                                )}

                                <div class="flex items-center justify-between pl-10 pt-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-xs text-gray-500">{ticket.autor_nombre}</span>
                                    </div>
                                    <span class="text-[10px] text-gray-600 font-mono">
                                        {new Date(ticket.created_at).toLocaleDateString(undefined, {month:'short', day:'numeric'})}
                                    </span>
                                </div>
                            </div>
                        ))
                    ) : (
                        <div class="py-12 text-center border border-dashed border-gray-800 rounded-2xl bg-gray-900/20">
                            <p class="text-gray-500 text-sm">No hay reportes a√∫n.</p>
                        </div>
                    )}
                </div>
            </div>

        </div>
    </main>
</Layout>