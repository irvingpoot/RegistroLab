---
import Layout from "../../layouts/Layout.astro"
import ReturnButton from "../../components/ReturnButton.astro" // Asegúrate de ajustar la ruta si es necesario
import { createClient } from "@supabase/supabase-js"

const { id } = Astro.params;

if (!id) return Astro.redirect("/citas");

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

let mensaje = "";
let error = false;

// 1. Actualizar Datos (Si es POST)
if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        
        // Convertir fecha
        const fechaObj = new Date(data.get("fecha_hora") as string);
        
        const actualizacion = {
            nombre: data.get("nombre"),
            telefono: data.get("telefono"),
            sintoma: data.get("sintoma"),
            referencia: data.get("referencia"),
            fecha_hora: fechaObj.toISOString(),
            observaciones: data.get("observaciones"),
        };

        const { error: updateError } = await supabase
            .from('citas')
            .update(actualizacion)
            .eq('id', id);

        if (updateError) throw updateError;
        
        return Astro.redirect("/citas"); // Redirigir al éxito

    } catch (e) {
        console.error(e);
        error = true;
        mensaje = "Error al actualizar la cita.";
    }
}

// 2. Obtener Datos actuales para rellenar el formulario
const { data: cita, error: fetchError } = await supabase
    .from('citas')
    .select('*')
    .eq('id', id)
    .single();

if (fetchError || !cita) return Astro.redirect("/citas");

// Formatear fecha para el input datetime-local (YYYY-MM-DDTHH:MM)
// Truco: Cortamos los segundos y milisegundos del ISO string para que el input lo acepte
const fechaValue = new Date(cita.fecha_hora).toISOString().slice(0, 16);
---

<Layout title="Editar Cita">
    <ReturnButton href="/citas" text="Cancelar edición" />

    <main class="max-w-7xl mx-auto pt-10 pb-28 px-4">
        <div class="flex flex-col items-center justify-center mb-10">
            <h1 class="max-md:max-w-xs max-md:pt-10 max-lg:max-w-xl text-4xl md:text-6xl font-extrabold text-balance text-center">Editar <span class="bg-gradient-to-r from-blue-500 via-blue-300 to-blue-600 bg-clip-text text-transparent drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">cita</span></h1>
		</div>

        <form method="POST">
            <div class="flex flex-col items-center justify-center">
                
                <div class="flex flex-col space-y-4 w-full max-w-4xl px-2 md:px-0">
                    
                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-gray-300">Nombre:</label>
                            <input type="text" name="nombre" value={cita.nombre} required class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>
                        <div class="flex grow flex-col md:w-1/3">
                            <label class="text-lg font-medium text-gray-300">Teléfono:</label>
                            <input type="tel" name="telefono" value={cita.telefono} required class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-gray-300">Fecha y Hora:</label>
                            <input type="datetime-local" name="fecha_hora" value={fechaValue} required class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white" style="color-scheme: dark;">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col md:w-1/3">
                            <label class="text-lg font-medium text-gray-300">Referencia:</label>
                            <input type="text" name="referencia" value={cita.referencia} class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-gray-300">Síntoma:</label>
                            <input type="text" name="sintoma" value={cita.sintoma} required class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>
                    </div>

                    <div class="flex flex-col mt-4">
                        <label class="text-lg font-medium text-gray-300">Observaciones:</label>
                        <textarea name="observaciones" rows="3" class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg resize-y text-white">{cita.observaciones}</textarea>
                    </div>
                </div>

                <div class="pt-10 pb-10 w-full max-w-4xl flex justify-end gap-4">
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-8 py-3 rounded-xl hover:bg-blue-500 transition duration-300 cursor-pointer">
                        Guardar Cambios
                    </button>
                </div>
                
            </div>
        </form>
    </main>
</Layout>