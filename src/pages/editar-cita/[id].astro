---

/**
 * @file [id].astro
 * @description Página para editar una cita existente.
 * * LÓGICA DE FECHAS:
 * 1. Carga (GET): Convierte la fecha UTC de la BD a formato local `YYYY-MM-DDTHH:mm`
 * para que el input `datetime-local` la reconozca y muestre correctamente.
 * 2. Guardado (POST): Recibe la fecha local del input y le anexa la zona horaria
 * correcta (-06:00 Mérida) antes de enviarla a Supabase, asegurando consistencia.
 * * FLUJO:
 * - Valida que el ID exista.
 * - Carga los datos actuales para pre-llenar el formulario.
 * - Permite modificar estatus, motivo, observaciones y horario.
 */


import Layout from "../../layouts/Layout.astro"
import ReturnButton from "../../components/ReturnButton.astro"
import { createClient } from "@supabase/supabase-js"
import { clerkClient } from "@clerk/astro/server";

const { id } = Astro.params;

if (!id) return Astro.redirect("/citas");

const supabase = createClient(
    import.meta.env.PUBLIC_SUPABASE_URL,
    import.meta.env.SUPABASE_KEY
);

let mensaje = "";
let error = false;

let listaEspecialistas = [];
try {
    const client = clerkClient(Astro);
    const response = await client.users.getUserList({ limit: 20 });
    const users = Array.isArray(response) ? response : (response.data || []);
    listaEspecialistas = users.map(u => {
        const nombre = `${u.firstName || ''} ${u.lastName || ''}`.trim();
        return nombre || u.username || "Usuario Sin Nombre";
    });
} catch (e) {
    console.error("Error users:", e);
}

// Actualizar Datos (Si es POST)
if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const fechaLocal = data.get("fecha_hora") as string;
        const fechaObj = new Date(`${fechaLocal}-06:00`);
        const fechaISO = fechaObj.toISOString();
        
        // 1. NUEVO: Capturar especialista
        const atendidoPor = data.get("atendido_por") as string;

        // 2. VALIDACIÓN:
        // Buscamos si hay OTRA cita (id != id actual) a la misma hora con el MISMO doctor.
        const { data: colision } = await supabase
            .from('citas')
            .select('id')
            .eq('fecha_hora', fechaISO)
            .eq('atendido_por', atendidoPor)
            .neq('id', id) // <--- IMPORTANTE: No chocar con uno mismo
            .neq('estado', 'cancelada')
            .maybeSingle();

        if (colision) {
            throw new Error(`⚠️ No se puede cambiar: ${atendidoPor} ya tiene otra cita agendada a esa hora.`);
        }

        const actualizacion = {
            nombre: data.get("nombre"),
            motivo: data.get("motivo"),
            telefono: data.get("telefono") || null,
            sintoma: data.get("sintoma") || null,
            referencia: data.get("referencia"),
            fecha_hora: fechaISO,
            observaciones: data.get("observaciones") || null,
            atendido_por: atendidoPor // <--- Guardamos el cambio
        };

        const { error: updateError } = await supabase
            .from('citas')
            .update(actualizacion)
            .eq('id', id);

        if (updateError) throw updateError;
        
        return Astro.redirect("/citas"); 

    } catch (e) {
        console.error(e);
        error = true;
        mensaje = "Error al actualizar la cita.";
    }
}

// Obtener Datos actuales para rellenar el formulario
const { data: cita, error: fetchError } = await supabase
    .from('citas')
    .select('*')
    .eq('id', id)
    .single();

if (fetchError || !cita) return Astro.redirect("/citas");

const fechaObjCita = new Date(cita.fecha_hora);

// Obtenemos la fecha (YYYY-MM-DD) en horario Mérida
const fechaParte = fechaObjCita.toLocaleDateString('en-CA', { 
    timeZone: 'America/Merida' 
});

// Obtenemos la hora (HH:MM) en horario Mérida (formato 24h)
const horaParte = fechaObjCita.toLocaleTimeString('en-GB', { 
    timeZone: 'America/Merida', 
    hour: '2-digit', 
    minute: '2-digit',
    hour12: false 
});

// Unimos ambas partes con una "T"
const fechaValue = `${fechaParte}T${horaParte}`;
---

<Layout title="Editar Cita">
    <ReturnButton href="/citas" text="Cancelar edición" />

    <main class="max-w-7xl mx-auto pt-10 pb-28 px-4">
        <div class="flex flex-col items-center justify-center mb-10">
            <h1 class="max-md:max-w-xs max-md:pt-10 max-lg:max-w-xl text-4xl md:text-6xl font-extrabold text-balance text-center">Editar <span class="bg-gradient-to-r from-blue-500 via-blue-300 to-blue-600 bg-clip-text text-transparent drop-shadow-[0_0_15px_rgba(59,130,246,0.5)]">cita</span></h1>
		</div>

        <form method="POST">
            <div class="flex flex-col items-center justify-center">
                
                <div class="flex flex-col space-y-4 w-full max-w-4xl px-2 md:px-0">

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-gray-300">Nombre:</label>
                            <input type="text" name="nombre" value={cita.nombre} required class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>

                        <div class="flex grow flex-col md:w-1/3">
                            <label class="text-lg font-medium text-gray-300">Teléfono (Opcional):</label>
                            <input type="tel" name="telefono" value={cita.telefono} class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col gap-2">
                            <label class="text-sm font-medium text-gray-300">
                                Referencia (Referido por)
                            </label>
                            <div class="relative">
                                <select 
                                    name="referencia" 
                                    required
                                    class="w-full bg-gray-900/50 border border-gray-600 text-white p-3 rounded-xl focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none appearance-none transition-all cursor-pointer"
                                >
                                    <option value="" disabled>Selecciona una opción</option>
                                    
                                    <option value="Servicio Medico" selected={cita.referencia === 'Servicio Medico'}>
                                        Servicio Médico
                                    </option>
                                    
                                    <option value="Particular" selected={cita.referencia === 'Particular'}>
                                        Particular
                                    </option>
                                </select>

                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pointer-events-none text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-gray-300">Motivo de consulta (Opcional):</label>
                            <input type="text" name="sintoma" value={cita.sintoma} class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white">
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7 mb-4">
                        <div class="flex grow flex-col">
                            <label for="atendido_por" class="text-lg font-medium text-gray-300">¿Quién atenderá? <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <select id="atendido_por" name="atendido_por" required class="w-full mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white appearance-none transition-all cursor-pointer">
                                    <option value="" disabled>Seleccionar especialista</option>
                                    
                                    {listaEspecialistas.map((nombreDoc) => (
                                        <option 
                                            class="bg-gray-900" 
                                            value={nombreDoc} 
                                            selected={cita.atendido_por === nombreDoc}
                                        >
                                            {nombreDoc}
                                        </option>
                                    ))}

                                    {/* Caso especial: Si la cita tiene un doctor que YA NO existe en Clerk (fue borrado), mostrarlo para no perder el dato */}
                                    {cita.atendido_por && !listaEspecialistas.includes(cita.atendido_por) && (
                                        <option class="bg-gray-900" value={cita.atendido_por} selected>
                                            {cita.atendido_por} (Usuario inactivo)
                                        </option>
                                    )}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center px-3 pt-1 pointer-events-none text-gray-400">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col md:flex-row gap-4 md:gap-7">
                        <div class="flex grow flex-col">
                            <label class="text-lg font-medium text-gray-300">Fecha y Hora:</label>
                            <input type="datetime-local" name="fecha_hora" value={fechaValue} required class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg focus:ring-2 focus:ring-blue-500 text-white" style="color-scheme: dark;">
                        </div>
                    </div>

                    <label class="text-lg font-medium text-gray-300">Cita de:</label>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border border-gray-700 bg-gray-900/50 rounded-xl mb-4">
                        <label class="flex items-center gap-3 cursor-pointer hover:text-blue-400 transition p-2 rounded">
                            <input type="radio" name="motivo" value="entrevista" checked={cita.motivo === 'entrevista'} required class="accent-blue-500 w-5 h-5">
                            <span class="font-medium">Entrevista Inicial</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer hover:text-blue-400 transition p-2 rounded">
                            <input type="radio" name="motivo" value="seguimiento" checked={cita.motivo === 'seguimiento'} required class="accent-blue-500 w-5 h-5">
                            <span class="font-medium">Seguimiento</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer hover:text-blue-400 transition p-2 rounded">
                            <input type="radio" name="motivo" value="tratamiento" checked={cita.motivo === 'tratamiento'} required class="accent-blue-500 w-5 h-5">
                            <span class="font-medium">Tratamiento</span>
                        </label>
                    </div>

                    <div class="flex flex-col mt-4">
                        <label class="text-lg font-medium text-gray-300">Observaciones:</label>
                        <textarea name="observaciones" rows="3" class="mt-1 p-3 border border-gray-700 bg-gray-900/50 rounded-lg resize-y text-white">{cita.observaciones}</textarea>
                    </div>
                </div>

                <div class="pt-10 pb-10 w-full max-w-4xl flex justify-end gap-4">
                    <button type="submit" class="bg-blue-600 text-white font-semibold px-8 py-3 rounded-xl hover:bg-blue-500 transition duration-300 cursor-pointer">
                        Guardar Cambios
                    </button>
                </div>
                
            </div>
        </form>
    </main>
</Layout>